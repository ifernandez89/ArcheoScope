<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcheoScope - Zonas Prioritarias</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        #header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        #header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        #sidebar {
            width: 350px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #667eea;
        }
        
        #map {
            flex: 1;
            background: #0f3460;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .control-group h3 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 1.1em;
        }
        
        label {
            display: block;
            margin: 10px 0 5px;
            font-size: 0.9em;
            color: #aaa;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #667eea;
            border-radius: 5px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95em;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #gold-zones {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .zone-item {
            padding: 12px;
            margin: 8px 0;
            background: #0f3460;
            border-radius: 5px;
            border-left: 4px solid #ff6b6b;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .zone-item:hover {
            background: #1a4d7a;
            transform: translateX(5px);
        }
        
        .zone-item.high {
            border-left-color: #ff8800;
        }
        
        .zone-item.medium {
            border-left-color: #ffff00;
        }
        
        .zone-item strong {
            color: #667eea;
            font-size: 1.05em;
        }
        
        .zone-item .score {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .zone-item .lidar {
            display: inline-block;
            padding: 2px 8px;
            background: #ff6b6b;
            border-radius: 3px;
            font-size: 0.85em;
            margin-left: 5px;
        }
        
        .legend {
            background: rgba(26, 26, 46, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .legend h4 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid #667eea;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #667eea;
            display: none;
            z-index: 10000;
        }
        
        #loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #0f3460;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #stats {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4ecdc4;
        }
        
        #stats h4 {
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        #stats p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .leaflet-popup-content {
            color: #1a1a2e;
        }
        
        .leaflet-popup-content button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è ArcheoScope - Zonas Prioritarias</h1>
        <p>Optimizaci√≥n Bayesiana + Priorizaci√≥n LiDAR-Complementada</p>
    </div>
    
    <div id="container">
        <div id="sidebar">
            <div class="control-group">
                <h3>üéØ Configuraci√≥n de B√∫squeda</h3>
                
                <label>Regi√≥n Predefinida:</label>
                <select id="region-select">
                    <option value="">-- Seleccionar regi√≥n --</option>
                    
                    <!-- AM√âRICA -->
                    <optgroup label="üåé AM√âRICA">
                        <option value="peten">Pet√©n, Guatemala (Maya)</option>
                        <option value="peru-cusco">Cusco, Per√∫ (Inca)</option>
                        <option value="peru-lima">Lima, Per√∫ (Caral/Lima)</option>
                        <option value="peru-nazca">Nazca, Per√∫ (L√≠neas)</option>
                        <option value="mexico">Mesoam√©rica, M√©xico</option>
                        <option value="colombia">San Agust√≠n, Colombia</option>
                        <option value="bolivia">Tiwanaku, Bolivia</option>
                        <option value="amazonia-acre">Acre, Brasil (Geoglifos)</option>
                        <option value="amazonia-occidental">Amazon√≠a Occidental, Brasil</option>
                        <option value="usa-southwest">Suroeste USA (Anasazi)</option>
                        <option value="easter-island">Isla de Pascua, Chile (Moai)</option>
                    </optgroup>
                    
                    <!-- MEDIO ORIENTE -->
                    <optgroup label="üèõÔ∏è MEDIO ORIENTE">
                        <option value="egypt">Valle del Nilo, Egipto</option>
                        <option value="egypt-giza">Giza/Saqqara, Egipto</option>
                        <option value="mesopotamia">Mesopotamia, Irak</option>
                        <option value="petra">Petra, Jordania</option>
                        <option value="turkey">Anatolia, Turqu√≠a</option>
                    </optgroup>
                    
                    <!-- ASIA -->
                    <optgroup label="üèØ ASIA">
                        <option value="angkor">Angkor, Camboya</option>
                        <option value="india">Valle del Indo, India</option>
                        <option value="china">Valle R√≠o Amarillo, China</option>
                        <option value="myanmar">Bagan, Myanmar</option>
                        <option value="japan">Nara/Kyoto, Jap√≥n</option>
                        <option value="indonesia">Borobudur, Indonesia</option>
                    </optgroup>
                    
                    <!-- EUROPA -->
                    <optgroup label="üè∞ EUROPA">
                        <option value="greece">Atenas/Peloponeso, Grecia</option>
                        <option value="rome">Roma/Lacio, Italia</option>
                        <option value="pompeii">Pompeya, Italia</option>
                        <option value="stonehenge">Stonehenge, Reino Unido</option>
                    </optgroup>
                    
                    <!-- √ÅFRICA -->
                    <optgroup label="ü¶Å √ÅFRICA">
                        <option value="nubia">Nubia/Meroe, Sud√°n</option>
                        <option value="aksum">Aksum, Etiop√≠a</option>
                        <option value="zimbabwe">Gran Zimbabwe, Zimbabwe</option>
                    </optgroup>
                    
                    <option value="custom">üåç Personalizado...</option>
                </select>
                
                <label>Latitud Min:</label>
                <input type="number" id="lat-min" step="0.1" value="16.0">
                
                <label>Latitud Max:</label>
                <input type="number" id="lat-max" step="0.1" value="18.0">
                
                <label>Longitud Min:</label>
                <input type="number" id="lon-min" step="0.1" value="-91.0">
                
                <label>Longitud Max:</label>
                <input type="number" id="lon-max" step="0.1" value="-89.0">
                
                <label>Estrategia:</label>
                <select id="strategy">
                    <option value="buffer">Buffer (Recomendado)</option>
                    <option value="gradient">Gradient</option>
                    <option value="gaps">Gaps</option>
                </select>
                
                <label>M√°ximo de Zonas:</label>
                <input type="number" id="max-zones" value="50" min="10" max="200">
                
                <label>
                    <input type="checkbox" id="lidar-priority" checked style="width: auto; margin-right: 5px;">
                    Priorizar zonas con LiDAR
                </label>
                
                <button id="load-zones" onclick="loadZones()">
                    üîç Cargar Zonas Prioritarias
                </button>
            </div>
            
            <!-- NUEVO: An√°lisis de Coordenadas Espec√≠ficas -->
            <div class="control-group" style="border-left: 4px solid #ff6b6b;">
                <h3>üìç An√°lisis de Punto Espec√≠fico</h3>
                <p style="font-size: 0.85em; color: #aaa; margin-bottom: 10px;">
                    Analiza cualquier coordenada del planeta
                </p>
                
                <label>Coordenadas (lat, lon):</label>
                <input type="text" id="custom-coords" placeholder="-31.738965, -60.564453" 
                       style="font-family: monospace;">
                
                <button onclick="analyzeCustomPoint()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                    üî¨ Analizar Punto
                </button>
                
                <div id="point-result" style="display: none; margin-top: 15px; padding: 10px; background: #1a1a2e; border-radius: 5px; border: 1px solid #ff6b6b;">
                    <h4 style="color: #ff6b6b; margin-bottom: 10px;">Resultado del An√°lisis</h4>
                    <div id="point-result-content"></div>
                </div>
            </div>
            
            <div id="stats" style="display: none;">
                <h4>üìä Estad√≠sticas</h4>
                <p id="stat-total">Total zonas: 0</p>
                <p id="stat-critical">CRITICAL: 0</p>
                <p id="stat-high">HIGH: 0</p>
                <p id="stat-gold">üî• GOLD CLASS: 0</p>
                <p id="stat-coverage">Cobertura: 0%</p>
            </div>
            
            <div class="legend">
                <h4>üé® Leyenda</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff0000;"></div>
                    <span>CRITICAL (>0.75)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff8800;"></div>
                    <span>HIGH (0.55-0.75)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffff00;"></div>
                    <span>MEDIUM (0.35-0.55)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff00;"></div>
                    <span>LOW (<0.35)</span>
                </div>
            </div>
            
            <div class="control-group" id="gold-zones-container" style="display: none;">
                <h3>üî• Candidatas CRITICAL (Field Validation)</h3>
                <div id="gold-zones"></div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
    <div id="loading">
        <div class="spinner"></div>
        <p>Cargando zonas prioritarias...</p>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const API_BASE = 'http://localhost:8002';
        let map;
        let zonesLayer;
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([16.5, -90.0], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            zonesLayer = L.layerGroup().addTo(map);
        }
        
        // Regiones predefinidas
        const regions = {
            // AM√âRICA
            peten: { lat_min: 16.0, lat_max: 18.0, lon_min: -91.0, lon_max: -89.0, zoom: 8 },
            'peru-cusco': { lat_min: -14.0, lat_max: -13.0, lon_min: -73.0, lon_max: -71.0, zoom: 9 },
            'peru-lima': { lat_min: -13.0, lat_max: -11.0, lon_min: -78.0, lon_max: -76.0, zoom: 8 },
            'peru-nazca': { lat_min: -15.5, lat_max: -14.0, lon_min: -76.0, lon_max: -74.0, zoom: 9 },
            mexico: { lat_min: 14.0, lat_max: 22.0, lon_min: -106.0, lon_max: -86.0, zoom: 6 },
            colombia: { lat_min: 1.0, lat_max: 3.0, lon_min: -77.0, lon_max: -75.0, zoom: 9 },
            bolivia: { lat_min: -18.0, lat_max: -15.0, lon_min: -70.0, lon_max: -66.0, zoom: 8 },
            'amazonia-acre': { lat_min: -11.0, lat_max: -9.0, lon_min: -70.0, lon_max: -68.0, zoom: 8 },
            'amazonia-occidental': { lat_min: -5.0, lat_max: -3.0, lon_min: -62.0, lon_max: -60.0, zoom: 8 },
            'usa-southwest': { lat_min: 35.0, lat_max: 38.0, lon_min: -112.0, lon_max: -107.0, zoom: 7 },
            'easter-island': { lat_min: -28.0, lat_max: -27.0, lon_min: -110.0, lon_max: -109.0, zoom: 11 },
            
            // MEDIO ORIENTE
            egypt: { lat_min: 25.0, lat_max: 30.0, lon_min: 30.0, lon_max: 35.0, zoom: 7 },
            'egypt-giza': { lat_min: 29.0, lat_max: 30.0, lon_min: 31.0, lon_max: 32.0, zoom: 10 },
            mesopotamia: { lat_min: 31.0, lat_max: 37.0, lon_min: 42.0, lon_max: 46.0, zoom: 7 },
            petra: { lat_min: 29.0, lat_max: 33.0, lon_min: 35.0, lon_max: 39.0, zoom: 8 },
            turkey: { lat_min: 37.0, lat_max: 42.0, lon_min: 26.0, lon_max: 45.0, zoom: 6 },
            
            // ASIA
            angkor: { lat_min: 13.0, lat_max: 14.0, lon_min: 103.0, lon_max: 104.0, zoom: 10 },
            india: { lat_min: 24.0, lat_max: 32.0, lon_min: 68.0, lon_max: 78.0, zoom: 6 },
            china: { lat_min: 34.0, lat_max: 38.0, lon_min: 108.0, lon_max: 116.0, zoom: 7 },
            myanmar: { lat_min: 21.0, lat_max: 22.0, lon_min: 94.0, lon_max: 95.0, zoom: 10 },
            japan: { lat_min: 34.0, lat_max: 36.0, lon_min: 135.0, lon_max: 136.0, zoom: 8 },
            indonesia: { lat_min: -8.0, lat_max: -7.0, lon_min: 110.0, lon_max: 111.0, zoom: 10 },
            
            // EUROPA
            greece: { lat_min: 37.0, lat_max: 39.0, lon_min: 21.0, lon_max: 24.0, zoom: 8 },
            rome: { lat_min: 41.0, lat_max: 42.0, lon_min: 12.0, lon_max: 13.0, zoom: 10 },
            pompeii: { lat_min: 40.0, lat_max: 41.0, lon_min: 14.0, lon_max: 15.0, zoom: 10 },
            stonehenge: { lat_min: 51.0, lat_max: 52.0, lon_min: -2.0, lon_max: -1.0, zoom: 10 },
            
            // √ÅFRICA
            nubia: { lat_min: 16.0, lat_max: 18.0, lon_min: 33.0, lon_max: 34.0, zoom: 9 },
            aksum: { lat_min: 14.0, lat_max: 15.0, lon_min: 38.0, lon_max: 39.0, zoom: 10 },
            zimbabwe: { lat_min: -21.0, lat_max: -20.0, lon_min: 30.0, lon_max: 31.0, zoom: 11 }
        };
        
        document.getElementById('region-select').addEventListener('change', function() {
            const region = regions[this.value];
            if (region) {
                document.getElementById('lat-min').value = region.lat_min;
                document.getElementById('lat-max').value = region.lat_max;
                document.getElementById('lon-min').value = region.lon_min;
                document.getElementById('lon-max').value = region.lon_max;
                
                map.setView([(region.lat_min + region.lat_max) / 2, (region.lon_min + region.lon_max) / 2], region.zoom);
            }
        });
        
        // Cargar zonas
        async function loadZones() {
            const latMin = parseFloat(document.getElementById('lat-min').value);
            const latMax = parseFloat(document.getElementById('lat-max').value);
            const lonMin = parseFloat(document.getElementById('lon-min').value);
            const lonMax = parseFloat(document.getElementById('lon-max').value);
            const strategy = document.getElementById('strategy').value;
            const maxZones = parseInt(document.getElementById('max-zones').value);
            const lidarPriority = document.getElementById('lidar-priority').checked;
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('load-zones').disabled = true;
            
            try {
                // USAR ENDPOINT ENRIQUECIDO CON MULTI-INSTRUMENTAL
                const url = `${API_BASE}/archaeological-sites/enriched-candidates?` +
                    `lat_min=${latMin}&lat_max=${latMax}&lon_min=${lonMin}&lon_max=${lonMax}&` +
                    `strategy=${strategy}&max_zones=${maxZones}&lidar_priority=${lidarPriority}&` +
                    `min_convergence=0.4&save_to_database=false`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Candidatas recibidas:', data.total_candidates);
                
                // Convertir candidatas enriquecidas a GeoJSON
                const geojson = {
                    type: 'FeatureCollection',
                    features: data.candidates.map(c => {
                        // Calcular bounds aproximados (0.05 grados ~ 5km)
                        const halfSize = 0.05;
                        const centerLat = c.location.lat;
                        const centerLon = c.location.lon;
                        
                        return {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [[
                                    [centerLon - halfSize, centerLat - halfSize],
                                    [centerLon + halfSize, centerLat - halfSize],
                                    [centerLon + halfSize, centerLat + halfSize],
                                    [centerLon - halfSize, centerLat + halfSize],
                                    [centerLon - halfSize, centerLat - halfSize]
                                ]]
                            },
                            properties: {
                                candidate_id: c.candidate_id,
                                zone_id: c.zone_id,
                                multi_instrumental_score: c.multi_instrumental_score,
                                recommended_action: c.recommended_action,
                                convergence_count: c.convergence.count,
                                convergence_ratio: c.convergence.ratio,
                                temporal_persistence: c.temporal_persistence.detected,
                                temporal_years: c.temporal_persistence.years,
                                center_lat: centerLat,
                                center_lon: centerLon,
                                area_km2: c.location.area_km2,
                                // Mapear acci√≥n a prioridad visual
                                priority_class: c.recommended_action === 'field_validation' ? 'CRITICAL' :
                                              c.recommended_action === 'detailed_analysis' ? 'HIGH' :
                                              c.recommended_action === 'monitor' ? 'MEDIUM' : 'LOW',
                                signals: c.signals
                            }
                        };
                    })
                };
                
                // Limpiar capa anterior
                zonesLayer.clearLayers();
                
                // Agregar zonas al mapa
                L.geoJSON(geojson, {
                    style: (feature) => {
                        const colors = {
                            'CRITICAL': '#ff0000',
                            'HIGH': '#ff8800',
                            'MEDIUM': '#ffff00',
                            'LOW': '#00ff00'
                        };
                        return {
                            fillColor: colors[feature.properties.priority_class] || '#888',
                            fillOpacity: 0.5,
                            color: '#fff',
                            weight: 2
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        
                        // Contar instrumentos que detectan
                        const signals = props.signals || {};
                        const detectedInstruments = Object.entries(signals)
                            .filter(([key, val]) => val && val.detected)
                            .map(([key]) => key.toUpperCase())
                            .join(', ');
                        
                        const convergenceBadge = props.convergence_ratio >= 0.8 ? 'üî•' : 
                                                props.convergence_ratio >= 0.6 ? '‚ö°' : 'üìä';
                        
                        const persistenceBadge = props.temporal_persistence ? 
                            `<br><strong>‚è±Ô∏è Persistencia:</strong> ${props.temporal_years} a√±os` : '';
                        
                        layer.bindPopup(`
                            <h3>${props.candidate_id}</h3>
                            <p><strong>Score Multi-Instrumental:</strong> ${props.multi_instrumental_score.toFixed(3)}</p>
                            <p><strong>Acci√≥n:</strong> ${props.recommended_action}</p>
                            <p><strong>Prioridad Visual:</strong> ${props.priority_class}</p>
                            <p><strong>${convergenceBadge} Convergencia:</strong> ${props.convergence_count}/${Math.round(props.convergence_count/props.convergence_ratio)} instrumentos (${(props.convergence_ratio*100).toFixed(0)}%)</p>
                            ${persistenceBadge}
                            <p><strong>üõ∞Ô∏è Instrumentos:</strong> ${detectedInstruments || 'N/A'}</p>
                            <p><strong>√Årea:</strong> ${props.area_km2.toFixed(2)} km¬≤</p>
                            <button onclick="analyzeZone('${props.zone_id}', ${props.center_lat}, ${props.center_lon})">
                                üî¨ Analizar Zona
                            </button>
                        `);
                    }
                }).addTo(zonesLayer);
                
                // Ajustar vista del mapa
                map.fitBounds([[latMin, lonMin], [latMax, lonMax]]);
                
                // Actualizar estad√≠sticas
                updateStats(geojson);
                
                // Mostrar zonas GOLD
                showGoldZones(geojson);
                
            } catch (error) {
                alert('Error cargando zonas: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('load-zones').disabled = false;
            }
        }
        
        function updateStats(geojson) {
            const zones = geojson.features;
            const critical = zones.filter(z => z.properties.priority_class === 'CRITICAL').length;
            const high = zones.filter(z => z.properties.priority_class === 'HIGH').length;
            
            // Calcular convergencia promedio
            const avgConvergence = zones.reduce((sum, z) => sum + (z.properties.convergence_ratio || 0), 0) / zones.length;
            
            // Contar zonas con persistencia temporal
            const withPersistence = zones.filter(z => z.properties.temporal_persistence).length;
            
            document.getElementById('stat-total').textContent = `Total candidatas: ${zones.length}`;
            document.getElementById('stat-critical').textContent = `CRITICAL (field_validation): ${critical}`;
            document.getElementById('stat-high').textContent = `HIGH (detailed_analysis): ${high}`;
            document.getElementById('stat-gold').textContent = `‚ö° Convergencia promedio: ${(avgConvergence*100).toFixed(0)}%`;
            document.getElementById('stat-coverage').textContent = `‚è±Ô∏è Con persistencia temporal: ${withPersistence}`;
            
            document.getElementById('stats').style.display = 'block';
        }
        
        function showGoldZones(geojson) {
            // Mostrar candidatas CRITICAL (field_validation)
            const criticalZones = geojson.features.filter(z => z.properties.priority_class === 'CRITICAL');
            
            if (criticalZones.length === 0) {
                document.getElementById('gold-zones-container').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('gold-zones');
            container.innerHTML = '';
            
            criticalZones.forEach(zone => {
                const props = zone.properties;
                const div = document.createElement('div');
                div.className = 'zone-item';
                div.innerHTML = `
                    <strong>${props.candidate_id}</strong>
                    <span class="lidar">üî• CRITICAL</span>
                    <br>
                    <span class="score">Score: ${props.multi_instrumental_score.toFixed(3)}</span>
                    <br>
                    <small>Convergencia: ${props.convergence_count} instrumentos</small>
                    <br>
                    <small>${props.center_lat.toFixed(4)}, ${props.center_lon.toFixed(4)}</small>
                `;
                div.onclick = () => {
                    map.setView([props.center_lat, props.center_lon], 12);
                };
                container.appendChild(div);
            });
            
            document.getElementById('gold-zones-container').style.display = 'block';
        }
        
        function analyzeZone(zoneId, lat, lon) {
            alert(`An√°lisis de zona ${zoneId} en desarrollo.\nCoordenadas: ${lat}, ${lon}`);
            // TODO: Integrar con endpoint /analyze
        }
        
        // NUEVO: Analizar punto espec√≠fico
        async function analyzeCustomPoint() {
            const coordsInput = document.getElementById('custom-coords').value.trim();
            
            if (!coordsInput) {
                alert('Por favor ingresa coordenadas (ej: -31.738965, -60.564453)');
                return;
            }
            
            // Parsear coordenadas
            const parts = coordsInput.split(',').map(s => s.trim());
            if (parts.length !== 2) {
                alert('Formato incorrecto. Usa: latitud, longitud (ej: -31.738965, -60.564453)');
                return;
            }
            
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Coordenadas inv√°lidas. Deben ser n√∫meros.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Coordenadas fuera de rango. Lat: -90 a 90, Lon: -180 a 180');
                return;
            }
            
            // Mostrar loading
            const resultDiv = document.getElementById('point-result');
            const contentDiv = document.getElementById('point-result-content');
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Analizando punto...</p>';
            
            try {
                // Llamar al endpoint de an√°lisis
                const url = `${API_BASE}/analyze`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lat: lat,
                        lon: lon,
                        region_name: `Punto personalizado (${lat.toFixed(4)}, ${lon.toFixed(4)})`,
                        resolution_m: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Mostrar resultado
                displayPointAnalysis(data, lat, lon);
                
                // Agregar marcador en el mapa
                addPointMarker(lat, lon, data);
                
                // Centrar mapa en el punto
                map.setView([lat, lon], 12);
                
            } catch (error) {
                contentDiv.innerHTML = `
                    <p style="color: #ff6b6b;">‚ùå Error en el an√°lisis:</p>
                    <p style="font-size: 0.9em;">${error.message}</p>
                `;
                console.error('Error:', error);
            }
        }
        
        function displayPointAnalysis(data, lat, lon) {
            const contentDiv = document.getElementById('point-result-content');
            
            // Determinar clasificaci√≥n
            const result = data.archaeological_results?.result_type || 'unknown';
            const confidence = data.archaeological_results?.confidence || 0;
            const archaeoProb = data.archaeological_results?.archaeological_probability || 0;
            
            // Iconos y colores seg√∫n resultado
            const resultConfig = {
                'archaeological': { icon: 'üî¥', color: '#ff0000', text: 'ANOMAL√çA ARQUEOL√ìGICA' },
                'anomalous': { icon: 'üü†', color: '#ff8800', text: 'ANOMAL√çA DETECTADA' },
                'consistent': { icon: 'üü¢', color: '#00ff00', text: 'CONSISTENTE CON NATURAL' }
            };
            
            const config = resultConfig[result] || { icon: '‚ö™', color: '#888', text: 'DESCONOCIDO' };
            
            // Informaci√≥n de zona
            const zone = data.zone_classification || {};
            const terrain = zone.terrain_type || 'unknown';
            const environment = zone.environment_type || 'unknown';
            
            // Sitios cercanos
            const nearestSite = data.nearest_known_site || {};
            const distanceKm = nearestSite.distance_km || 'N/A';
            
            // Sensor temporal
            const temporal = data.temporal_analysis || {};
            const temporalUsed = temporal.sensor_used || 'N/A';
            const temporalYears = temporal.years_analyzed || 'N/A';
            
            // Anomal√≠as detectadas
            const anomalies = data.archaeological_results?.anomalies || [];
            
            contentDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 3em;">${config.icon}</div>
                    <div style="font-size: 1.2em; font-weight: bold; color: ${config.color};">
                        ${config.text}
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <strong>üìç Coordenadas:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                </div>
                
                <div style="margin-bottom: 10px;">
                    <strong>üó∫Ô∏è Clasificaci√≥n de Zona:</strong><br>
                    <small>Terreno: ${terrain}</small><br>
                    <small>Ambiente: ${environment}</small>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <strong>üìä Probabilidades:</strong><br>
                    <small>Confianza: ${(confidence * 100).toFixed(1)}%</small><br>
                    <small>Prob. Arqueol√≥gica: ${(archaeoProb * 100).toFixed(1)}%</small>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <strong>üèõÔ∏è Sitio Conocido M√°s Cercano:</strong><br>
                    <small>${nearestSite.name || 'N/A'}</small><br>
                    <small>Distancia: ${typeof distanceKm === 'number' ? distanceKm.toFixed(2) + ' km' : distanceKm}</small>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <strong>‚è±Ô∏è An√°lisis Temporal:</strong><br>
                    <small>Sensor: ${temporalUsed}</small><br>
                    <small>A√±os analizados: ${temporalYears}</small>
                </div>
                
                ${anomalies.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: #0f3460; border-radius: 5px;">
                        <strong>üîç Anomal√≠as Detectadas:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9em;">
                            ${anomalies.map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                ${data.ai_explanations?.ai_available ? `
                    <div style="margin-top: 15px; padding: 10px; background: #16213e; border-radius: 5px; border-left: 3px solid #667eea;">
                        <strong>ü§ñ Explicaci√≥n IA:</strong>
                        <p style="font-size: 0.9em; margin: 5px 0;">${data.ai_explanations.explanation}</p>
                    </div>
                ` : ''}
            `;
        }
        
        let pointMarker = null;
        
        function addPointMarker(lat, lon, data) {
            // Remover marcador anterior si existe
            if (pointMarker) {
                map.removeLayer(pointMarker);
            }
            
            const result = data.archaeological_results?.result_type || 'unknown';
            const colors = {
                'archaeological': '#ff0000',
                'anomalous': '#ff8800',
                'consistent': '#00ff00'
            };
            
            const color = colors[result] || '#888';
            
            // Crear marcador
            pointMarker = L.circleMarker([lat, lon], {
                radius: 10,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // Popup con informaci√≥n
            const confidence = data.archaeological_results?.confidence || 0;
            const archaeoProb = data.archaeological_results?.archaeological_probability || 0;
            
            pointMarker.bindPopup(`
                <h3>üìç An√°lisis de Punto</h3>
                <p><strong>Resultado:</strong> ${result}</p>
                <p><strong>Confianza:</strong> ${(confidence * 100).toFixed(1)}%</p>
                <p><strong>Prob. Arqueol√≥gica:</strong> ${(archaeoProb * 100).toFixed(1)}%</p>
                <p><strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>
            `).openPopup();
        }
        
        // Inicializar al cargar
        window.onload = () => {
            initMap();
            loadRealCandidates();
        };
        
        // CARGAR CANDIDATAS REALES
        let realCandidatesLayer = null;
        
        async function loadRealCandidates() {
            try {
                console.log('Cargando candidatas REALES...');
                
                const response = await fetch('real_candidates.geojson');
                const geojson = await response.json();
                
                console.log(`Candidatas REALES cargadas: ${geojson.features.length}`);
                
                // Remover capa anterior si existe
                if (realCandidatesLayer) {
                    map.removeLayer(realCandidatesLayer);
                }
                
                // Crear capa de candidatas REALES
                realCandidatesLayer = L.geoJSON(geojson, {
                    pointToLayer: function(feature, latlng) {
                        const props = feature.properties;
                        
                        return L.circleMarker(latlng, {
                            radius: 12,
                            fillColor: props.color,
                            color: '#fff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.9
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        
                        // Popup con informaci√≥n REAL
                        const popupContent = `
                            <div style="min-width: 250px;">
                                <h3 style="margin: 0 0 10px 0; color: ${props.color};">
                                    üõ∞Ô∏è CANDIDATA REAL
                                </h3>
                                <p style="margin: 5px 0;"><strong>ID:</strong> ${props.candidate_id}</p>
                                <p style="margin: 5px 0;"><strong>Zona:</strong> ${props.zone_id.replace(/_/g, ' ')}</p>
                                <p style="margin: 5px 0;"><strong>Score:</strong> ${props.score}</p>
                                <p style="margin: 5px 0;"><strong>Prioridad:</strong> <span style="color: ${props.color};">${props.priority}</span></p>
                                <p style="margin: 5px 0;"><strong>Convergencia:</strong> ${props.convergence_count}/3 (${(props.convergence_ratio * 100).toFixed(0)}%)</p>
                                <p style="margin: 5px 0;"><strong>Acci√≥n:</strong> ${props.recommended_action}</p>
                                <hr style="margin: 10px 0;">
                                <p style="margin: 5px 0; font-size: 0.9em; color: #00ff00;">
                                    ‚úÖ DATOS REALES: NASA POWER + Open-Elevation
                                </p>
                                <p style="margin: 5px 0; font-size: 0.85em; color: #888;">
                                    Generado: ${props.generation_date || 'N/A'}
                                </p>
                            </div>
                        `;
                        
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);
                
                // Actualizar estad√≠sticas en sidebar
                updateRealCandidatesStats(geojson);
                
                console.log('‚úÖ Candidatas REALES visualizadas en el mapa');
                
            } catch (error) {
                console.error('Error cargando candidatas REALES:', error);
            }
        }
        
        function updateRealCandidatesStats(geojson) {
            const stats = geojson.metadata;
            const features = geojson.features;
            
            // Contar por prioridad
            const priorities = {
                'CRITICAL': 0,
                'HIGH': 0,
                'MEDIUM': 0,
                'LOW': 0
            };
            
            features.forEach(f => {
                const priority = f.properties.priority;
                if (priorities.hasOwnProperty(priority)) {
                    priorities[priority]++;
                }
            });
            
            // Actualizar UI
            const statsHTML = `
                <div class="control-group" style="background: #0a2540; border-left-color: #00ff00;">
                    <h3 style="color: #00ff00;">üõ∞Ô∏è CANDIDATAS REALES</h3>
                    <p style="margin: 10px 0; font-size: 0.95em;">
                        <strong>Total:</strong> ${stats.total_candidates}<br>
                        <strong>Fuentes:</strong> ${stats.sources.join(', ')}<br>
                        <strong>Fecha:</strong> ${stats.generation_date}
                    </p>
                    <hr style="border-color: #00ff00; margin: 10px 0;">
                    <p style="margin: 5px 0;">
                        üî¥ CRITICAL: ${priorities.CRITICAL}<br>
                        üü† HIGH: ${priorities.HIGH}<br>
                        üü° MEDIUM: ${priorities.MEDIUM}<br>
                        üü¢ LOW: ${priorities.LOW}
                    </p>
                    <button onclick="map.fitBounds(realCandidatesLayer.getBounds())" style="margin-top: 10px;">
                        Ver Todas las Candidatas
                    </button>
                </div>
            `;
            
            // Insertar al inicio del sidebar
            const sidebar = document.getElementById('sidebar');
            sidebar.insertAdjacentHTML('afterbegin', statsHTML);
        }
    </script>
</body>
</html>
