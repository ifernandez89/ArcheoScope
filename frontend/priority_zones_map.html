<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcheoScope - Zonas Prioritarias</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        #header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        #header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        #sidebar {
            width: 350px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #667eea;
        }
        
        #map {
            flex: 1;
            background: #0f3460;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .control-group h3 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 1.1em;
        }
        
        label {
            display: block;
            margin: 10px 0 5px;
            font-size: 0.9em;
            color: #aaa;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #667eea;
            border-radius: 5px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95em;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #gold-zones {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .zone-item {
            padding: 12px;
            margin: 8px 0;
            background: #0f3460;
            border-radius: 5px;
            border-left: 4px solid #ff6b6b;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .zone-item:hover {
            background: #1a4d7a;
            transform: translateX(5px);
        }
        
        .zone-item.high {
            border-left-color: #ff8800;
        }
        
        .zone-item.medium {
            border-left-color: #ffff00;
        }
        
        .zone-item strong {
            color: #667eea;
            font-size: 1.05em;
        }
        
        .zone-item .score {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .zone-item .lidar {
            display: inline-block;
            padding: 2px 8px;
            background: #ff6b6b;
            border-radius: 3px;
            font-size: 0.85em;
            margin-left: 5px;
        }
        
        .legend {
            background: rgba(26, 26, 46, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .legend h4 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid #667eea;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #667eea;
            display: none;
            z-index: 10000;
        }
        
        #loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #0f3460;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #stats {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4ecdc4;
        }
        
        #stats h4 {
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        #stats p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .leaflet-popup-content {
            color: #1a1a2e;
        }
        
        .leaflet-popup-content button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è ArcheoScope - Zonas Prioritarias</h1>
        <p>Optimizaci√≥n Bayesiana + Priorizaci√≥n LiDAR-Complementada</p>
    </div>
    
    <div id="container">
        <div id="sidebar">
            <div class="control-group">
                <h3>üéØ Configuraci√≥n de B√∫squeda</h3>
                
                <label>Regi√≥n Predefinida:</label>
                <select id="region-select">
                    <option value="">-- Seleccionar regi√≥n --</option>
                    <option value="peten">Pet√©n, Guatemala (Maya)</option>
                    <option value="amazonia">Amazonia, Brasil</option>
                    <option value="angkor">Angkor, Camboya</option>
                    <option value="egypt">Valle del Nilo, Egipto</option>
                    <option value="peru">Andes, Per√∫</option>
                    <option value="custom">Personalizado...</option>
                </select>
                
                <label>Latitud Min:</label>
                <input type="number" id="lat-min" step="0.1" value="16.0">
                
                <label>Latitud Max:</label>
                <input type="number" id="lat-max" step="0.1" value="18.0">
                
                <label>Longitud Min:</label>
                <input type="number" id="lon-min" step="0.1" value="-91.0">
                
                <label>Longitud Max:</label>
                <input type="number" id="lon-max" step="0.1" value="-89.0">
                
                <label>Estrategia:</label>
                <select id="strategy">
                    <option value="buffer">Buffer (Recomendado)</option>
                    <option value="gradient">Gradient</option>
                    <option value="gaps">Gaps</option>
                </select>
                
                <label>M√°ximo de Zonas:</label>
                <input type="number" id="max-zones" value="50" min="10" max="200">
                
                <label>
                    <input type="checkbox" id="lidar-priority" checked style="width: auto; margin-right: 5px;">
                    Priorizar zonas con LiDAR
                </label>
                
                <button id="load-zones" onclick="loadZones()">
                    üîç Cargar Zonas Prioritarias
                </button>
            </div>
            
            <div id="stats" style="display: none;">
                <h4>üìä Estad√≠sticas</h4>
                <p id="stat-total">Total zonas: 0</p>
                <p id="stat-critical">CRITICAL: 0</p>
                <p id="stat-high">HIGH: 0</p>
                <p id="stat-gold">üî• GOLD CLASS: 0</p>
                <p id="stat-coverage">Cobertura: 0%</p>
            </div>
            
            <div class="legend">
                <h4>üé® Leyenda</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff0000;"></div>
                    <span>CRITICAL (>0.75)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff8800;"></div>
                    <span>HIGH (0.55-0.75)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffff00;"></div>
                    <span>MEDIUM (0.35-0.55)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff00;"></div>
                    <span>LOW (<0.35)</span>
                </div>
            </div>
            
            <div class="control-group" id="gold-zones-container" style="display: none;">
                <h3>üî• Candidatas CRITICAL (Field Validation)</h3>
                <div id="gold-zones"></div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
    <div id="loading">
        <div class="spinner"></div>
        <p>Cargando zonas prioritarias...</p>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const API_BASE = 'http://localhost:8002';
        let map;
        let zonesLayer;
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([16.5, -90.0], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            zonesLayer = L.layerGroup().addTo(map);
        }
        
        // Regiones predefinidas
        const regions = {
            peten: { lat_min: 16.0, lat_max: 18.0, lon_min: -91.0, lon_max: -89.0, zoom: 8 },
            amazonia: { lat_min: -5.0, lat_max: -3.0, lon_min: -62.0, lon_max: -60.0, zoom: 8 },
            angkor: { lat_min: 13.0, lat_max: 14.0, lon_min: 103.0, lon_max: 104.0, zoom: 9 },
            egypt: { lat_min: 25.0, lat_max: 30.0, lon_min: 30.0, lon_max: 35.0, zoom: 7 },
            peru: { lat_min: -15.0, lat_max: -10.0, lon_min: -77.0, lon_max: -72.0, zoom: 7 }
        };
        
        document.getElementById('region-select').addEventListener('change', function() {
            const region = regions[this.value];
            if (region) {
                document.getElementById('lat-min').value = region.lat_min;
                document.getElementById('lat-max').value = region.lat_max;
                document.getElementById('lon-min').value = region.lon_min;
                document.getElementById('lon-max').value = region.lon_max;
                
                map.setView([(region.lat_min + region.lat_max) / 2, (region.lon_min + region.lon_max) / 2], region.zoom);
            }
        });
        
        // Cargar zonas
        async function loadZones() {
            const latMin = parseFloat(document.getElementById('lat-min').value);
            const latMax = parseFloat(document.getElementById('lat-max').value);
            const lonMin = parseFloat(document.getElementById('lon-min').value);
            const lonMax = parseFloat(document.getElementById('lon-max').value);
            const strategy = document.getElementById('strategy').value;
            const maxZones = parseInt(document.getElementById('max-zones').value);
            const lidarPriority = document.getElementById('lidar-priority').checked;
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('load-zones').disabled = true;
            
            try {
                // USAR ENDPOINT ENRIQUECIDO CON MULTI-INSTRUMENTAL
                const url = `${API_BASE}/archaeological-sites/enriched-candidates?` +
                    `lat_min=${latMin}&lat_max=${latMax}&lon_min=${lonMin}&lon_max=${lonMax}&` +
                    `strategy=${strategy}&max_zones=${maxZones}&lidar_priority=${lidarPriority}&` +
                    `min_convergence=0.4&save_to_database=false`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Candidatas recibidas:', data.total_candidates);
                
                // Convertir candidatas enriquecidas a GeoJSON
                const geojson = {
                    type: 'FeatureCollection',
                    features: data.candidates.map(c => {
                        // Calcular bounds aproximados (0.05 grados ~ 5km)
                        const halfSize = 0.05;
                        const centerLat = c.location.lat;
                        const centerLon = c.location.lon;
                        
                        return {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [[
                                    [centerLon - halfSize, centerLat - halfSize],
                                    [centerLon + halfSize, centerLat - halfSize],
                                    [centerLon + halfSize, centerLat + halfSize],
                                    [centerLon - halfSize, centerLat + halfSize],
                                    [centerLon - halfSize, centerLat - halfSize]
                                ]]
                            },
                            properties: {
                                candidate_id: c.candidate_id,
                                zone_id: c.zone_id,
                                multi_instrumental_score: c.multi_instrumental_score,
                                recommended_action: c.recommended_action,
                                convergence_count: c.convergence.count,
                                convergence_ratio: c.convergence.ratio,
                                temporal_persistence: c.temporal_persistence.detected,
                                temporal_years: c.temporal_persistence.years,
                                center_lat: centerLat,
                                center_lon: centerLon,
                                area_km2: c.location.area_km2,
                                // Mapear acci√≥n a prioridad visual
                                priority_class: c.recommended_action === 'field_validation' ? 'CRITICAL' :
                                              c.recommended_action === 'detailed_analysis' ? 'HIGH' :
                                              c.recommended_action === 'monitor' ? 'MEDIUM' : 'LOW',
                                signals: c.signals
                            }
                        };
                    })
                };
                
                // Limpiar capa anterior
                zonesLayer.clearLayers();
                
                // Agregar zonas al mapa
                L.geoJSON(geojson, {
                    style: (feature) => {
                        const colors = {
                            'CRITICAL': '#ff0000',
                            'HIGH': '#ff8800',
                            'MEDIUM': '#ffff00',
                            'LOW': '#00ff00'
                        };
                        return {
                            fillColor: colors[feature.properties.priority_class] || '#888',
                            fillOpacity: 0.5,
                            color: '#fff',
                            weight: 2
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        
                        // Contar instrumentos que detectan
                        const signals = props.signals || {};
                        const detectedInstruments = Object.entries(signals)
                            .filter(([key, val]) => val && val.detected)
                            .map(([key]) => key.toUpperCase())
                            .join(', ');
                        
                        const convergenceBadge = props.convergence_ratio >= 0.8 ? 'üî•' : 
                                                props.convergence_ratio >= 0.6 ? '‚ö°' : 'üìä';
                        
                        const persistenceBadge = props.temporal_persistence ? 
                            `<br><strong>‚è±Ô∏è Persistencia:</strong> ${props.temporal_years} a√±os` : '';
                        
                        layer.bindPopup(`
                            <h3>${props.candidate_id}</h3>
                            <p><strong>Score Multi-Instrumental:</strong> ${props.multi_instrumental_score.toFixed(3)}</p>
                            <p><strong>Acci√≥n:</strong> ${props.recommended_action}</p>
                            <p><strong>Prioridad Visual:</strong> ${props.priority_class}</p>
                            <p><strong>${convergenceBadge} Convergencia:</strong> ${props.convergence_count}/${Math.round(props.convergence_count/props.convergence_ratio)} instrumentos (${(props.convergence_ratio*100).toFixed(0)}%)</p>
                            ${persistenceBadge}
                            <p><strong>üõ∞Ô∏è Instrumentos:</strong> ${detectedInstruments || 'N/A'}</p>
                            <p><strong>√Årea:</strong> ${props.area_km2.toFixed(2)} km¬≤</p>
                            <button onclick="analyzeZone('${props.zone_id}', ${props.center_lat}, ${props.center_lon})">
                                üî¨ Analizar Zona
                            </button>
                        `);
                    }
                }).addTo(zonesLayer);
                
                // Ajustar vista del mapa
                map.fitBounds([[latMin, lonMin], [latMax, lonMax]]);
                
                // Actualizar estad√≠sticas
                updateStats(geojson);
                
                // Mostrar zonas GOLD
                showGoldZones(geojson);
                
            } catch (error) {
                alert('Error cargando zonas: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('load-zones').disabled = false;
            }
        }
        
        function updateStats(geojson) {
            const zones = geojson.features;
            const critical = zones.filter(z => z.properties.priority_class === 'CRITICAL').length;
            const high = zones.filter(z => z.properties.priority_class === 'HIGH').length;
            
            // Calcular convergencia promedio
            const avgConvergence = zones.reduce((sum, z) => sum + (z.properties.convergence_ratio || 0), 0) / zones.length;
            
            // Contar zonas con persistencia temporal
            const withPersistence = zones.filter(z => z.properties.temporal_persistence).length;
            
            document.getElementById('stat-total').textContent = `Total candidatas: ${zones.length}`;
            document.getElementById('stat-critical').textContent = `CRITICAL (field_validation): ${critical}`;
            document.getElementById('stat-high').textContent = `HIGH (detailed_analysis): ${high}`;
            document.getElementById('stat-gold').textContent = `‚ö° Convergencia promedio: ${(avgConvergence*100).toFixed(0)}%`;
            document.getElementById('stat-coverage').textContent = `‚è±Ô∏è Con persistencia temporal: ${withPersistence}`;
            
            document.getElementById('stats').style.display = 'block';
        }
        
        function showGoldZones(geojson) {
            // Mostrar candidatas CRITICAL (field_validation)
            const criticalZones = geojson.features.filter(z => z.properties.priority_class === 'CRITICAL');
            
            if (criticalZones.length === 0) {
                document.getElementById('gold-zones-container').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('gold-zones');
            container.innerHTML = '';
            
            criticalZones.forEach(zone => {
                const props = zone.properties;
                const div = document.createElement('div');
                div.className = 'zone-item';
                div.innerHTML = `
                    <strong>${props.candidate_id}</strong>
                    <span class="lidar">üî• CRITICAL</span>
                    <br>
                    <span class="score">Score: ${props.multi_instrumental_score.toFixed(3)}</span>
                    <br>
                    <small>Convergencia: ${props.convergence_count} instrumentos</small>
                    <br>
                    <small>${props.center_lat.toFixed(4)}, ${props.center_lon.toFixed(4)}</small>
                `;
                div.onclick = () => {
                    map.setView([props.center_lat, props.center_lon], 12);
                };
                container.appendChild(div);
            });
            
            document.getElementById('gold-zones-container').style.display = 'block';
        }
        
        function analyzeZone(zoneId, lat, lon) {
            alert(`An√°lisis de zona ${zoneId} en desarrollo.\nCoordenadas: ${lat}, ${lon}`);
            // TODO: Integrar con endpoint /analyze
        }
        
        // Inicializar al cargar
        window.onload = () => {
            initMap();
        };
    </script>
</body>
</html>
