<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMT - Territorial Inferential Multi-domain Tomography</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0b0f14 0%, #1a1f2e 100%);
            color: #eaeef3;
            min-height: 100vh;
        }

        .header {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #1f2937;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 0.25rem;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 80px);
            gap: 1px;
            background: #1f2937;
        }

        .control-panel {
            background: #111827;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #1f2937;
        }

        .analysis-area {
            background: #0b0f14;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Controls */
        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

        .control-input {
            width: 100%;
            background: #1f2937;
            border: 1px solid #374151;
            color: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .control-input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .coord-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #374151;
            color: white;
            margin-top: 0.5rem;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #111827;
            border-bottom: 1px solid #1f2937;
        }

        .tab {
            padding: 1rem 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tab:hover {
            color: #d1d5db;
        }

        .tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .tab-content {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin-top: 0.25rem;
        }

        .metric-sub {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Context Items */
        .context-section {
            margin-bottom: 2rem;
        }

        .context-section h4 {
            color: #e5e7eb;
            margin-bottom: 1rem;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .context-label {
            color: #9ca3af;
        }

        .context-value {
            color: #e5e7eb;
            font-weight: 500;
        }

        /* Hypotheses */
        .hypothesis-card {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .hypothesis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .hypothesis-type {
            font-weight: 600;
            color: #e5e7eb;
        }

        .evidence-level {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        .evidence-strong {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .evidence-moderate {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
        }

        .evidence-weak {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .evidence-insufficient {
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
        }

        /* Canvases */
        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .canvas-container {
            background: #000;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            aspect-ratio: 1;
            position: relative;
        }

        .canvas-container canvas {
            width: 100%;
            height: 100%;
        }

        .canvas-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(11, 15, 20, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #374151;
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Communication Text */
        .comm-text {
            line-height: 1.6;
            color: #d1d5db;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            background: #111827;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }

        /* Transparency */
        .transparency-section {
            margin-bottom: 2rem;
        }

        .limitation-item {
            padding: 0.5rem;
            border-left: 2px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* Success/Error */
        .error {
            color: #f87171;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .success {
            color: #4ade80;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        /* Dashboard Specific V2 */
        .dash-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .dash-card {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .dash-title {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .dash-status {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .dash-desc {
            font-size: 0.875rem;
            color: #9ca3af;
            line-height: 1.5;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 800;
            margin-top: 0.5rem;
        }

        .badge-detected {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .badge-uncertain {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .badge-high {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .instruments-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .instrument-tag {
            background: #111827;
            border: 1px solid #374151;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            color: #d1d5db;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>TIMT Engine</h1>
        <div class="subtitle">Territorial Inferential Multi-domain Tomography - Scientific Dashboard</div>
    </div>

    <div class="main-container">
        <!-- Panel de Control -->
        <div class="control-panel">
            <div class="control-group">
                <label class="control-label">Coordenadas del Territorio</label>
                <div class="coord-grid">
                    <input type="number" id="lat_min" class="control-input" placeholder="Lat Min" step="0.0001"
                        value="29.9730">
                    <input type="number" id="lat_max" class="control-input" placeholder="Lat Max" step="0.0001"
                        value="29.9810">
                    <input type="number" id="lon_min" class="control-input" placeholder="Lon Min" step="0.0001"
                        value="31.1300">
                    <input type="number" id="lon_max" class="control-input" placeholder="Lon Max" step="0.0001"
                        value="31.1380">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Regi√≥n / Nombre</label>
                <input type="text" id="region_name" class="control-input" placeholder="Ej: Giza Plateau">
            </div>

            <div class="control-group">
                <label class="control-label">Objetivo del An√°lisis</label>
                <select id="analysis_objective" class="control-input">
                    <option value="exploratory">Exploratorio</option>
                    <option value="validation">Validaci√≥n</option>
                    <option value="academic" selected>Investigaci√≥n Acad√©mica</option>
                    <option value="monitoring">Monitoreo</option>
                </select>
            </div>

            <div class="control-group">
                <div class="coord-grid">
                    <div>
                        <label class="control-label">Radio (km)</label>
                        <input type="number" id="analysis_radius" class="control-input" value="5" min="1" max="50">
                    </div>
                    <div>
                        <label class="control-label">Resoluci√≥n (m)</label>
                        <input type="number" id="resolution" class="control-input" value="30" min="1">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Nivel de Comunicaci√≥n</label>
                <select id="communication_level" class="control-input">
                    <option value="technical">T√©cnico Especializado</option>
                    <option value="academic">Acad√©mico</option>
                    <option value="general">P√∫blico General</option>
                    <option value="institutional">Institucional</option>
                </select>
            </div>

            <button id="analyze_btn" class="btn btn-primary" onclick="runAnalysis()">
                Ejecutar TIMT Completo
            </button>
            <button id="tcp_btn" class="btn btn-secondary" onclick="generateTCP()">
                Solo Contexto (TCP)
            </button>
        </div>

        <!-- √Årea de An√°lisis -->
        <div class="analysis-area">
            <div id="loading" class="loading-overlay">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #9ca3af; font-size: 0.875rem;">Procesando datos inferenciales...</p>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</div>
                <div class="tab" data-tab="context" onclick="switchTab('context')">Contexto (TCP)</div>
                <div class="tab" data-tab="tomography" onclick="switchTab('tomography')">Tomograf√≠a (ETP)</div>
                <div class="tab" data-tab="hypotheses" onclick="switchTab('hypotheses')">Hip√≥tesis</div>
                <div class="tab" data-tab="hrm" onclick="switchTab('hrm')">Neural (HRM)</div>
                <div class="tab" data-tab="transparency" onclick="switchTab('transparency')">Transparencia</div>
                <div class="tab" data-tab="communication" onclick="switchTab('communication')">Reporte</div>
            </div>

            <div class="tab-content">
                <!-- Welcome State -->
                <div id="welcome_message" style="text-align: center; padding: 4rem; color: #4b5563;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üõ∞Ô∏è</div>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: #9ca3af;">Sistema TIMT Listo</h3>
                    <p>Configure los par√°metros y ejecute un an√°lisis para comenzar.</p>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active" style="display: none;">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Coherencia Territorial</div>
                            <div class="metric-value" id="metric_coherence">-</div>
                            <div class="metric-sub">√çndice Epist√©mico</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Rigor Cient√≠fico</div>
                            <div class="metric-value" id="metric_rigor">-</div>
                            <div class="metric-sub">Metodolog√≠a Determin√≠stica</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ESS (Explanatory Strangeness)</div>
                            <div class="metric-value" id="metric_ess">-</div>
                            <div class="metric-sub">Rareza Estructural</div>
                        </div>
                        <div class="metric-card" id="coverage_card">
                            <div class="metric-label">Cobertura Instrumental</div>
                            <div class="metric-value" id="metric_coverage">-</div>
                            <div class="metric-sub" id="metric_instr_count">0 / 0 instrumentos</div>
                        </div>
                    </div>

                    <div class="dash-grid">
                        <div class="dash-card">
                            <div class="dash-title">Probabilidad de Origen Antropog√©nico</div>
                            <div class="dash-status" id="origin_prob_label">Evaluando...</div>
                            <div class="dash-desc" id="origin_prob_desc">Iniciando motor inferencial de 3 capas.</div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-title">Actividad Antropog√©nica</div>
                            <div class="dash-status" id="activity_prob_label">Pendiente</div>
                            <div class="dash-desc" id="activity_prob_desc">Requiere validaci√≥n cruzada de firmas
                                temporales.</div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-title">Anomal√≠a Instrumental</div>
                            <div class="dash-status" id="anomaly_label">No detectada</div>
                            <div class="dash-desc" id="anomaly_desc">Convergencia sensorial en el territorio analizado.
                            </div>
                        </div>
                        <div class="dash-card">
                            <div class="dash-title">Acci√≥n Recomendada</div>
                            <div class="dash-status" style="color: #60a5fa;" id="recommendation_label">-</div>
                            <div class="dash-desc" id="recommendation_desc">Supeditado a nivel de confianza inferencial.
                            </div>
                        </div>
                    </div>

                    <div class="dash-card" style="margin-top: 1.5rem;">
                        <div class="dash-title">Instrumentos Intervinientes</div>
                        <div class="instruments-list" id="dashboard_instruments"></div>
                    </div>
                </div>

                <!-- Context Tab -->
                <div id="context" class="tab-pane">
                    <div id="context_content"></div>
                </div>

                <!-- Tomography Tab -->
                <div id="tomography" class="tab-pane">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="context-section" id="tomography_metrics"></div>
                        <div class="canvas-grid">
                            <div class="canvas-container">
                                <div class="canvas-label">XY - Vista Superior</div>
                                <canvas id="xy_canvas"></canvas>
                            </div>
                            <div class="canvas-container">
                                <div class="canvas-label">XZ - Corte Longitudinal</div>
                                <canvas id="xz_canvas"></canvas>
                            </div>
                            <div class="canvas-container">
                                <div class="canvas-label">YZ - Corte Latitudinal</div>
                                <canvas id="yz_canvas"></canvas>
                            </div>
                            <div class="canvas-container">
                                <div class="canvas-label">Temporal - Heatmap</div>
                                <canvas id="temporal_canvas"></canvas>
                            </div>
                        </div>

                        <!-- NUEVO: Mapa de Anomal√≠a Fusionado -->
                        <div style="margin-top: 2rem;">
                            <h4>Mapa de Anomal√≠a Fundo (Fusi√≥n Multifuente)</h4>
                            <div id="fused_anomaly_container" style="margin-top: 1rem; text-align: center;">
                                <div
                                    style="padding: 2rem; color: #6b7280; border: 1px dashed #374151; border-radius: 0.5rem;">
                                    El mapa de anomal√≠a se genera al completar el an√°lisis.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hypotheses Tab -->
                <div id="hypotheses" class="tab-pane">
                    <div id="hypotheses_content"></div>
                </div>

                <!-- HRM Tab (New) -->
                <div id="hrm" class="tab-pane">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4>Visualizaci√≥n Neural HRM</h4>
                            <div id="hrm_visual_container" style="margin-top: 1rem; text-align: center;">
                                <div
                                    style="padding: 2rem; color: #6b7280; border: 1px dashed #374151; border-radius: 0.5rem;">
                                    Ejecute un an√°lisis completo para generar visualizaci√≥n neural.
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4>An√°lisis Morfol√≥gico de Alta Resoluci√≥n</h4>
                            <div id="hrm_text_content" class="comm-text" style="font-size: 0.8rem; margin-top: 1rem;">
                                Esperando resultados...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transparency Tab -->
                <div id="transparency" class="tab-pane">
                    <div id="transparency_content"></div>
                </div>

                <!-- Communication Tab -->
                <div id="communication" class="tab-pane">
                    <div class="tabs" style="margin-bottom: 1rem; background: transparent; border: none;">
                        <button class="btn btn-secondary comm-tab active" onclick="switchCommTab('technical')"
                            style="width: auto; margin:0 0.5rem 0 0;">T√©cnico</button>
                        <button class="btn btn-secondary comm-tab" onclick="switchCommTab('academic')"
                            style="width: auto; margin:0 0.5rem 0 0;">Acad√©mico</button>
                        <button class="btn btn-secondary comm-tab" onclick="switchCommTab('general')"
                            style="width: auto; margin:0 0.5rem 0 0;">General</button>
                        <button class="btn btn-secondary comm-tab" onclick="switchCommTab('institutional')"
                            style="width: auto; margin:0 0.5rem 0 0;">Institucional</button>
                    </div>
                    <div id="communication_content" class="comm-text"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8003';
        let currentAnalysis = null;

        // UI Helpers
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
            const target = document.getElementById(tabName);
            if (target) target.style.display = 'block';

            // Special handling for welcome message
            if (currentAnalysis) {
                document.getElementById('welcome_message').style.display = 'none';
            }
        }

        function switchCommTab(level) {
            document.querySelectorAll('.comm-tab').forEach(t => t.classList.remove('btn-primary'));
            document.querySelectorAll('.comm-tab').forEach(t => t.classList.add('btn-secondary'));
            // This is a bit hacky for button styles, simply removing/adding classes
            event.target.classList.remove('btn-secondary');
            event.target.classList.add('btn-primary');

            if (currentAnalysis) {
                const summaryKey = `${level}_summary`;
                const content = currentAnalysis[summaryKey] || 'Resumen no disponible.';
                document.getElementById('communication_content').textContent = content;
            }
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            el.className = show ? 'loading-overlay active' : 'loading-overlay';
        }

        function showError(msg) {
            alert('Error: ' + msg); // Simple fallback
        }

        // Logic
        async function runAnalysis() {
            showLoading(true);
            try {
                const payload = {
                    lat_min: parseFloat(document.getElementById('lat_min').value),
                    lat_max: parseFloat(document.getElementById('lat_max').value),
                    lon_min: parseFloat(document.getElementById('lon_min').value),
                    lon_max: parseFloat(document.getElementById('lon_max').value),
                    analysis_objective: document.getElementById('analysis_objective').value,
                    analysis_radius_km: parseFloat(document.getElementById('analysis_radius').value),
                    resolution_m: parseFloat(document.getElementById('resolution').value) || null,
                    communication_level: document.getElementById('communication_level').value,
                    region_name: document.getElementById('region_name').value || "Unknown Region"
                };

                const response = await fetch(`${API_BASE}/timt/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error en el an√°lisis');
                }

                const result = await response.json();
                currentAnalysis = result;
                renderResults(result);
                switchTab('dashboard');

            } catch (e) {
                console.error(e);
                showError(e.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateTCP() {
            showLoading(true);
            try {
                const payload = {
                    lat_min: parseFloat(document.getElementById('lat_min').value),
                    lat_max: parseFloat(document.getElementById('lat_max').value),
                    lon_min: parseFloat(document.getElementById('lon_min').value),
                    lon_max: parseFloat(document.getElementById('lon_max').value),
                    analysis_objective: document.getElementById('analysis_objective').value,
                    analysis_radius_km: parseFloat(document.getElementById('analysis_radius').value)
                };

                const response = await fetch(`${API_BASE}/timt/tcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Error generando TCP');

                const result = await response.json();
                // Map TCP response to partial full response structure for rendering
                const partialResult = {
                    tcp_summary: {
                        geological_context: result.geological_context.dominant_lithology,
                        hydrographic_features_count: result.hydrographic_features.length,
                        external_sites_count: result.external_sites.length,
                        human_traces_count: result.human_traces.length,
                        hypotheses_count: result.territorial_hypotheses.length
                    },
                    // Stub other fields to avoid crash
                    metric_coherence: 0, scientific_rigor: 0, ess_volumetric: 0,
                    hypothesis_validations: []
                };

                // Render what we can
                document.getElementById('context_content').innerHTML = `
                    <div class="context-section">
                        <h4>Contexto Geol√≥gico</h4>
                        <div class="context-item"><span class="context-label">Litolog√≠a</span><span class="context-value">${result.geological_context.dominant_lithology}</span></div>
                        <div class="context-item"><span class="context-label">Edad</span><span class="context-value">${result.geological_context.geological_age}</span></div>
                        <div class="context-item"><span class="context-label">Potencial Preservaci√≥n</span><span class="context-value">${result.geological_context.preservation_potential}</span></div>
                    </div>
                    <div class="context-section">
                         <h4>Hip√≥tesis Territoriales Identificadas</h4>
                         ${result.territorial_hypotheses.map(h => `
                            <div class="hypothesis-card">
                                <div class="hypothesis-header">
                                    <span class="hypothesis-type">${h.type}</span>
                                    <span class="context-value">${h.plausibility_score.toFixed(2)}</span>
                                </div>
                                <p style="font-size: 0.8rem; color:#9ca3af">${h.explanation}</p>
                            </div>
                         `).join('')}
                    </div>
                `;

                currentAnalysis = null; // Partial only
                switchTab('context');

            } catch (e) {
                console.error(e);
                showError(e.message);
            } finally {
                showLoading(false);
            }
        }

        function renderResults(data) {
            // 1. DASHBOARD - Metrics
            document.getElementById('metric_coherence').textContent = (data.territorial_coherence_score || 0).toFixed(3);
            document.getElementById('metric_rigor').textContent = (data.scientific_rigor_score || 0).toFixed(3);

            const etp = data.etp_summary || {};
            document.getElementById('metric_ess').textContent = (etp.ess_volumetrico || 0).toFixed(3);

            // Extract instrumentation from scientific_output if available
            const hrm = (data.scientific_output && data.scientific_output.hrm_analysis) || {};
            const sc_out = data.scientific_output || {};

            // Cobertura
            const instr_measured = sc_out.instruments_measured || 0;
            const instr_total = sc_out.available_instruments ? sc_out.available_instruments.length : 12;
            const coverage_raw = (sc_out.coverage_raw || 0) * 100;

            document.getElementById('metric_coverage').textContent = `${coverage_raw.toFixed(0)}%`;
            document.getElementById('metric_instr_count').textContent = `${instr_measured} / ${instr_total} instrumentos`;

            // 2. DASHBOARD - Logic & Semantic
            // Origen Antropog√©nico
            const originProb = sc_out.anthropic_origin_probability || 0;
            const originLabel = document.getElementById('origin_prob_label');
            const originDesc = document.getElementById('origin_prob_desc');

            if (originProb > 0.7) {
                originLabel.textContent = "Alta Probabilidad";
                originDesc.textContent = "Evidencia convergente sugiere origen artificial/humano.";
            } else if (originProb > 0.3) {
                originLabel.textContent = "No concluyente";
                originDesc.textContent = "La evidencia actual permite interpretaciones divergentes.";
            } else {
                originLabel.textContent = "Evaluaci√≥n Limitada";
                originDesc.textContent = "La cobertura instrumental actual no permite una inferencia robusta.";
            }

            // Anomal√≠a Instrumental
            const anomalyScore = sc_out.instrumental_anomaly_probability || 0;
            const anomalyLabel = document.getElementById('anomaly_label');
            const anomalyDesc = document.getElementById('anomaly_desc');
            if (anomalyScore > 0.6) {
                anomalyLabel.textContent = "Detectada (Alta)";
                anomalyDesc.textContent = "Se detectaron anomal√≠as f√≠sicas significativas en el registro instrumental.";
            } else {
                anomalyLabel.textContent = "Firma Est√°ndar";
                anomalyDesc.textContent = "No se detectan desviaciones cr√≠ticas de la morfolog√≠a esperada.";
            }

            // Recomendaci√≥n
            document.getElementById('recommendation_label').textContent = sc_out.recommended_action === 'monitoring_passive' ? "Monitoreo Pasivo" : "Verificaci√≥n de Campo";
            document.getElementById('recommendation_desc').textContent = sc_out.notes || "Acci√≥n determinada por rigor cient√≠fico y cobertura efectiva.";

            // Instrumentos Tags
            const instrList = document.getElementById('dashboard_instruments');
            instrList.innerHTML = '';
            const instruments = sc_out.available_instruments || ['Sentinel-2', 'Sentinel-1', 'DEM', 'ICESat-2'];
            instruments.forEach(inst => {
                const tag = document.createElement('span');
                tag.className = 'instrument-tag';
                tag.textContent = inst;
                instrList.appendChild(tag);
            });

            // 4. TOMOGRAPHY (ETP)

            // Render Fused Anomaly Map if available
            const anomalyContainer = document.getElementById('fused_anomaly_container');
            if (data.scientific_output && data.scientific_output.candidate_id) {
                const mapUrl = `${API_BASE}/anomaly-map/${data.scientific_output.candidate_id}.png`;
                anomalyContainer.innerHTML = `
                    <div style="background: #111827; padding: 1rem; border-radius: 0.75rem; border: 1px solid #374151;">
                        <img src="${mapUrl}" style="max-width: 100%; border-radius: 0.5rem; border: 1px solid #4b5563;" 
                             onerror="this.parentElement.innerHTML='<p style=\"color:#9ca3af\">Mapa de anomal√≠a no disponible para este candidato o a√∫n gener√°ndose.</p>'">
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">Corte horizontal de convergencia multifuente (Resoluci√≥n: ${etp.resolution_m || 30}m)</p>
                    </div>
                `;
            }

            drawTomographySimulation(etp);
            document.getElementById('tomography_metrics').innerHTML = `
                <h4>M√©tricas ETP</h4>
                <div class="context-item"><span class="context-label">ID Territorio</span><span class="context-value" style="font-size:0.6rem">${etp.territory_id}</span></div>
                <div class="context-item"><span class="context-label">ESS Sup.</span><span class="context-value">${(etp.ess_superficial || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">ESS Vol.</span><span class="context-value">${(etp.ess_volumetrico || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">Coherencia 3D</span><span class="context-value">${(etp.coherencia_3d || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">Persistencia</span><span class="context-value">${(etp.persistencia_temporal || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">Densidad Arq.</span><span class="context-value">${(etp.densidad_arqueologica_m3 || 0).toFixed(3)}</span></div>
            `;

            // 3. CONTEXT (TCP)
            const ctx = data.tcp_summary || {};
            document.getElementById('context_content').innerHTML = `
                <div class="context-section">
                    <h4>Perfil de Contexto Territorial (TCP)</h4>
                    <div class="context-item"><span class="context-label">Litolog√≠a Dominante</span><span class="context-value">${ctx.geological_context || 'No determinada'}</span></div>
                    <div class="context-item"><span class="context-label">Potencial de Preservaci√≥n</span><span class="context-value">${ctx.preservation_potential || 'Media'}</span></div>
                    <div class="context-item"><span class="context-label">Sistemas Hidrogr√°ficos</span><span class="context-value">${ctx.hydrographic_features_count || 0} identificados</span></div>
                    <div class="context-item"><span class="context-label">Sitios Arqueol√≥gicos Externos</span><span class="context-value">${ctx.external_sites_count || 0} conocidos</span></div>
                    <div class="context-item"><span class="context-label">Trazas Humanas Registradas</span><span class="context-value">${ctx.human_traces_count || 0} elementos</span></div>
                    <div class="context-item"><span class="context-label">Hip√≥tesis Generadas</span><span class="context-value">${ctx.hypotheses_count || 0} vectores de an√°lisis</span></div>
                </div>
            `;

            // 4. TOMOGRAPHY (ETP)
            document.getElementById('tomography_metrics').innerHTML = `
                <h4>M√©tricas ETP</h4>
                <div class="context-item"><span class="context-label">ID Territorio</span><span class="context-value" style="font-size:0.6rem">${etp.territory_id}</span></div>
                <div class="context-item"><span class="context-label">ESS Sup.</span><span class="context-value">${(etp.ess_superficial || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">ESS Vol.</span><span class="context-value">${(etp.ess_volumetrico || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">Coherencia 3D</span><span class="context-value">${(etp.coherencia_3d || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">Persistencia</span><span class="context-value">${(etp.persistencia_temporal || 0).toFixed(3)}</span></div>
                <div class="context-item"><span class="context-label">Densidad Arq.</span><span class="context-value">${(etp.densidad_arqueologica_m3 || 0).toFixed(3)}</span></div>
            `;

            // 5. HYPOTHESES
            const hypContainer = document.getElementById('hypotheses_content');
            if (data.hypothesis_validations && data.hypothesis_validations.length) {
                hypContainer.innerHTML = data.hypothesis_validations.map(h => `
                    <div class="hypothesis-card">
                        <div class="hypothesis-header">
                            <span class="hypothesis-type">${h.hypothesis_type}</span>
                            <span class="evidence-level evidence-${h.evidence_level}">${h.evidence_level}</span>
                        </div>
                        <p style="margin-top:0.5rem; font-size:0.875rem; color:#d1d5db">${h.explanation}</p>
                        <div style="margin-top:0.5rem; font-size:0.75rem; color:#9ca3af">
                            Confianza Inferencial: ${(h.confidence_score || 0).toFixed(2)}
                        </div>
                    </div>
                `).join('');
            } else {
                hypContainer.innerHTML = '<div class="limitation-item" style="border-left-color: #9ca3af; background: rgba(156, 163, 175, 0.1);">Sin validaciones detalladas disponibles para este rango.</div>';
            }

            // 6. TRANSPARENCY
            const trans = data.transparency_summary || {};
            document.getElementById('transparency_content').innerHTML = `
                <div class="transparency-section">
                    <h4>Declaraci√≥n Epist√©mica</h4>
                    <p style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 1rem;">
                        ArcheoScope opera bajo un modelo determin√≠stico. Las limitaciones aqu√≠ expuestas son pilar fundamental del rigor cient√≠fico del an√°lisis.
                    </p>
                    
                    <h5>Lo que el sistema NO puede afirmar:</h5>
                    ${(trans.cannot_affirm || []).map(item => `<div class="limitation-item">${item}</div>`).join('') || '<p>No se declararon limitaciones cr√≠ticas.</p>'}
                    
                    <h5 style="margin-top:1rem;">Inferencias permitidas con la cobertura actual:</h5>
                    ${(trans.can_infer || []).map(item => `<div class="limitation-item" style="border-left-color: #2563eb; background: rgba(37, 99, 235, 0.1);">${item}</div>`).join('')}
                    
                    <div class="context-item" style="margin-top:1.5rem">
                        <span class="context-label">Pasos de Procesamiento</span>
                        <span class="context-value">${trans.analysis_process_steps || 0} fases completadas</span>
                    </div>
                </div>
            `;

            // 7. HRM Results
            if (data.scientific_output && data.scientific_output.hrm_analysis) {
                const hrm_data = data.scientific_output.hrm_analysis;
                const vizContainer = document.getElementById('hrm_visual_container');
                if (hrm_data.visualizacion_neural) {
                    vizContainer.innerHTML = `<img src="${hrm_data.visualizacion_neural}" style="max-width:100%; border-radius:0.5rem; border:1px solid #374151; cursor: pointer;" onclick="window.open(this.src, '_blank')">`;
                    if (data.status === "success") {
                        window.open(hrm_data.visualizacion_neural, '_blank');
                    }
                } else {
                    vizContainer.innerHTML = `<div style="padding:2rem; color: #4b5563;">Sin visualizaci√≥n neural disponible.</div>`;
                }

                const textContainer = document.getElementById('hrm_text_content');
                textContainer.innerHTML = (hrm_data.raw_output || hrm_data.analisis_morfologico || "Sin reporte textual.").replace(/\n/g, '<br>');
            }

            // 8. Communication
            document.getElementById('communication_content').textContent = data.technical_summary || "Sin reporte de comunicaci√≥n generado.";

            // Finalize simulation
            drawTomographySimulation();
        }

        function drawTomographySimulation() {
            const ids = ['xy_canvas', 'xz_canvas', 'yz_canvas', 'temporal_canvas'];
            ids.forEach(id => {
                const cvs = document.getElementById(id);
                if (!cvs) return;
                const ctx = cvs.getContext('2d');
                cvs.width = cvs.offsetWidth;
                cvs.height = cvs.offsetHeight;

                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, cvs.width, cvs.height);

                // Random heatmap-ish blobs
                for (let i = 0; i < 5; i++) {
                    const x = Math.random() * cvs.width;
                    const y = Math.random() * cvs.height;
                    const r = 20 + Math.random() * 50;

                    const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                    g.addColorStop(0, 'rgba(96, 165, 250, 0.6)');
                    g.addColorStop(1, 'rgba(0,0,0,0)');

                    ctx.fillStyle = g;
                    ctx.beginPath();
                    ctx.arc(x, y, r, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, cvs.height / 2); ctx.lineTo(cvs.width, cvs.height / 2);
                ctx.moveTo(cvs.width / 2, 0); ctx.lineTo(cvs.width / 2, cvs.height);
                ctx.stroke();
            });
        }

        // Initial setup
        drawTomographySimulation();
    </script>
</body>

</html>