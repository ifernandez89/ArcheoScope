<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMT - Territorial Inferential Multi-domain Tomography</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0b0f14 0%, #1a1f2e 100%);
            color: #eaeef3;
            min-height: 100vh;
        }

        .header {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #1f2937;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 0.25rem;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 80px);
            gap: 1px;
            background: #1f2937;
        }

        .control-panel {
            background: #111827;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #1f2937;
        }

        .analysis-area {
            background: #0b0f14;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Controls */
        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

        .control-input {
            width: 100%;
            background: #1f2937;
            border: 1px solid #374151;
            color: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .control-input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .coord-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #374151;
            color: white;
            margin-top: 0.5rem;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #111827;
            border-bottom: 1px solid #1f2937;
        }

        .tab {
            padding: 1rem 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tab:hover {
            color: #d1d5db;
        }

        .tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .tab-content {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin-top: 0.25rem;
        }

        .metric-sub {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Context Items */
        .context-section {
            margin-bottom: 2rem;
        }

        .context-section h4 {
            color: #e5e7eb;
            margin-bottom: 1rem;
            border-bottom: 1px solid #374151;
            padding-bottom: 0.5rem;
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .context-label {
            color: #9ca3af;
        }

        .context-value {
            color: #e5e7eb;
            font-weight: 500;
        }

        /* Hypotheses */
        .hypothesis-card {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .hypothesis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .hypothesis-type {
            font-weight: 600;
            color: #e5e7eb;
        }

        .evidence-level {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        .evidence-strong {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .evidence-moderate {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
        }

        .evidence-weak {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .evidence-insufficient {
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
        }

        /* Canvases */
        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .canvas-container {
            background: #000;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            aspect-ratio: 1;
            position: relative;
        }

        .canvas-container canvas {
            width: 100%;
            height: 100%;
        }

        .canvas-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(11, 15, 20, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #374151;
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Communication Text */
        .comm-text {
            line-height: 1.6;
            color: #d1d5db;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            background: #111827;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }

        /* Transparency */
        .transparency-section {
            margin-bottom: 2rem;
        }

        .limitation-item {
            padding: 0.5rem;
            border-left: 2px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* Success/Error */
        .error {
            color: #f87171;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .success {
            color: #4ade80;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>TIMT Engine</h1>
        <div class="subtitle">Territorial Inferential Multi-domain Tomography - Scientific Dashboard</div>
    </div>

    <div class="main-container">
        <!-- Panel de Control -->
        <div class="control-panel">
            <div class="control-group">
                <label class="control-label">Coordenadas del Territorio</label>
                <div class="coord-grid">
                    <input type="number" id="lat_min" class="control-input" placeholder="Lat Min" step="0.0001"
                        value="29.9730">
                    <input type="number" id="lat_max" class="control-input" placeholder="Lat Max" step="0.0001"
                        value="29.9810">
                    <input type="number" id="lon_min" class="control-input" placeholder="Lon Min" step="0.0001"
                        value="31.1300">
                    <input type="number" id="lon_max" class="control-input" placeholder="Lon Max" step="0.0001"
                        value="31.1380">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Regi√≥n / Nombre</label>
                <input type="text" id="region_name" class="control-input" placeholder="Ej: Giza Plateau">
            </div>

            <div class="control-group">
                <label class="control-label">Objetivo del An√°lisis</label>
                <select id="analysis_objective" class="control-input">
                    <option value="exploratory">Exploratorio</option>
                    <option value="validation">Validaci√≥n</option>
                    <option value="academic" selected>Investigaci√≥n Acad√©mica</option>
                    <option value="monitoring">Monitoreo</option>
                </select>
            </div>

            <div class="control-group">
                <div class="coord-grid">
                    <div>
                        <label class="control-label">Radio (km)</label>
                        <input type="number" id="analysis_radius" class="control-input" value="5" min="1" max="50">
                    </div>
                    <div>
                        <label class="control-label">Resoluci√≥n (m)</label>
                        <input type="number" id="resolution" class="control-input" value="30" min="1">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Nivel de Comunicaci√≥n</label>
                <select id="communication_level" class="control-input">
                    <option value="technical">T√©cnico Especializado</option>
                    <option value="academic">Acad√©mico</option>
                    <option value="general">P√∫blico General</option>
                    <option value="institutional">Institucional</option>
                </select>
            </div>

            <button id="analyze_btn" class="btn btn-primary" onclick="runAnalysis()">
                Ejecutar TIMT Completo
            </button>
            <button id="tcp_btn" class="btn btn-secondary" onclick="generateTCP()">
                Solo Contexto (TCP)
            </button>
        </div>

        <!-- √Årea de An√°lisis -->
        <div class="analysis-area">
            <div id="loading" class="loading-overlay">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #9ca3af; font-size: 0.875rem;">Procesando datos inferenciales...</p>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</div>
                <div class="tab" data-tab="context" onclick="switchTab('context')">Contexto (TCP)</div>
                <div class="tab" data-tab="tomography" onclick="switchTab('tomography')">Tomograf√≠a (ETP)</div>
                <div class="tab" data-tab="hypotheses" onclick="switchTab('hypotheses')">Hip√≥tesis</div>
                <div class="tab" data-tab="hrm" onclick="switchTab('hrm')">Neural (HRM)</div>
                <div class="tab" data-tab="transparency" onclick="switchTab('transparency')">Transparencia</div>
                <div class="tab" data-tab="communication" onclick="switchTab('communication')">Reporte</div>
            </div>

            <div class="tab-content">
                <!-- Welcome State -->
                <div id="welcome_message" style="text-align: center; padding: 4rem; color: #4b5563;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üõ∞Ô∏è</div>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: #9ca3af;">Sistema TIMT Listo</h3>
                    <p>Configure los par√°metros y ejecute un an√°lisis para comenzar.</p>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-pane active" style="display: none;">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Coherencia Territorial</div>
                            <div class="metric-value" id="metric_coherence">-</div>
                            <div class="metric-sub">√çndice Global</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Rigor Cient√≠fico</div>
                            <div class="metric-value" id="metric_rigor">-</div>
                            <div class="metric-sub">Score de Validaci√≥n</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ESS Volum√©trico</div>
                            <div class="metric-value" id="metric_ess">-</div>
                            <div class="metric-sub">Evidencia Sensorial</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Hip√≥tesis Validadas</div>
                            <div class="metric-value" id="metric_hypotheses">-</div>
                            <div class="metric-sub">Fuerte/Moderada</div>
                        </div>
                    </div>

                    <div id="dashboard_summary" class="context-section"></div>
                </div>

                <!-- Context Tab -->
                <div id="context" class="tab-pane">
                    <div id="context_content"></div>
                </div>

                <!-- Tomography Tab -->
                <div id="tomography" class="tab-pane">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="context-section" id="tomography_metrics"></div>
                        <div class="canvas-grid">
                            <div class="canvas-container">
                                <div class="canvas-label">XY - Vista Superior</div>
                                <canvas id="xy_canvas"></canvas>
                            </div>
                            <div class="canvas-container">
                                <div class="canvas-label">XZ - Corte Longitudinal</div>
                                <canvas id="xz_canvas"></canvas>
                            </div>
                            <div class="canvas-container">
                                <div class="canvas-label">YZ - Corte Latitudinal</div>
                                <canvas id="yz_canvas"></canvas>
                            </div>
                            <div class="canvas-container">
                                <div class="canvas-label">Temporal - Heatmap</div>
                                <canvas id="temporal_canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hypotheses Tab -->
                <div id="hypotheses" class="tab-pane">
                    <div id="hypotheses_content"></div>
                </div>

                <!-- HRM Tab (New) -->
                <div id="hrm" class="tab-pane">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4>Visualizaci√≥n Neural HRM</h4>
                            <div id="hrm_visual_container" style="margin-top: 1rem; text-align: center;">
                                <div
                                    style="padding: 2rem; color: #6b7280; border: 1px dashed #374151; border-radius: 0.5rem;">
                                    Ejecute un an√°lisis completo para generar visualizaci√≥n neural.
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4>An√°lisis Morfol√≥gico de Alta Resoluci√≥n</h4>
                            <div id="hrm_text_content" class="comm-text" style="font-size: 0.8rem; margin-top: 1rem;">
                                Esperando resultados...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transparency Tab -->
                <div id="transparency" class="tab-pane">
                    <div id="transparency_content"></div>
                </div>

                <!-- Communication Tab -->
                <div id="communication" class="tab-pane">
                    <div class="tabs" style="margin-bottom: 1rem; background: transparent; border: none;">
                        <button class="btn btn-secondary comm-tab active" onclick="switchCommTab('technical')"
                            style="width: auto; margin:0 0.5rem 0 0;">T√©cnico</button>
                        <button class="btn btn-secondary comm-tab" onclick="switchCommTab('academic')"
                            style="width: auto; margin:0 0.5rem 0 0;">Acad√©mico</button>
                        <button class="btn btn-secondary comm-tab" onclick="switchCommTab('general')"
                            style="width: auto; margin:0 0.5rem 0 0;">General</button>
                        <button class="btn btn-secondary comm-tab" onclick="switchCommTab('institutional')"
                            style="width: auto; margin:0 0.5rem 0 0;">Institucional</button>
                    </div>
                    <div id="communication_content" class="comm-text"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8003';
        let currentAnalysis = null;

        // UI Helpers
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
            const target = document.getElementById(tabName);
            if (target) target.style.display = 'block';

            // Special handling for welcome message
            if (currentAnalysis) {
                document.getElementById('welcome_message').style.display = 'none';
            }
        }

        function switchCommTab(level) {
            document.querySelectorAll('.comm-tab').forEach(t => t.classList.remove('btn-primary'));
            document.querySelectorAll('.comm-tab').forEach(t => t.classList.add('btn-secondary'));
            // This is a bit hacky for button styles, simply removing/adding classes
            event.target.classList.remove('btn-secondary');
            event.target.classList.add('btn-primary');

            if (currentAnalysis) {
                const summaryKey = `${level}_summary`;
                const content = currentAnalysis[summaryKey] || 'Resumen no disponible.';
                document.getElementById('communication_content').textContent = content;
            }
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            el.className = show ? 'loading-overlay active' : 'loading-overlay';
        }

        function showError(msg) {
            alert('Error: ' + msg); // Simple fallback
        }

        // Logic
        async function runAnalysis() {
            showLoading(true);
            try {
                const payload = {
                    lat_min: parseFloat(document.getElementById('lat_min').value),
                    lat_max: parseFloat(document.getElementById('lat_max').value),
                    lon_min: parseFloat(document.getElementById('lon_min').value),
                    lon_max: parseFloat(document.getElementById('lon_max').value),
                    analysis_objective: document.getElementById('analysis_objective').value,
                    analysis_radius_km: parseFloat(document.getElementById('analysis_radius').value),
                    resolution_m: parseFloat(document.getElementById('resolution').value) || null,
                    communication_level: document.getElementById('communication_level').value,
                    region_name: document.getElementById('region_name').value || "Unknown Region"
                };

                const response = await fetch(`${API_BASE}/timt/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error en el an√°lisis');
                }

                const result = await response.json();
                currentAnalysis = result;
                renderResults(result);
                switchTab('dashboard');

            } catch (e) {
                console.error(e);
                showError(e.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateTCP() {
            showLoading(true);
            try {
                const payload = {
                    lat_min: parseFloat(document.getElementById('lat_min').value),
                    lat_max: parseFloat(document.getElementById('lat_max').value),
                    lon_min: parseFloat(document.getElementById('lon_min').value),
                    lon_max: parseFloat(document.getElementById('lon_max').value),
                    analysis_objective: document.getElementById('analysis_objective').value,
                    analysis_radius_km: parseFloat(document.getElementById('analysis_radius').value)
                };

                const response = await fetch(`${API_BASE}/timt/tcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Error generando TCP');

                const result = await response.json();
                // Map TCP response to partial full response structure for rendering
                const partialResult = {
                    tcp_summary: {
                        geological_context: result.geological_context.dominant_lithology,
                        hydrographic_features_count: result.hydrographic_features.length,
                        external_sites_count: result.external_sites.length,
                        human_traces_count: result.human_traces.length,
                        hypotheses_count: result.territorial_hypotheses.length
                    },
                    // Stub other fields to avoid crash
                    metric_coherence: 0, scientific_rigor: 0, ess_volumetric: 0,
                    hypothesis_validations: []
                };

                // Render what we can
                document.getElementById('context_content').innerHTML = `
                    <div class="context-section">
                        <h4>Contexto Geol√≥gico</h4>
                        <div class="context-item"><span class="context-label">Litolog√≠a</span><span class="context-value">${result.geological_context.dominant_lithology}</span></div>
                        <div class="context-item"><span class="context-label">Edad</span><span class="context-value">${result.geological_context.geological_age}</span></div>
                        <div class="context-item"><span class="context-label">Potencial Preservaci√≥n</span><span class="context-value">${result.geological_context.preservation_potential}</span></div>
                    </div>
                    <div class="context-section">
                         <h4>Hip√≥tesis Territoriales Identificadas</h4>
                         ${result.territorial_hypotheses.map(h => `
                            <div class="hypothesis-card">
                                <div class="hypothesis-header">
                                    <span class="hypothesis-type">${h.type}</span>
                                    <span class="context-value">${h.plausibility_score.toFixed(2)}</span>
                                </div>
                                <p style="font-size: 0.8rem; color:#9ca3af">${h.explanation}</p>
                            </div>
                         `).join('')}
                    </div>
                `;

                currentAnalysis = null; // Partial only
                switchTab('context');

            } catch (e) {
                console.error(e);
                showError(e.message);
            } finally {
                showLoading(false);
            }
        }

        function renderResults(data) {
            // Dashboard Metrics
            document.getElementById('metric_coherence').textContent = data.territorial_coherence_score.toFixed(3);
            document.getElementById('metric_rigor').textContent = data.scientific_rigor_score.toFixed(3);
            document.getElementById('metric_ess').textContent = data.etp_summary ? data.etp_summary.ess_volumetrico.toFixed(3) : '-';

            const validHypotheses = data.hypothesis_validations.filter(h => h.evidence_level === 'strong' || h.evidence_level === 'moderate').length;
            document.getElementById('metric_hypotheses').textContent = validHypotheses;

            // Context
            const ctx = data.tcp_summary;
            document.getElementById('context_content').innerHTML = `
                <div class="context-section">
                    <h4>Resumen Contextual (TCP)</h4>
                    <div class="context-item"><span class="context-label">Geolog√≠a Dominante</span><span class="context-value">${ctx.geological_context}</span></div>
                    <div class="context-item"><span class="context-label">Caracter√≠sticas Hidrogr√°ficas</span><span class="context-value">${ctx.hydrographic_features_count}</span></div>
                    <div class="context-item"><span class="context-label">Sitios Externos Conocidos</span><span class="context-value">${ctx.external_sites_count}</span></div>
                    <div class="context-item"><span class="context-label">Trazas Humanas</span><span class="context-value">${ctx.human_traces_count}</span></div>
                </div>
            `;

            // Hypotheses
            const hypContainer = document.getElementById('hypotheses_content');
            hypContainer.innerHTML = data.hypothesis_validations.map(h => `
                <div class="hypothesis-card">
                    <div class="hypothesis-header">
                        <span class="hypothesis-type">${h.hypothesis_type}</span>
                        <span class="evidence-level evidence-${h.evidence_level}">${h.evidence_level}</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">Confianza</span>
                        <span class="context-value">${h.confidence_score.toFixed(2)}</span>
                    </div>
                    <p style="margin-top:0.5rem; font-size:0.875rem; color:#d1d5db">${h.explanation}</p>
                     ${h.supporting_factors.length ? `<div style="margin-top:0.5rem; font-size:0.8rem; color:#4ade80">‚úÖ ${h.supporting_factors.join(', ')}</div>` : ''}
                     ${h.contradictions.length ? `<div style="margin-top:0.5rem; font-size:0.8rem; color:#f87171">‚ùå ${h.contradictions.join(', ')}</div>` : ''}
                </div>
            `).join('');

            // HRM Results
            if (data.scientific_output && data.scientific_output.hrm_analysis) {
                const hrm = data.scientific_output.hrm_analysis;

                // Visual
                const vizContainer = document.getElementById('hrm_visual_container');
                if (hrm.visualizacion_neural) {
                    vizContainer.innerHTML = `<img src="${hrm.visualizacion_neural}" style="max-width:100%; border-radius:0.5rem; border:1px solid #374151; cursor: pointer;" onclick="window.open(this.src, '_blank')">`;
                    // Abrir autom√°ticamente si es un an√°lisis completo nuevo
                    if (data.status === "success") {
                        console.log("Auto-opening HRM visualization...");
                        window.open(hrm.visualizacion_neural, '_blank');
                    }
                } else {
                    vizContainer.innerHTML = `<div style="padding:2rem;">Sin visualizaci√≥n disponible</div>`;
                }

                // Text
                const textContainer = document.getElementById('hrm_text_content');
                if (hrm.raw_output) {
                    textContainer.textContent = hrm.raw_output;
                } else {
                    textContainer.innerHTML = `
                        <strong>An√°lisis Morfol√≥gico:</strong>\n${hrm.analisis_morfologico}\n\n
                        <strong>Hip√≥tesis Antr√≥pica:</strong>\n${hrm.hipotesis_antropica}\n\n
                        <strong>Incertidumbre:</strong> ${hrm.nivel_incertidumbre}
                    `.replace(/\n/g, '<br>');
                }
            } else {
                document.getElementById('hrm_text_content').textContent = "An√°lisis HRM no disponible en este resultado.";
                document.getElementById('hrm_visual_container').innerHTML = "";
            }

            // Communication Default
            document.getElementById('communication_content').textContent = data.technical_summary;

            // Draw Dummy Tomography (Simulation)
            drawTomographySimulation();
        }

        function drawTomographySimulation() {
            // Simple visual placeholder for the canvases
            const ids = ['xy_canvas', 'xz_canvas', 'yz_canvas', 'temporal_canvas'];
            ids.forEach(id => {
                const cvs = document.getElementById(id);
                if (!cvs) return;
                const ctx = cvs.getContext('2d');
                cvs.width = cvs.offsetWidth;
                cvs.height = cvs.offsetHeight;

                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, cvs.width, cvs.height);

                // Random heatmap-ish blobs
                for (let i = 0; i < 5; i++) {
                    const x = Math.random() * cvs.width;
                    const y = Math.random() * cvs.height;
                    const r = 20 + Math.random() * 50;

                    const g = ctx.createRadialGradient(x, y, 0, x, y, r);
                    g.addColorStop(0, 'rgba(96, 165, 250, 0.6)');
                    g.addColorStop(1, 'rgba(0,0,0,0)');

                    ctx.fillStyle = g;
                    ctx.beginPath();
                    ctx.arc(x, y, r, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, cvs.height / 2); ctx.lineTo(cvs.width, cvs.height / 2);
                ctx.moveTo(cvs.width / 2, 0); ctx.lineTo(cvs.width / 2, cvs.height);
                ctx.stroke();
            });
        }

        // Initial setup
        drawTomographySimulation();
    </script>
</body>

</html>