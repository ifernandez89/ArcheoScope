<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∫ ArcheoScope - Archaeological Coherence Engine v2.1</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè∫</text></svg>">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer" />
    
    <!-- LiDAR Availability Checker -->
    <script src="lidar_availability_checker.js"></script>
    
    <!-- Estilos cient√≠ficos corregidos -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #ffffff;
            color: #2c3e50;
            overflow: hidden;
        }

        /* Barra superior - LAYOUT DEFINITIVO SIN DESBORDAMIENTO */
        .top-bar {
            background-color: #8B4513;
            color: white;
            padding: 0.4rem 0.5rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: auto;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px solid #D2691E;
            position: sticky;
            top: 0;
            z-index: 1000;
            min-height: 50px;
            max-height: 70px;
            overflow: visible;
        }

        .top-bar h1 {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            margin: 0;
            padding-right: 0.5rem;
        }

        /* Controles de regi√≥n - CENTRADOS Y COMPACTOS */
        .region-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            flex-wrap: nowrap;
            min-width: 0;
            overflow: hidden;
        }

        /* Inputs ultra compactos */
        .coord-input {
            width: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 0.15rem 0.25rem;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-size: 0.7rem;
            font-family: inherit;
            text-align: center;
        }

        .coord-search {
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            padding: 0.15rem 0.25rem;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-size: 0.7rem;
            font-family: inherit;
        }

        /* Botones ultra compactos */
        .search-btn, .investigate-btn {
            padding: 0.15rem 0.4rem;
            border: none;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .search-btn {
            background-color: #D2691E;
            color: white;
        }

        .search-btn:hover {
            background-color: #CD853F;
        }

        .investigate-btn {
            background-color: #D2691E;
            color: white;
            font-weight: 600;
        }

        .investigate-btn:hover {
            background-color: #CD853F;
        }

        .investigate-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        /* Sistema de estado - SIEMPRE VISIBLE */
        .system-status {
            display: flex;
            gap: 3px;
            align-items: center;
            flex-shrink: 0;
            justify-self: end;
            padding-left: 0.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 2px 4px;
            border-radius: 6px;
            font-size: 7px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }

        .status-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }

        .status-online { background-color: #4CAF50; }
        .status-offline { background-color: #f44336; }
        .status-warning { background-color: #ff9800; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-tooltip {
            position: relative;
            cursor: help;
        }

        .status-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 8px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Layout principal ajustado */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 360px;
            height: calc(100vh - 50px);
            position: relative;
        }

        /* RESPONSIVIDAD COMPLETA */
        @media screen and (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 280px 1fr 320px;
            }
            .top-bar h1 {
                font-size: 0.9rem;
            }
        }

        @media screen and (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media screen and (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: calc(100vh - 70px);
            }
            
            .top-bar {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                min-height: 70px;
                padding: 0.3rem;
                gap: 0.3rem;
            }
            
            .top-bar h1 {
                text-align: center;
                font-size: 0.85rem;
            }
            
            .region-controls {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .system-status {
                justify-self: center;
            }
            
            .controls-panel {
                order: 3;
                height: 200px;
                overflow-y: auto;
                border-right: none;
                border-top: 1px solid #dee2e6;
            }
            
            .analysis-panel {
                order: 2;
                height: 200px;
                border-left: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .map-container {
                order: 1;
                height: calc(100vh - 470px);
                min-height: 300px;
            }
        }

        @media screen and (max-width: 480px) {
            .top-bar {
                min-height: 90px;
            }
            
            .main-layout {
                height: calc(100vh - 90px);
            }
            
            .top-bar h1 {
                font-size: 0.8rem;
            }
            
            .coord-input, .coord-search {
                width: 45px;
                min-width: 45px;
                font-size: 0.65rem;
            }
            
            .search-btn, .investigate-btn {
                padding: 0.15rem 0.35rem;
                font-size: 0.65rem;
            }
            
            .map-container {
                height: calc(100vh - 490px);
                min-height: 250px;
            }
        }

        /* Panel de controles (izquierda) - SOLO controles */
        .controls-panel {
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
            padding: 1rem;
            overflow-y: auto;
        }

        .controls-section {
            margin-bottom: 1.5rem;
        }

        .controls-section h3 {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #D2691E;
        }

        .layer-toggle, .rule-toggle {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .layer-toggle input, .rule-toggle input {
            margin-right: 0.75rem;
            margin-top: 0.1rem;
            flex-shrink: 0;
        }

        .layer-toggle label, .rule-toggle label {
            cursor: pointer;
            color: #34495e;
            word-wrap: break-word;
            hyphens: auto;
            flex: 1;
        }

        /* Mapa principal (centro) */
        .map-container {
            position: relative;
            background-color: #f8f9fa;
        }

        #map {
            height: 100%;
            width: 100%;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #8B4513;
            font-weight: 600;
        }

        /* Panel de an√°lisis (derecha) - TODO el an√°lisis */
        .analysis-panel {
            background-color: #ffffff;
            border-left: 1px solid #dee2e6;
            padding: 1rem;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .analysis-panel h3 {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #D2691E;
        }

        .inspection-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 3px solid #D2691E;
        }

        .pixel-coords {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .data-values {
            margin-bottom: 1rem;
        }

        .data-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            padding: 0.25rem 0;
        }

        .data-label {
            color: #5d6d7e;
            flex: 1;
            margin-right: 0.5rem;
        }

        .data-number {
            font-weight: 600;
            color: #2c3e50;
            text-align: right;
            min-width: 80px;
        }

        .rules-evaluation {
            margin-bottom: 1rem;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
        }

        .rule-pass {
            background-color: #d5f4e6;
            color: #27ae60;
        }

        .rule-fail {
            background-color: #fadbd8;
            color: #e74c3c;
        }

        .rule-name {
            font-size: 0.75rem;
            flex: 1;
            margin-right: 0.5rem;
        }

        .rule-status {
            font-weight: 600;
            font-size: 0.75rem;
        }

        .controls-section {
            margin-bottom: 1.5rem;
        }

        .controls-section h3 {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #D2691E;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            padding: 0.25rem 0;
        }

        .metric-label {
            color: #5d6d7e;
            flex: 1;
            margin-right: 0.5rem;
        }

        .metric-value {
            font-weight: 600;
            color: #8B4513;
            text-align: right;
            min-width: 120px;
            word-wrap: break-word;
        }

        .archaeological-data {
            background-color: #fdf6e3;
            border-left: 3px solid #D2691E;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .archaeological-data h4 {
            font-size: 0.9rem;
            color: #8B4513;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .volumetric-info {
            background-color: #f0f8ff;
            border-left: 3px solid #4682b4;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .volumetric-info h4 {
            font-size: 0.9rem;
            color: #4682b4;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .anomaly-details {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .anomaly-details h4 {
            font-size: 0.9rem;
            color: #856404;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .inference-system {
            background-color: #e7f3ff;
            border-left: 3px solid #007bff;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .inference-system h4 {
            font-size: 0.9rem;
            color: #0056b3;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s ease;
        }

        .message {
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }

        .message.error {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .message.success {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        /* Botones de exportaci√≥n */
        .export-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 0.5rem;
            font-family: inherit;
        }

        .export-btn:hover {
            opacity: 0.9;
        }

        .export-btn.json { background-color: #f39c12; }
        .export-btn.dataset { background-color: #27ae60; }

        /* Estilos para diagn√≥stico cient√≠fico de datos */
        .data-diagnostic {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .data-diagnostic.critical {
            background: linear-gradient(135deg, #fadbd8 0%, #f8d7da 100%);
            border-left: 4px solid #dc3545;
            padding: 1rem;
            border-radius: 4px;
        }

        .data-diagnostic.limited {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #fd7e14;
            padding: 1rem;
            border-radius: 4px;
        }

        .data-diagnostic.valid {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-left: 4px solid #ffc107;
            padding: 1rem;
            border-radius: 4px;
        }

        .data-diagnostic.optimal {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid #28a745;
            padding: 1rem;
            border-radius: 4px;
        }

        /* Estilos para protocolo de calibraci√≥n cient√≠fica */
        .calibration-protocol {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .protocol-header {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 4px;
        }

        .protocol-step {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(0, 123, 255, 0.05);
            border-left: 3px solid #007bff;
            border-radius: 4px;
        }

        .step-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        .step-coordinates {
            font-family: 'Consolas', monospace;
            background: rgba(0, 123, 255, 0.1);
            padding: 0.25rem;
            border-radius: 3px;
            margin: 0.5rem 0;
        }

        .step-requirements, .outcomes {
            margin: 0.5rem 0;
        }

        .step-requirements div, .outcomes div {
            margin: 0.25rem 0;
        }

        .reference-type {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 3px;
            border-left: 2px solid #28a745;
        }

        .analysis-note {
            background: rgba(255, 193, 7, 0.1);
            padding: 0.5rem;
            border-radius: 3px;
            margin: 0.5rem 0;
            text-align: center;
        }

        .protocol-validation {
            background: rgba(40, 167, 69, 0.1);
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #28a745;
            margin-top: 1rem;
        }

        .validation-principle, .validation-methodology, .validation-honesty {
            margin: 0.5rem 0;
        }

        /* Estilos para diagn√≥stico cient√≠fico de datos */

        .analysis-header {
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.5rem;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 4px;
        }

        .analysis-section {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(220, 53, 69, 0.05);
            border-left: 3px solid #dc3545;
            border-radius: 4px;
        }

        .section-title {
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .time-range {
            font-family: 'Consolas', monospace;
            background: rgba(220, 53, 69, 0.1);
            padding: 0.25rem;
            border-radius: 3px;
            margin: 0.5rem 0;
        }

        .requirements, .modern-layers {
            margin: 0.5rem 0;
        }

        .requirements div {
            margin: 0.25rem 0;
        }

        .layer-info, .measurement-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 3px;
            border-left: 2px solid #ffc107;
        }

        .roman-standards {
            background: rgba(40, 167, 69, 0.1);
            padding: 0.5rem;
            border-radius: 3px;
            margin: 0.5rem 0;
            border-left: 2px solid #28a745;
        }

        .geometric-results.success {
            background: rgba(40, 167, 69, 0.1);
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #28a745;
            margin: 0.5rem 0;
        }

        .geometric-results.pending {
            background: rgba(255, 193, 7, 0.1);
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
            margin: 0.5rem 0;
        }

        .validation-section {
            background: rgba(40, 167, 69, 0.1);
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #28a745;
            margin-top: 1rem;
        }

        .strong-evidence div {
            margin: 0.25rem 0;
        }

        .confidence-statement, .conclusion, .methodology {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
        }

        /* Estilos para ventana temporal como sensor */
        .temporal-sensor-analysis {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .sensor-header {
            font-weight: bold;
            color: #4682b4;
            margin-bottom: 1rem;
            text-align: center;
            padding: 0.5rem;
            background: rgba(70, 130, 180, 0.1);
            border-radius: 4px;
        }

        .principle-section, .definition-section, .specifications-section, 
        .calculations-section, .integration-section, .thresholds-section, .philosophy-section {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(70, 130, 180, 0.05);
            border-left: 3px solid #4682b4;
            border-radius: 4px;
        }

        .principle-title, .definition-title, .spec-title, .calc-title, 
        .integration-title, .thresholds-title, .philosophy-title {
            font-weight: bold;
            color: #4682b4;
            margin-bottom: 0.5rem;
        }

        .principle-concept, .definition-question, .definition-meaning, .spec-details {
            margin: 0.5rem 0;
        }

        .years-analyzed, .temporal-metrics, .temporal-pending, .no-temporal-data, .data-quality {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 3px;
            border-left: 2px solid #4682b4;
        }

        .confidence-formula, .confidence-scores, .confidence-interpretation {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 3px;
            border-left: 2px solid #28a745;
        }

        .thresholds-list {
            margin: 0.5rem 0;
        }

        .threshold-item {
            margin: 0.25rem 0;
            padding: 0.25rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
        }

        .thresholds-note {
            font-style: italic;
            color: #666;
            margin-top: 0.5rem;
        }

        .philosophy-content {
            background: rgba(255, 193, 7, 0.1);
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
            margin: 0.5rem 0;
        }

        /* Bot√≥n de lupa arqueol√≥gica - MEJORADO Y M√ÅS VISIBLE */
        .lupa-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
            transition: all 0.3s ease;
            display: none;
            min-width: 180px;
            text-align: center;
        }

        .lupa-btn:hover {
            background: linear-gradient(135deg, #D2691E 0%, #CD853F 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.5);
        }

        .lupa-btn.active {
            display: block !important;
            animation: lupaAppear 0.5s ease-out, lupaPulse 2s infinite 0.5s;
        }

        @keyframes lupaAppear {
            0% { 
                opacity: 0; 
                transform: scale(0.8) translateY(-10px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        @keyframes lupaPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 8px 25px rgba(139, 69, 19, 0.6);
            }
        }

        /* Modal de lupa arqueol√≥gica */
        .lupa-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
        }

        .lupa-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Modal de historial de anomal√≠as */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .history-modal.active {
            display: flex;
        }

        .history-content {
            width: 90%;
            max-width: 1000px;
            height: 85%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .history-header {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-history {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-history:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .history-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-date {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
        }

        .history-coordinates {
            font-family: 'Consolas', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .history-summary {
            margin: 0.5rem 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .history-anomalies {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.5rem 0;
        }

        .anomaly-tag {
            background: #8B4513;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .history-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .history-btn.view {
            background: #007bff;
            color: white;
        }

        .history-btn.export {
            background: #28a745;
            color: white;
        }

        .history-btn.delete {
            background: #dc3545;
            color: white;
        }

        .history-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .history-stats {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .lupa-content {
            width: 95%;
            height: 95%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .lupa-header {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lupa-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-lupa {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-lupa:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .lupa-body {
            flex: 1;
            display: flex;
        }

        .lupa-map-container {
            flex: 1;
            position: relative;
        }

        #lupaMap {
            width: 100%;
            height: 100%;
        }

        .lupa-sidebar {
            width: 350px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 1rem;
            max-height: 100%;
            /* Asegurar que el scroll funcione correctamente */
            height: calc(100vh - 120px);
            scrollbar-width: thin;
            scrollbar-color: #8B4513 #f8f9fa;
        }

        /* Estilos para scrollbar en webkit browsers */
        .lupa-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .lupa-sidebar::-webkit-scrollbar-track {
            background: #f8f9fa;
        }

        .lupa-sidebar::-webkit-scrollbar-thumb {
            background: #8B4513;
            border-radius: 4px;
        }

        .lupa-sidebar::-webkit-scrollbar-thumb:hover {
            background: #D2691E;
        }

        .instrument-layer {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .instrument-layer:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .instrument-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .instrument-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .layer-toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .layer-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #8B4513;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .instrument-data {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .anomaly-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
        }

        .anomaly-high {
            background: #dc3545;
            color: white;
        }

        .anomaly-medium {
            background: #ffc107;
            color: #212529;
        }

        .anomaly-low {
            background: #28a745;
            color: white;
        }

        .anomaly-none {
            background: #6c757d;
            color: white;
        }

        /* Controles de capas en el mapa de lupa */
        .lupa-layer-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .lupa-layer-controls h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .layer-control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        /* Estilos para selecci√≥n interactiva en mapa */
        .selection-pin {
            background: #ff4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: pinPulse 2s infinite;
        }
        
        .selection-area {
            border: 2px dashed #2196F3;
            background: rgba(33, 150, 243, 0.1);
            fill-opacity: 0.1;
        }
        
        .selection-mode-active {
            cursor: crosshair !important;
        }
        
        @keyframes pinPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .selection-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
        }

        /* Estilos para iconos de anomal√≠as en el mapa */
        .anomaly-icon {
            z-index: 1000;
        }
        
        .anomaly-icon div {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .anomaly-icon div:hover {
            transform: scale(1.2) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4) !important;
        }
        
        /* Animaci√≥n de pulso para iconos de anomal√≠as */
        @keyframes anomalyPulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
        }

        /* Responsive para bot√≥n de cerrar */
        @media (max-width: 768px) {
            .close-lupa {
                width: 40px;
                height: 40px;
                font-size: 1.6rem;
            }
            
            .lupa-header h2 {
                font-size: 1.1rem;
            }
            
            .lupa-sidebar {
                width: 100%;
                height: 250px;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
            
            .lupa-body {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Barra superior -->
    <div class="top-bar">
        <h1>üè∫ ArcheoScope - Archaeological Coherence Engine</h1>
        
        <!-- Navegaci√≥n de m√≥dulos -->
        <div class="module-nav" style="display: flex; gap: 15px; margin-left: auto; margin-right: 20px;">
            <a href="volumetric_lidar_viewer.html" class="module-link" style="color: white; text-decoration: none; padding: 8px 15px; background: rgba(255,255,255,0.1); border-radius: 4px; transition: all 0.3s;">
                <i class="fas fa-cube"></i> Volum√©trico LIDAR
            </a>
        </div>
        
        <!-- Indicadores de estado -->
        <div class="system-status">
            <div class="status-indicator status-tooltip" id="backendStatus" data-tooltip="Estado del backend ArcheoScope">
                <div class="status-dot status-offline"></div>
                <span>Backend</span>
            </div>
            <div class="status-indicator status-tooltip" id="aiStatus" data-tooltip="Estado de Ollama/OpenRouter">
                <div class="status-dot status-offline"></div>
                <span>IA</span>
            </div>
            <div class="status-indicator status-tooltip" id="cdnStatus" data-tooltip="Estado de recursos externos (CDNs)">
                <div class="status-dot status-warning"></div>
                <span>CDN</span>
            </div>
            <div class="status-indicator status-tooltip" id="volumetricStatus" data-tooltip="Estado del motor volum√©trico">
                <div class="status-dot status-offline"></div>
                <span>3D</span>
            </div>
        </div>
        
        <div class="region-controls">
            <input type="text" class="coord-search" id="coordSearch" placeholder="41.87230285419031, 12.504327806909155">
            <button class="search-btn" onclick="searchCoordinates()">üîç Buscar</button>
            
            <!-- Bot√≥n de historial de anomal√≠as - discreto pero accesible -->
            <button class="search-btn" onclick="showAnomalyHistory()" style="background-color: #6c757d; margin-right: 0.5rem;" title="Ver historial de anomal√≠as detectadas">
                üìã Historial
            </button>
            
            <input type="number" class="coord-input" id="latMin" placeholder="Lat Min" step="0.0001">
            <input type="number" class="coord-input" id="latMax" placeholder="Lat Max" step="0.0001">
            <input type="number" class="coord-input" id="lonMin" placeholder="Lon Min" step="0.0001">
            <input type="number" class="coord-input" id="lonMax" placeholder="Lon Max" step="0.0001">
            <button class="investigate-btn" onclick="investigateRegion()" id="investigateBtn">INVESTIGAR</button>
        </div>
    </div>

    <!-- Layout principal: CORREGIDO -->
    <div class="main-layout">
        <!-- Panel de controles (izquierda) - LIMPIO Y CORREGIDO -->
        <div class="controls-panel">
            <div class="controls-section">
                <h3>üéØ Selecci√≥n de √Årea</h3>
                <div style="margin-bottom: 1rem;">
                    <button id="selectionModeBtn" onclick="toggleSelectionMode()" style="padding: 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; width: 100%; margin-bottom: 0.5rem;">
                        üéØ MODO SELECCI√ìN: Click
                    </button>
                    <button onclick="clearSelections()" style="padding: 0.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; width: 100%; margin-bottom: 0.5rem;">
                        üßπ LIMPIAR SELECCIONES
                    </button>
                    <div style="font-size: 0.7rem; color: #666; text-align: center; line-height: 1.3;">
                        <strong>Click:</strong> Colocar pin<br>
                        <strong>Arrastrar:</strong> Dibujar √°rea<br>
                        <strong>Ctrl+Click:</strong> Inspeccionar p√≠xel
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>üì° Capas Espectrales</h3>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerAnomalies" checked>
                    <label for="layerAnomalies">Anomal√≠as Espaciales</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerSignatures" checked>
                    <label for="layerSignatures">Firmas Arqueol√≥gicas</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerNatural">
                    <label for="layerNatural">Procesos Naturales</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerVolumetric">
                    <label for="layerVolumetric">Inferencia Volum√©trica</label>
                </div>
            </div>

            <div class="controls-section">
                <h3>‚öñÔ∏è Reglas Arqueol√≥gicas</h3>
                <div class="layer-toggle">
                    <input type="checkbox" id="ruleVegetation" checked>
                    <label for="ruleVegetation">Desacople Vegetaci√≥n-Topograf√≠a</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="ruleThermal" checked>
                    <label for="ruleThermal">Patrones T√©rmicos Residuales</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="ruleGeometricPersistence" checked>
                    <label for="ruleGeometricPersistence">Persistencia Geom√©trica</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="ruleSeasonalNDVI" checked>
                    <label for="ruleSeasonalNDVI">NDVI Diferencial Estacional</label>
                </div>
            </div>

            <div class="controls-section">
                <h3>üéõÔ∏è Configuraci√≥n de An√°lisis</h3>
                <div class="metric-item">
                    <span class="metric-label">Resoluci√≥n:</span>
                    <select id="resolution" style="font-family: inherit; font-size: 0.8rem; width: 100%; padding: 0.25rem;">
                        <option value="10">10m (Sentinel-2 - √ìptimo)</option>
                        <option value="30">30m (Landsat - Bueno)</option>
                        <option value="100">100m (Moderado)</option>
                        <option value="500" selected>500m (Grueso - Demo)</option>
                        <option value="1000">1000m (Muy grueso)</option>
                    </select>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="includeExplainability">
                    <label for="includeExplainability">Incluir Explicabilidad IA</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="includeValidation">
                    <label for="includeValidation">M√©tricas de Validaci√≥n</label>
                </div>
            </div>

            <div class="controls-section">
                <h3>üì¶ Exportaci√≥n</h3>
                
                <!-- NOTA DE TRANSPARENCIA DE DATOS -->
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem;">
                    <strong>‚ö†Ô∏è Transparencia de Datos:</strong><br>
                    ‚Ä¢ <strong>NDVI/T√©rmico</strong>: Datos reales disponibles<br>
                    ‚Ä¢ <strong>LiDAR</strong>: Datos sint√©ticos realistas<br>
                    ‚Ä¢ <strong>DEM</strong>: Resoluci√≥n gruesa (30m)<br>
                    ‚Ä¢ Los porcentajes reflejan potencial arqueol√≥gico basado en datos disponibles
                </div>
                
                <button onclick="exportCompleteAnalysis()" class="export-btn json" style="margin-bottom: 0.5rem;">
                    üìä AN√ÅLISIS COMPLETO (JSON)
                </button>
                <button onclick="exportScientificDataset()" class="export-btn dataset">
                    üî¨ DATASET CIENT√çFICO
                </button>
                <div style="font-size: 0.7rem; color: #666; text-align: center; margin-top: 0.5rem;">
                    Formatos: JSON, KML, GeoTIFF, CSV
                </div>
            </div>

            <div class="controls-section">
                <h3>üßπ Utilidades</h3>
                <button onclick="clearBrowserCache()" style="padding: 0.5rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; width: 100%; margin-bottom: 0.5rem;">
                    üóëÔ∏è LIMPIAR CACH√â
                </button>
                <button onclick="testLupaActivation()" style="padding: 0.5rem; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; width: 100%; margin-bottom: 0.5rem;">
                    üß™ TEST LUPA
                </button>
                <button onclick="testAnomalyDetection()" style="padding: 0.5rem; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; width: 100%; margin-bottom: 0.5rem;">
                    üîç TEST DETECCI√ìN
                </button>

            </div>
        </div>

        <!-- Mapa principal (centro) -->
        <div class="map-container">
            <div id="map">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 4px; font-family: monospace;">
                    üó∫Ô∏è Cargando mapa ArcheoScope...
                </div>
            </div>
            <div class="loading" id="loading">
                üîç Analizando regi√≥n arqueol√≥gica...
            </div>
            
            <!-- Bot√≥n de lupa arqueol√≥gica -->
            <button class="lupa-btn" id="lupaBtn" onclick="openLupaModal()">
                üîç Lupa Arqueol√≥gica
            </button>
        </div>

        <!-- Panel de an√°lisis (derecha) - TODO el an√°lisis -->
        <div class="analysis-panel">
            <h3>üîç Inspecci√≥n de P√≠xel</h3>
            
            <div class="inspection-section" id="pixelInfo">
                <div class="pixel-coords" id="pixelCoords">Haz clic en el mapa para inspeccionar</div>
                
                <div class="data-values" id="dataValues">
                    <div class="data-value">
                        <span class="data-label">NDVI Vegetaci√≥n:</span>
                        <span class="data-number" id="ndviValue">--</span>
                    </div>
                    <div class="data-value">
                        <span class="data-label">T√©rmica LST:</span>
                        <span class="data-number" id="thermalValue">--</span>
                    </div>
                    <div class="data-value">
                        <span class="data-label">SAR Backscatter:</span>
                        <span class="data-number" id="sarValue">--</span>
                    </div>
                    <div class="data-value">
                        <span class="data-label">Rugosidad:</span>
                        <span class="data-number" id="roughnessValue">--</span>
                    </div>
                    <div class="data-value">
                        <span class="data-label">Salinidad:</span>
                        <span class="data-number" id="salinityValue">--</span>
                    </div>
                    <div class="data-value">
                        <span class="data-label">Resonancia:</span>
                        <span class="data-number" id="resonanceValue">--</span>
                    </div>
                </div>

                <div class="rules-evaluation" id="rulesEvaluation">
                    <div class="rule-item rule-pass">
                        <span class="rule-name">Desacople Vegetaci√≥n-Topograf√≠a</span>
                        <span class="rule-status">PASS</span>
                    </div>
                    <div class="rule-item rule-fail">
                        <span class="rule-name">Patrones T√©rmicos Residuales</span>
                        <span class="rule-status">FAIL*</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #6c757d; margin-top: 0.5rem; font-style: italic;">
                        *La ausencia de se√±al t√©rmica residual es compatible con estructuras lineales compactadas de baja masa volum√©trica
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>üìà Resultados del An√°lisis</h3>
                <div class="metric-item">
                    <span class="metric-label">√Årea Total:</span>
                    <span class="metric-value" id="totalArea">No calculada</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Anomal√≠as Detectadas:</span>
                    <span class="metric-value" id="anomaliesCount">No evaluadas</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Volumen Total Estimado:</span>
                    <span class="metric-value" id="totalVolume">No aplicable</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Confianza del Motor:</span>
                    <span class="metric-value" id="engineConfidence">No determinada</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Confianza Interpretativa:</span>
                    <span class="metric-value" id="interpretativeConfidence">No evaluada</span>
                </div>
            </div>

            <div class="anomaly-details">
                <h4>üéØ An√°lisis de Anomal√≠as Espaciales</h4>
                <div class="metric-item">
                    <span class="metric-label">Tipo de Anomal√≠a:</span>
                    <span class="metric-value" id="anomalyType">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Intensidad de Se√±al:</span>
                    <span class="metric-value" id="anomalyIntensity">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Extensi√≥n Espacial:</span>
                    <span class="metric-value" id="anomalyArea">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Coherencia M√©trica:</span>
                    <span class="metric-value" id="metricCoherence">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Coherencia Geom√©trica:</span>
                    <span class="metric-value" id="geometricCoherence">--</span>
                </div>
            </div>

            <div class="archaeological-data">
                <h4>üìä An√°lisis Arqueol√≥gico</h4>
                <div class="metric-item">
                    <span class="metric-label">Compatibilidad:</span>
                    <span class="metric-value" id="archaeoProb">No evaluado</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Tipo de Paisaje:</span>
                    <span class="metric-value" id="landscapeType">No determinado</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Coherencia Geom√©trica:</span>
                    <span class="metric-value" id="geomCoherence">No evaluada</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Clasificaci√≥n Espectral:</span>
                    <span class="metric-value" id="spectralSignature">No aplicable</span>
                </div>
            </div>

            <div class="controls-section">
                <h3>üî¨ Diagn√≥stico Cient√≠fico de Datos</h3>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; border-left: 3px solid #6c757d; font-size: 0.8rem; line-height: 1.5; margin-bottom: 0.5rem;">
                    <div id="dataDiagnostic">
                        <strong>Estado:</strong> Esperando an√°lisis...<br><br>
                        ‚ñ∏ El sistema evaluar√° la calidad y completitud de los datos disponibles
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>üéØ M√©todo Recomendado</h3>
                <div style="background: #e8f4fd; padding: 1rem; border-radius: 4px; border-left: 3px solid #2196F3; font-size: 0.8rem; line-height: 1.5; margin-bottom: 0.5rem;">
                    <div id="recommendedMethod">
                        <strong>Prioridad:</strong> No determinada<br><br>
                        ‚ñ∏ Esperando an√°lisis...
                    </div>
                </div>
            </div>

            <div class="inference-system">
                <h4>üèóÔ∏è Sistema de Inferencia Volum√©trica</h4>
                <div class="metric-item">
                    <span class="metric-label">Estado del Motor:</span>
                    <span class="metric-value" id="inferenceStatus">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Nivel de Reconstrucci√≥n:</span>
                    <span class="metric-value" id="inferenceStage">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Progreso:</span>
                    <span class="metric-value" id="inferenceProgress">--</span>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="inferenceProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="volumetric-info">
                <h4>üé≤ Modelo Volum√©trico (Nivel I)</h4>
                <div class="metric-item">
                    <span class="metric-label">Volumen Estimado:</span>
                    <span class="metric-value" id="estimatedVolume">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Rango de Altura:</span>
                    <span class="metric-value" id="maxHeight">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Interpretaci√≥n F√≠sica:</span>
                    <span class="metric-value" id="morphologyClass">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Nivel de Inferencia:</span>
                    <span class="metric-value" id="volumetricConfidence">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">V√©rtices:</span>
                    <span class="metric-value" id="modelVertices">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Caras:</span>
                    <span class="metric-value" id="modelFaces">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Resoluci√≥n Efectiva:</span>
                    <span class="metric-value" id="spatialResolution">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Incertidumbre Espacial:</span>
                    <span class="metric-value" id="spatialUncertainty">--</span>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="volumetricConfidenceBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="controls-section">
                <h3>üìã Interpretaci√≥n Sint√©tica</h3>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; border-left: 3px solid #8B4513; font-size: 0.8rem; line-height: 1.5; margin-bottom: 0.5rem;">
                    <div id="syntheticInterpretation">
                        Esperando an√°lisis...
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>‚ö†Ô∏è Limitaciones del An√°lisis</h3>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Firmas Arqueol√≥gicas Confirmadas:</span>
                    <span class="metric-value" id="signaturesCount">--</span>
                </div>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Resoluci√≥n de An√°lisis:</span>
                    <span class="metric-value" id="analysisResolution">--</span>
                </div>
            </div>

            <div class="controls-section">
                <h3>üé≤ Inferencia Volum√©trica</h3>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Estado del Motor:</span>
                    <span class="metric-value" id="volumetricEngineStatus">Inactivo</span>
                </div>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Modelos Generados:</span>
                    <span class="metric-value" id="modelsGenerated">0</span>
                </div>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Clases Morfol√≥gicas:</span>
                    <span class="metric-value" id="morphologyClasses">--</span>
                </div>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Precisi√≥n Geom√©trica:</span>
                    <span class="metric-value" id="geometricPrecision">--</span>
                </div>
                <div class="metric-item" style="margin-bottom: 0.75rem;">
                    <span class="metric-label">Campo Probabil√≠stico:</span>
                    <span class="metric-value" id="probabilisticField">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de lupa arqueol√≥gica -->
    <div class="lupa-modal" id="lupaModal">
        <div class="lupa-content">
            <div class="lupa-header">
                <h2>üîç Lupa Arqueol√≥gica Multi-Sensor</h2>
                <button class="close-lupa" onclick="closeLupaModal()" title="Cerrar">&times;</button>
            </div>
            <div class="lupa-body">
                <div class="lupa-map-container">
                    <div id="lupaMap"></div>
                    
                    <!-- Controles de capas -->
                    <div class="lupa-layer-controls">
                        <h4>üóÇÔ∏è Capas Arqueol√≥gicas</h4>
                        <div class="layer-control-item">
                            <span>üì° √ìptico (NDVI)</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('optical')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>üå°Ô∏è T√©rmico (LST)</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('thermal')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>üìä SAR</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('sar')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>üèîÔ∏è DEM</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('dem')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>üì° LiDAR Full-Wave</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('lidar_fullwave')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>üó∫Ô∏è DEM Multiescala</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('dem_multiscale')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>üåä Rugosidad Espectral</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('spectral_roughness')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>ü§ñ Pseudo-LiDAR IA</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('pseudo_lidar_ai')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="layer-control-item">
                            <span>‚è≥ Multitemporal</span>
                            <label class="layer-toggle">
                                <input type="checkbox" checked onchange="toggleLupaLayer('multitemporal_topo')">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="lupa-sidebar">
                    <!-- SECCIONES EDUCATIVAS PRIMERO - M√ÅS VISIBLES -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 8px; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 1rem; font-size: 1rem; font-weight: bold;">
                            üî¨ ¬øQu√© Detectamos?
                        </h4>
                        <div style="font-size: 0.85rem; line-height: 1.5; color: #856404;">
                            <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong>üìè Lineales:</strong> Calzadas, muros, canales
                            </div>
                            <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong>‚≠ï Circulares:</strong> Plazas, fosos, t√∫mulos
                            </div>
                            <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong>üî≤ Rectangulares:</strong> Edificios, terrazas, campos
                            </div>
                            <div style="margin-bottom: 0.8rem; padding: 0.5rem; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong>üèõÔ∏è Complejas:</strong> Ciudades, sistemas hidr√°ulicos
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #e8f4fd 0%, #bee5eb 100%); border-radius: 8px; border: 2px solid #17a2b8;">
                        <h4 style="color: #0c5460; margin-bottom: 1rem; font-size: 1rem; font-weight: bold;">
                            ü§ñ ¬øPor Qu√© Funciona?
                        </h4>
                        <div style="font-size: 0.85rem; line-height: 1.5; color: #0c5460;">
                            <p style="margin-bottom: 0.8rem;"><strong>Los humanos antiguos alteraron el paisaje geom√©tricamente:</strong></p>
                            <div style="margin-left: 1rem; margin-bottom: 0.8rem;">
                                <div>üî≤ Construyeron en <strong>l√≠neas rectas</strong></div>
                                <div>‚≠ï Hicieron <strong>c√≠rculos perfectos</strong></div>
                                <div>üîÑ Crearon <strong>patrones repetitivos</strong></div>
                            </div>
                            <div style="background: rgba(255,255,255,0.8); padding: 0.5rem; border-radius: 4px; font-style: italic; text-align: center;">
                                <strong>La naturaleza NO hace eso.</strong><br>
                                Geometr√≠a + Persistencia = Arqueolog√≠a
                            </div>
                        </div>
                    </div>

                    <!-- NUEVA SECCI√ìN: Visualizaci√≥n de Anomal√≠as -->
                    <div id="anomalyVisualizationSection" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-radius: 8px; border: 2px solid #dc3545; display: none;">
                        <h4 style="color: #721c24; margin-bottom: 1rem; font-size: 1rem; font-weight: bold;">
                            üé® Visualizaci√≥n de Anomal√≠as Detectadas
                        </h4>
                        <div id="anomalyImageContainer" style="text-align: center;">
                            <!-- Aqu√≠ se generar√°n las im√°genes -->
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <button onclick="generateAnomalyImage2D()" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 0.8rem;">
                                üñºÔ∏è Vista 2D (Sonar)
                            </button>
                            <button onclick="openProfessional3DViewer()" style="padding: 8px 15px; background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 0.8rem; font-weight: 600;">
                                üéÆ Visor 3D Profesional
                            </button>
                        </div>
                        <div id="anomalySelector" style="margin-top: 10px;">
                            <!-- Selector de anomal√≠as se llenar√° din√°micamente -->
                        </div>
                    </div>

                    <h3 style="margin-bottom: 1rem; color: #8B4513;">üõ∞Ô∏è An√°lisis por Instrumento</h3>
                    
                    <div id="instrumentAnalysis">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
            onerror="handleLeafletError()"></script>
    
    <!-- Three.js para visualizaci√≥n 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
            onerror="handleThreeJSError()"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
            onerror="handleOrbitControlsError()"></script>
    
    <!-- Leaflet Image para exportar mapas -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-image@0.4.0/leaflet-image.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
            onerror="handleLeafletImageError()"></script>
    
    <!-- Sistema de historial de anomal√≠as -->
    <script src="anomaly_history_system.js"></script>
    
    <!-- Generador de im√°genes de anomal√≠as -->
    <script src="anomaly_image_generator.js"></script>
    
    <!-- Visor 3D Profesional (integrado en anomaly_image_generator.js) -->
    <!-- professional_3d_viewer.js functionality merged into anomaly_image_generator.js -->
    
    <!-- Fallback y script principal -->
    <script>
        // Visor 3D Profesional integrado - no requiere carga separada
        // Definir OrbitControls si no est√° disponible
        if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
            THREE.OrbitControls = function(camera, domElement) {
                this.camera = camera;
                this.domElement = domElement;
                this.enableDamping = true;
                this.dampingFactor = 0.05;
                
                // Implementaci√≥n b√°sica de controles
                let isMouseDown = false;
                let mouseX = 0, mouseY = 0;
                
                domElement.addEventListener('mousedown', (e) => {
                    isMouseDown = true;
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                
                domElement.addEventListener('mousemove', (e) => {
                    if (!isMouseDown) return;
                    
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    // Rotar c√°mara
                    const spherical = new THREE.Spherical();
                    spherical.setFromVector3(camera.position);
                    spherical.theta -= deltaX * 0.01;
                    spherical.phi += deltaY * 0.01;
                    spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                    
                    camera.position.setFromSpherical(spherical);
                    camera.lookAt(0, 0, 0);
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                
                document.addEventListener('mouseup', () => {
                    isMouseDown = false;
                });
                
                domElement.addEventListener('wheel', (e) => {
                    const scale = e.deltaY > 0 ? 1.1 : 0.9;
                    camera.position.multiplyScalar(scale);
                });
            };
        }
        
        function handleLeafletError() {
            console.error('‚ùå Error cargando Leaflet desde CDN');
            initializeSimpleMap();
        }
        
        function handleThreeJSError() {
            console.error('‚ùå Error cargando Three.js desde CDN');
            console.warn('‚ö†Ô∏è Visualizaci√≥n 3D no disponible');
            // Deshabilitar funciones 3D
            const buttons3D = document.querySelectorAll('[onclick*="3D"]');
            buttons3D.forEach(btn => {
                btn.disabled = true;
                btn.title = 'Three.js no disponible';
                btn.style.opacity = '0.5';
            });
        }
        
        function handleOrbitControlsError() {
            console.error('‚ùå Error cargando OrbitControls desde CDN');
            console.warn('‚ö†Ô∏è Controles 3D limitados');
        }
        
        function handleLeafletImageError() {
            console.error('‚ùå Error cargando Leaflet-Image desde CDN');
            console.warn('‚ö†Ô∏è Exportaci√≥n de im√°genes no disponible');
            // Deshabilitar botones de exportaci√≥n de im√°genes
            const exportButtons = document.querySelectorAll('[onclick*="exportMap"]');
            exportButtons.forEach(btn => {
                btn.disabled = true;
                btn.title = 'Exportaci√≥n de im√°genes no disponible';
                btn.style.opacity = '0.5';
            });
        }
        
        // Funci√≥n para verificar estado de CDNs
        function checkCDNStatus() {
            let cdnStatus = 'online';
            let cdnTooltip = 'Todos los recursos externos cargados correctamente';
            
            // Verificar Leaflet
            if (typeof L === 'undefined') {
                cdnStatus = 'warning';
                cdnTooltip = 'Leaflet no disponible - Funcionalidad de mapas limitada';
            }
            
            // Verificar Three.js
            if (typeof THREE === 'undefined') {
                cdnStatus = 'warning';
                cdnTooltip = 'Three.js no disponible - Visualizaci√≥n 3D deshabilitada';
            }
            
            // Actualizar indicador
            updateStatusIndicator('cdnStatus', cdnStatus, cdnTooltip);
        }
        
        // Verificar CDNs despu√©s de cargar
        setTimeout(checkCDNStatus, 2000);
        
        function initializeSimpleMap() {
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255,255,255,0.9); padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #8B4513; margin-bottom: 1rem;">üó∫Ô∏è Mapa ArcheoScope</h3>
                        <p style="margin-bottom: 1rem;">Modo sin conexi√≥n - Funcionalidad b√°sica disponible</p>
                        <div style="width: 400px; height: 300px; background: linear-gradient(45deg, #e8f5e8 25%, transparent 25%), linear-gradient(-45deg, #e8f5e8 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e8f5e8 75%), linear-gradient(-45deg, transparent 75%, #e8f5e8 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; border: 2px solid #8B4513; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #8B4513; font-weight: bold;">
                            Regi√≥n: Via Appia, Roma<br>
                            41.8550¬∞N, 12.5150¬∞E
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                            Las funciones de an√°lisis arqueol√≥gico est√°n disponibles
                        </p>
                    </div>
                `;
            }
        }
        
        setTimeout(function() {
            if (typeof L === 'undefined') {
                console.warn('‚ö†Ô∏è Leaflet no disponible, usando mapa alternativo');
                handleLeafletError();
            }
        }, 3000);
    </script>
    
    <script src="archaeological_app.js"></script>
    
    <!-- TIMESTAMP: 2026-01-23 15:30:00 - VISOR 3D PROFESIONAL INTEGRADO -->
    
    <script>
        // Variables globales para lupa arqueol√≥gica y selecci√≥n interactiva
        let lupaMap;
        let currentAnalysisData = null;
        let selectedCoordinates = null;
        let archaeoLayers = {};
        
        // Variables para selecci√≥n interactiva
        let selectionMode = 'click'; // 'click', 'area', 'multi'
        let isDrawing = false;
        let selectionMarkers = [];
        let selectionAreas = [];
        let currentSelectionArea = null;

        // SISTEMA DE VALIDACI√ìN CIENT√çFICA
        function validateDetections(coordinates, analysisData) {
            console.log('üî¨ ===== INICIANDO VALIDACI√ìN CIENT√çFICA =====');
            
            const lat = coordinates.lat;
            const lng = coordinates.lng;
            
            // 1. VALIDACI√ìN GEOGR√ÅFICA
            const geoValidation = validateGeographicContext(lat, lng);
            
            // 2. VALIDACI√ìN T√âCNICA
            const techValidation = validateTechnicalCoherence(analysisData);
            
            // 3. VALIDACI√ìN HIST√ìRICA
            const histValidation = validateHistoricalContext(lat, lng);
            
            // 4. C√ÅLCULO DE CONFIANZA GENERAL
            const overallConfidence = calculateOverallConfidence(geoValidation, techValidation, histValidation);
            
            const validationReport = {
                coordinates: { lat, lng },
                geographic: geoValidation,
                technical: techValidation,
                historical: histValidation,
                overallConfidence: overallConfidence,
                recommendations: generateRecommendations(lat, lng, overallConfidence)
            };
            
            console.log('üìä REPORTE DE VALIDACI√ìN:', validationReport);
            displayValidationReport(validationReport);
            
            return validationReport;
        }

        function validateGeographicContext(lat, lng) {
            console.log(`üåç Validando contexto geogr√°fico: ${lat}, ${lng}`);
            
            // Identificar regi√≥n geogr√°fica basada en coordenadas del usuario
            let region = 'Regi√≥n Seleccionada';
            let plausibility = 'Media';
            let context = '';
            
            // Mediterr√°neo (Roma, Grecia)
            if (lat >= 35.0 && lat <= 45.0 && lng >= 10.0 && lng <= 25.0) {
                region = 'Mediterr√°neo (Roma/Grecia)';
                plausibility = 'Muy Alta';
                context = 'Regi√≥n con densidad arqueol√≥gica extremadamente alta. Civilizaciones romana, griega y prehist√≥ricas bien documentadas.';
            }
            // Mesoam√©rica
            else if (lat >= 14.0 && lat <= 32.0 && lng >= -118.0 && lng <= -86.0) {
                region = 'Mesoam√©rica';
                plausibility = 'Muy Alta';
                context = 'Regi√≥n con civilizaciones maya, azteca, olmeca. Alta probabilidad de sitios arqueol√≥gicos no descubiertos.';
            }
            // Amazon√≠a
            else if (lat >= -10.0 && lat <= 5.0 && lng >= -75.0 && lng <= -50.0) {
                region = 'Amazon√≠a';
                plausibility = 'Alta';
                context = 'Regi√≥n con creciente evidencia de civilizaciones precolombinas complejas. LiDAR ha revelado estructuras masivas.';
            }
            // Oc√©anos
            else if ((lat >= -90 && lat <= 90) && (lng >= -180 && lng <= 180)) {
                if (Math.abs(lat) < 60) { // No polar
                    region = 'Oc√©ano/Zona Marina';
                    plausibility = 'Baja-Media';
                    context = 'Posibles estructuras sumergidas, puertos antiguos, o artefactos en zona costera. Requiere validaci√≥n adicional.';
                } else {
                    region = 'Zona Polar';
                    plausibility = 'Muy Baja';
                    context = 'Regi√≥n con baja probabilidad de asentamientos humanos antiguos debido a condiciones clim√°ticas extremas.';
                }
            }
            
            return {
                region,
                plausibility,
                context,
                score: plausibility === 'Muy Alta' ? 0.9 : 
                       plausibility === 'Alta' ? 0.7 : 
                       plausibility === 'Media' ? 0.5 : 
                       plausibility === 'Baja-Media' ? 0.3 : 0.1
            };
        }

        function validateTechnicalCoherence(analysisData) {
            console.log('üîß Validando coherencia t√©cnica...');
            
            if (!analysisData || !analysisData.statistical_results) {
                return { coherent: false, score: 0, issues: ['No hay datos de an√°lisis'] };
            }
            
            const stats = analysisData.statistical_results;
            const probabilities = Object.values(stats).map(s => s.archaeological_probability || 0);
            
            const issues = [];
            let score = 1.0;
            
            // Verificar rango de probabilidades
            const minProb = Math.min(...probabilities);
            const maxProb = Math.max(...probabilities);
            const avgProb = probabilities.reduce((a, b) => a + b, 0) / probabilities.length;
            
            if (maxProb > 0.95) {
                issues.push('Probabilidad sospechosamente alta (>95%)');
                score -= 0.2;
            }
            
            if (minProb < 0 || maxProb > 1) {
                issues.push('Probabilidades fuera de rango v√°lido [0,1]');
                score -= 0.3;
            }
            
            // Verificar coherencia entre sensores
            const variance = probabilities.reduce((acc, p) => acc + Math.pow(p - avgProb, 2), 0) / probabilities.length;
            if (variance > 0.1) {
                issues.push('Alta varianza entre sensores (posible inconsistencia)');
                score -= 0.1;
            }
            
            // Verificar n√∫mero de instrumentos
            if (probabilities.length < 5) {
                issues.push('Pocos instrumentos para validaci√≥n cruzada');
                score -= 0.1;
            }
            
            return {
                coherent: issues.length === 0,
                score: Math.max(0, score),
                issues,
                statistics: {
                    instruments: probabilities.length,
                    avgProbability: avgProb,
                    variance: variance,
                    range: [minProb, maxProb]
                }
            };
        }

        function validateHistoricalContext(lat, lng) {
            console.log('üìö Validando contexto hist√≥rico...');
            
            // Base de datos simplificada de sitios arqueol√≥gicos conocidos - SIN COORDENADAS HARDCODEADAS
            const knownSites = [
                { name: 'Regi√≥n Mediterr√°nea', latMin: 35.0, latMax: 45.0, lngMin: 10.0, lngMax: 25.0, period: 'Romano/Griego' },
                { name: 'Mesoam√©rica', latMin: 14.0, latMax: 32.0, lngMin: -118.0, lngMax: -86.0, period: 'Maya/Azteca' },
                { name: 'Amazon√≠a', latMin: -10.0, latMax: 5.0, lngMin: -75.0, lngMax: -50.0, period: 'Precolombino' },
                { name: 'Atl√°ntico Norte', latMin: 30.0, latMax: 35.0, lngMin: -70.0, lngMax: -60.0, period: 'Colonial' }
            ];
            
            let nearestRegion = null;
            let isInKnownRegion = false;
            
            knownSites.forEach(region => {
                if (lat >= region.latMin && lat <= region.latMax && 
                    lng >= region.lngMin && lng <= region.lngMax) {
                    nearestRegion = region;
                    isInKnownRegion = true;
                }
            });
            
            return {
                nearKnownSite: isInKnownRegion,
                nearestSite: nearestRegion,
                distanceKm: isInKnownRegion ? 0 : 999,
                score: isInKnownRegion ? 0.8 : 0.3
            };
        }

        function calculateOverallConfidence(geoVal, techVal, histVal) {
            // Pesos para cada tipo de validaci√≥n
            const weights = {
                geographic: 0.3,
                technical: 0.4,
                historical: 0.3
            };
            
            const weightedScore = 
                (geoVal.score * weights.geographic) +
                (techVal.score * weights.technical) +
                (histVal.score * weights.historical);
            
            let confidenceLevel = 'Muy Baja';
            let color = '#dc3545';
            
            if (weightedScore >= 0.8) {
                confidenceLevel = 'Muy Alta';
                color = '#28a745';
            } else if (weightedScore >= 0.6) {
                confidenceLevel = 'Alta';
                color = '#ffc107';
            } else if (weightedScore >= 0.4) {
                confidenceLevel = 'Media';
                color = '#fd7e14';
            } else if (weightedScore >= 0.2) {
                confidenceLevel = 'Baja';
                color = '#dc3545';
            }
            
            return {
                score: weightedScore,
                level: confidenceLevel,
                color: color,
                percentage: Math.round(weightedScore * 100)
            };
        }

        function generateRecommendations(lat, lng, confidence) {
            const recommendations = [];
            
            if (confidence.score >= 0.7) {
                recommendations.push('‚úÖ Detecciones altamente confiables - Proceder con an√°lisis detallado');
                recommendations.push('üìã Documentar hallazgos para validaci√≥n por expertos');
            } else if (confidence.score >= 0.4) {
                recommendations.push('‚ö†Ô∏è Validaci√≥n adicional recomendada');
                recommendations.push('üîç Comparar con mapas hist√≥ricos y bases de datos arqueol√≥gicas');
                recommendations.push('üìû Consultar con expertos locales en arqueolog√≠a');
            } else {
                recommendations.push('üö® Baja confianza - Verificar posibles falsos positivos');
                recommendations.push('üîß Revisar par√°metros de an√°lisis y calidad de datos');
                recommendations.push('üìä Considerar an√°lisis con mayor resoluci√≥n');
            }
            
            // Recomendaciones generales basadas en regi√≥n detectada
            if (lat >= 35.0 && lat <= 45.0 && lng >= 10.0 && lng <= 25.0) {
                recommendations.push('üèõÔ∏è Mediterr√°neo: Consultar bases de datos arqueol√≥gicas regionales');
                recommendations.push('üìö Revisar registros de excavaciones previas');
                recommendations.push('üó∫Ô∏è Comparar con mapas hist√≥ricos romanos/griegos');
            }
            
            return recommendations;
        }

        function displayValidationReport(report) {
            console.log('üìã Mostrando reporte de validaci√≥n...');
            
            // Crear mensaje de validaci√≥n para mostrar al usuario
            const validationMessage = `
                üî¨ VALIDACI√ìN CIENT√çFICA COMPLETADA
                
                üìç Ubicaci√≥n: ${report.geographic.region}
                üéØ Confianza General: ${report.overallConfidence.level} (${report.overallConfidence.percentage}%)
                
                üìä Detalles:
                ‚Ä¢ Geogr√°fica: ${(report.geographic.score * 100).toFixed(0)}%
                ‚Ä¢ T√©cnica: ${(report.technical.score * 100).toFixed(0)}%
                ‚Ä¢ Hist√≥rica: ${(report.historical.score * 100).toFixed(0)}%
                
                ${report.recommendations.slice(0, 2).join('\n')}
            `;
            
            showMessage(validationMessage, 'success');
            
            // Actualizar panel de an√°lisis con informaci√≥n de validaci√≥n
            updateValidationDisplay(report);
        }

        function updateValidationDisplay(report) {
            // Buscar o crear secci√≥n de validaci√≥n en el panel de an√°lisis
            let validationSection = document.getElementById('validationSection');
            
            if (!validationSection) {
                // Crear secci√≥n de validaci√≥n
                const analysisPanel = document.querySelector('.analysis-panel');
                if (analysisPanel) {
                    validationSection = document.createElement('div');
                    validationSection.id = 'validationSection';
                    validationSection.className = 'controls-section';
                    validationSection.innerHTML = `
                        <h3>üî¨ Validaci√≥n Cient√≠fica</h3>
                        <div id="validationContent"></div>
                    `;
                    analysisPanel.insertBefore(validationSection, analysisPanel.firstChild);
                }
            }
            
            const validationContent = document.getElementById('validationContent');
            if (validationContent) {
                validationContent.innerHTML = `
                    <div style="background: ${report.overallConfidence.color}20; padding: 1rem; border-radius: 4px; border-left: 3px solid ${report.overallConfidence.color}; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: ${report.overallConfidence.color}; margin-bottom: 0.5rem;">
                            Confianza: ${report.overallConfidence.level} (${report.overallConfidence.percentage}%)
                        </div>
                        <div style="font-size: 0.8rem; line-height: 1.4;">
                            <strong>üìç Regi√≥n:</strong> ${report.geographic.region}<br>
                            <strong>üîß Coherencia T√©cnica:</strong> ${(report.technical.score * 100).toFixed(0)}%<br>
                            <strong>üìö Contexto Hist√≥rico:</strong> ${(report.historical.score * 100).toFixed(0)}%<br>
                            ${report.historical.nearKnownSite ? 
                                `<strong>üèõÔ∏è Sitio Cercano:</strong> ${report.historical.nearestSite.name} (${report.historical.distanceKm.toFixed(1)}km)` : 
                                `<strong>üìè Distancia a Sitio Conocido:</strong> ${report.historical.distanceKm.toFixed(1)}km`
                            }
                        </div>
                    </div>
                `;
            }
        }

        // FUNCI√ìN DE TEST: Probar detecci√≥n de anomal√≠as con datos realistas
        function testAnomalyDetection() {
            console.log('üß™ ===== TEST DE DETECCI√ìN DE ANOMAL√çAS =====');
            
            // Crear datos de prueba con diferentes escenarios
            const testScenarios = [
                {
                    name: 'Solo Lineales (SAR alto)',
                    data: {
                        statistical_results: {
                            sar_backscatter: { archaeological_probability: 0.45 },
                            surface_roughness: { archaeological_probability: 0.38 },
                            ndvi_vegetation: { archaeological_probability: 0.15 },
                            thermal_lst: { archaeological_probability: 0.12 },
                            elevation_dem: { archaeological_probability: 0.18 }
                        }
                    }
                },
                {
                    name: 'Solo Circulares (DEM alto)',
                    data: {
                        statistical_results: {
                            elevation_dem: { archaeological_probability: 0.42 },
                            thermal_lst: { archaeological_probability: 0.35 },
                            sar_backscatter: { archaeological_probability: 0.18 },
                            ndvi_vegetation: { archaeological_probability: 0.20 }
                        }
                    }
                },
                {
                    name: 'Sin anomal√≠as espec√≠ficas',
                    data: {
                        statistical_results: {
                            sar_backscatter: { archaeological_probability: 0.25 },
                            surface_roughness: { archaeological_probability: 0.22 },
                            ndvi_vegetation: { archaeological_probability: 0.18 },
                            thermal_lst: { archaeological_probability: 0.20 },
                            elevation_dem: { archaeological_probability: 0.15 }
                        }
                    }
                },
                {
                    name: 'M√∫ltiples tipos (Complejo)',
                    data: {
                        statistical_results: {
                            sar_backscatter: { archaeological_probability: 0.40 },
                            elevation_dem: { archaeological_probability: 0.38 },
                            ndvi_vegetation: { archaeological_probability: 0.35 },
                            thermal_lst: { archaeological_probability: 0.42 },
                            lidar_fullwave: { archaeological_probability: 0.45 }
                        }
                    }
                }
            ];
            
            testScenarios.forEach((scenario, index) => {
                console.log(`\nüß™ ESCENARIO ${index + 1}: ${scenario.name}`);
                const detectedAnomalies = detectAnomalyTypes(scenario.data);
                console.log(`üìä Resultado: ${detectedAnomalies.length} tipos detectados`);
                detectedAnomalies.forEach(anomaly => {
                    console.log(`   ${anomaly.icon} ${anomaly.name} - ${(anomaly.confidence * 100).toFixed(1)}%`);
                });
            });
            
            showMessage('üß™ Test de detecci√≥n completado - Ver consola para resultados detallados', 'success');
        }

        // FUNCI√ìN DE TEST: Forzar activaci√≥n de lupa para debugging - CORREGIDA
        function testLupaActivation() {
            console.log('üß™ TEST: Forzando activaci√≥n de lupa...');
            
            const lupaBtn = document.getElementById('lupaBtn');
            console.log('üîç Bot√≥n encontrado:', lupaBtn);
            
            if (lupaBtn) {
                // NO crear datos falsos - usar datos reales si existen
                if (currentAnalysisData && currentAnalysisData.statistical_results) {
                    console.log('‚úÖ Usando datos reales existentes para test');
                    
                    // Calcular probabilidad real
                    const stats = currentAnalysisData.statistical_results;
                    const probabilities = Object.values(stats).map(s => s.archaeological_probability || 0);
                    const realAvgProbability = probabilities.length > 0 ? 
                        probabilities.reduce((a, b) => a + b, 0) / probabilities.length : 0;
                    
                    lupaBtn.classList.add('active');
                    lupaBtn.style.display = 'block';
                    lupaBtn.innerHTML = `üîç Lupa Arqueol√≥gica (${(realAvgProbability * 100).toFixed(1)}%)`;
                    
                    showMessage(`üß™ TEST: Lupa activada con datos REALES (${(realAvgProbability * 100).toFixed(1)}%)`, 'success');
                } else {
                    console.log('‚ö†Ô∏è No hay datos reales - creando datos m√≠nimos para test visual');
                    
                    // Solo para test visual - datos m√≠nimos
                    lupaBtn.classList.add('active');
                    lupaBtn.style.display = 'block';
                    lupaBtn.innerHTML = 'üîç Lupa Arqueol√≥gica (TEST)';
                    
                    // Crear datos m√≠nimos solo para que la lupa se abra
                    currentAnalysisData = {
                        statistical_results: {
                            test_visual: { archaeological_probability: 0.25 }
                        }
                    };
                    
                    showMessage('üß™ TEST: Lupa activada (datos m√≠nimos para test visual)', 'success');
                }
                
                console.log('‚úÖ Lupa activada para test');
            } else {
                console.error('‚ùå No se pudo encontrar el bot√≥n de lupa');
            }
        }

        // FUNCI√ìN MEJORADA: Verificar anomal√≠as y mostrar bot√≥n de lupa
        function checkForAnomalies(analysisResults, temporalValidation = null) {
            console.log('üîç ===== INICIO VERIFICACI√ìN DE ANOMAL√çAS =====');
            console.log('üìä Datos recibidos:', analysisResults);
            console.log('‚è≥ Validaci√≥n temporal:', temporalValidation);
            
            if (!analysisResults) {
                console.error('‚ùå analysisResults es null o undefined');
                return;
            }
            
            if (!analysisResults.statistical_results) {
                console.error('‚ùå No hay statistical_results en analysisResults');
                console.log('üìã Estructura disponible:', Object.keys(analysisResults));
                return;
            }
            
            const stats = analysisResults.statistical_results;
            console.log('üìà Statistical results:', stats);
            
            // SENSOR TEMPORAL OBLIGATORIO: Verificar validaci√≥n temporal
            let temporalMessage = '';
            let temporallyValidatedCandidates = 0;
            
            if (temporalValidation) {
                temporalMessage = temporalValidation.message;
                
                if (temporalValidation.validationStatus === 'CONFIRMADO') {
                    temporallyValidatedCandidates = temporalValidation.anomaliesConfirmed.length;
                    console.log(`‚úÖ Sensor temporal CONFIRMA ${temporallyValidatedCandidates} anomal√≠as`);
                } else if (temporalValidation.validationStatus === 'SIN_DATOS') {
                    console.warn('üö® SENSOR TEMPORAL SIN DATOS - Anomal√≠as no confirmadas');
                } else if (temporalValidation.validationStatus === 'RECHAZADO') {
                    console.warn('‚ùå SENSOR TEMPORAL RECHAZA anomal√≠as - Probablemente naturales');
                }
            } else {
                console.warn('‚ö†Ô∏è No hay validaci√≥n temporal disponible');
                temporalMessage = '‚ö†Ô∏è Sensor temporal no disponible - Anomal√≠as sin validar temporalmente';
            }
            
            // NUEVA L√ìGICA: Manejar estructura real del backend
            let shouldActivateLupa = false;
            let activationReason = '';
            let simulatedProbability = 0;
            
            // Verificar candidatos a naufragios (estructura real del backend)
            const wreckCandidates = stats.wreck_candidates || 0;
            const totalAnomalies = stats.total_anomalies || 0;
            const highPriority = stats.high_priority_targets || 0;
            
            console.log(`üö¢ Candidatos a naufragios: ${wreckCandidates}`);
            console.log(`üéØ Total anomal√≠as: ${totalAnomalies}`);
            console.log(`‚≠ê Objetivos de alta prioridad: ${highPriority}`);
            
            // ‚úÖ CORREGIDO: NUNCA BLOQUEAR EL AN√ÅLISIS POR FALTA DE DATOS TEMPORALES
            // Siempre proceder con los datos disponibles, informar qu√© se us√≥
            if (wreckCandidates > 0) {
                // ‚úÖ SIEMPRE ACTIVAR SI HAY CANDIDATOS (sin importar validaci√≥n temporal)
                shouldActivateLupa = true;
                simulatedProbability = Math.min(0.8, 0.3 + (wreckCandidates * 0.1));
                
                // Informar qu√© m√©todos se usaron (sin bloquear)
                if (temporalValidation && temporalValidation.validationStatus === 'CONFIRMADO') {
                    simulatedProbability = Math.min(0.9, simulatedProbability + 0.2);
                    activationReason = `${wreckCandidates} candidatos (an√°lisis submarino + validaci√≥n temporal CONFIRMADA)`;
                } else if (temporalValidation && temporalValidation.validationStatus === 'DUDOSO') {
                    activationReason = `${wreckCandidates} candidatos (an√°lisis submarino + validaci√≥n temporal DUDOSA)`;
                } else if (temporalValidation && temporalValidation.validationStatus === 'SIN_DATOS') {
                    activationReason = `${wreckCandidates} candidatos (an√°lisis submarino - sensor temporal SIN DATOS)`;
                } else {
                    activationReason = `${wreckCandidates} candidatos (an√°lisis submarino especializado - sensor temporal NO APLICABLE)`;
                }
            } else if (totalAnomalies > 0) {
                shouldActivateLupa = true;
                simulatedProbability = Math.min(0.7, 0.2 + (totalAnomalies * 0.1));
                activationReason = `${totalAnomalies} anomal√≠as detectadas (an√°lisis multi-instrumento)`;
            }
            
            // FALLBACK: Verificar estructura antigua (por compatibilidad)
            if (!shouldActivateLupa) {
                console.log('üîÑ Verificando estructura antigua de probabilidades...');
                const probabilities = Object.values(stats).map(s => {
                    if (typeof s === 'object' && s !== null && 'archaeological_probability' in s) {
                        const prob = s.archaeological_probability || 0;
                        console.log(`üìä Instrumento con probabilidad: ${(prob * 100).toFixed(1)}%`);
                        return prob;
                    }
                    return 0;
                });
                
                if (probabilities.length > 0 && probabilities.some(p => p > 0)) {
                    const avgProbability = probabilities.reduce((a, b) => a + b, 0) / probabilities.length;
                    if (avgProbability > 0.15) {
                        shouldActivateLupa = true;
                        simulatedProbability = avgProbability;
                        activationReason = `Probabilidad promedio: ${(avgProbability * 100).toFixed(1)}%`;
                    }
                }
            }
            
            console.log(`üéØ ¬øACTIVAR LUPA?: ${shouldActivateLupa ? 'S√ç ‚úÖ' : 'NO ‚ùå'}`);
            console.log(`üéØ RAZ√ìN: ${activationReason}`);
            console.log(`üéØ PROBABILIDAD SIMULADA: ${(simulatedProbability * 100).toFixed(1)}%`);
            
            // NUEVA INTEGRACI√ìN: VALIDACI√ìN CIENT√çFICA
            if (selectedCoordinates && shouldActivateLupa) {
                console.log('üî¨ Ejecutando validaci√≥n cient√≠fica...');
                const validationReport = validateDetections(selectedCoordinates, analysisResults);
                console.log('üìã Reporte de validaci√≥n:', validationReport);
            }
            
            const lupaBtn = document.getElementById('lupaBtn');
            console.log('üîç Bot√≥n de lupa encontrado:', !!lupaBtn);
            
            if (!lupaBtn) {
                console.error('‚ùå CR√çTICO: Bot√≥n de lupa no encontrado en el DOM');
                // Intentar crearlo din√°micamente
                const mapContainer = document.querySelector('.map-container');
                if (mapContainer) {
                    const newBtn = document.createElement('button');
                    newBtn.id = 'lupaBtn';
                    newBtn.className = 'lupa-btn';
                    newBtn.onclick = openLupaModal;
                    newBtn.innerHTML = 'üîç Lupa Arqueol√≥gica';
                    mapContainer.appendChild(newBtn);
                    console.log('‚úÖ Bot√≥n de lupa creado din√°micamente');
                }
                return;
            }
            
            if (shouldActivateLupa) {
                console.log('üéâ ===== ACTIVANDO LUPA ARQUEOL√ìGICA =====');
                
                // Asegurar que el bot√≥n sea visible con m√∫ltiples m√©todos
                lupaBtn.classList.add('active');
                lupaBtn.style.display = 'block !important';
                lupaBtn.style.visibility = 'visible';
                lupaBtn.style.opacity = '1';
                
                // Texto del bot√≥n con informaci√≥n relevante
                const realPercentage = (simulatedProbability * 100).toFixed(1);
                if (wreckCandidates > 0) {
                    lupaBtn.innerHTML = `üîç Lupa Arqueol√≥gica (${wreckCandidates} candidatos)`;
                } else {
                    lupaBtn.innerHTML = `üîç Lupa Arqueol√≥gica (${realPercentage}%)`;
                }
                
                console.log('‚úÖ Clases a√±adidas:', lupaBtn.classList.toString());
                console.log('‚úÖ Estilo display:', lupaBtn.style.display);
                console.log('‚úÖ Texto actualizado:', lupaBtn.innerHTML);
                
                // Guardar datos para la lupa
                currentAnalysisData = analysisResults;
                console.log('‚úÖ Datos guardados para lupa');
                
                // NUEVA FUNCIONALIDAD: Guardar en historial autom√°ticamente
                if (selectedCoordinates) {
                    const detectedAnomalies = detectAnomalyTypes(analysisResults);
                    console.log(`üéØ Anomal√≠as detectadas para historial: ${detectedAnomalies.length}`);
                    
                    if (detectedAnomalies.length > 0) {
                        const historyId = saveAnalysisToHistory(selectedCoordinates, analysisResults, detectedAnomalies);
                        console.log(`üìã An√°lisis guardado en historial con ID: ${historyId}`);
                    }
                }
                
                // ‚úÖ MENSAJE MEJORADO: Informar qu√© m√©todos se usaron
                const validationInfo = selectedCoordinates ? 
                    ' - Validaci√≥n cient√≠fica completada' : '';
                
                // Crear mensaje detallado sobre m√©todos usados
                let methodsUsed = [];
                if (wreckCandidates > 0) {
                    methodsUsed.push('üåä An√°lisis submarino multi-sensor');
                    methodsUsed.push('üì° Sonar multihaz + magnetometr√≠a');
                }
                if (temporalValidation && temporalValidation.validationStatus === 'CONFIRMADO') {
                    methodsUsed.push('‚è≥ Validaci√≥n temporal CONFIRMADA');
                } else if (temporalValidation && temporalValidation.validationStatus === 'SIN_DATOS') {
                    methodsUsed.push('‚è≥ Sensor temporal SIN DATOS (excluido)');
                } else {
                    methodsUsed.push('‚è≥ Sensor temporal NO APLICABLE (superficie acu√°tica)');
                }
                
                const methodsInfo = methodsUsed.length > 0 ? ` | M√©todos: ${methodsUsed.join(', ')}` : '';
                
                showMessage(`üîç ¬°ANOMAL√çAS DETECTADAS! ${activationReason}${validationInfo}${methodsInfo}`, 'success');
                
                // Hacer scroll hacia arriba para que el usuario vea el bot√≥n
                setTimeout(() => {
                    const mapContainer = document.querySelector('.map-container');
                    if (mapContainer) {
                        mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        console.log('‚úÖ Scroll realizado hacia el mapa');
                    }
                }, 500);
                
                // Verificar que el bot√≥n sea realmente visible
                setTimeout(() => {
                    const rect = lupaBtn.getBoundingClientRect();
                    const isVisible = rect.width > 0 && rect.height > 0;
                    console.log(`üîç Verificaci√≥n final - Bot√≥n visible: ${isVisible ? 'S√ç ‚úÖ' : 'NO ‚ùå'}`);
                    console.log(`üìê Dimensiones: ${rect.width}x${rect.height}`);
                    console.log(`üìç Posici√≥n: top=${rect.top}, left=${rect.left}`);
                    
                    // FORZAR VISIBILIDAD SI NO ES VISIBLE
                    if (!isVisible) {
                        console.log('üö® FORZANDO VISIBILIDAD DEL BOT√ìN');
                        lupaBtn.style.cssText = 'display: block !important; position: absolute !important; top: 10px !important; right: 10px !important; z-index: 1000 !important; visibility: visible !important; opacity: 1 !important;';
                    }
                }, 1000);
                
            } else {
                console.log('‚ÑπÔ∏è No se detectaron anomal√≠as suficientes para activar lupa');
                lupaBtn.classList.remove('active');
                lupaBtn.style.display = 'none';
                
                // Mostrar mensaje informativo (INCLUYE VALIDACI√ìN TEMPORAL)
                const temporalInfo = temporalMessage ? ` | ${temporalMessage}` : '';
                showMessage(`üìä An√°lisis completado. ${activationReason || 'No se detectaron anomal√≠as significativas'}${temporalInfo}`, 'success');
            }
            
            console.log('üîç ===== FIN VERIFICACI√ìN DE ANOMAL√çAS =====');
        }

        // NUEVA FUNCIONALIDAD: Selecci√≥n interactiva en mapa
        function toggleSelectionMode() {
            const modes = ['click', 'area', 'multi'];
            const currentIndex = modes.indexOf(selectionMode);
            selectionMode = modes[(currentIndex + 1) % modes.length];
            
            const btn = document.getElementById('selectionModeBtn');
            const modeNames = {
                'click': 'üéØ MODO SELECCI√ìN: Click',
                'area': 'üî≤ MODO SELECCI√ìN: √Årea', 
                'multi': 'üìç MODO SELECCI√ìN: M√∫ltiple'
            };
            
            btn.textContent = modeNames[selectionMode];
            
            // Actualizar cursor del mapa
            if (map) {
                const mapContainer = map.getContainer();
                if (selectionMode === 'area') {
                    mapContainer.classList.add('selection-mode-active');
                } else {
                    mapContainer.classList.remove('selection-mode-active');
                }
            }
            
            console.log(`üéØ Modo de selecci√≥n cambiado a: ${selectionMode}`);
        }

        function setupInteractiveSelection() {
            if (!map) return;
            
            // Limpiar eventos anteriores
            if (map && typeof map.off === 'function') {
                map.off('click');
                map.off('mousedown');
                map.off('mousemove');
                map.off('mouseup');
            }
            
            // Configurar eventos seg√∫n el modo de selecci√≥n
            if (map && typeof map.on === 'function') {
                try {
                    map.on('click', handleMapClick);
                    map.on('mousedown', handleMouseDown);
                    map.on('mousemove', handleMouseMove);
                    map.on('mouseup', handleMouseUp);
                } catch (error) {
                    console.error('Error configurando eventos del mapa:', error);
                }
            } else {
                console.warn('Mapa no disponible para configurar eventos');
            }
        }

        function handleMapClick(e) {
            if (selectionMode === 'click' || selectionMode === 'multi') {
                addSelectionPin(e.latlng);
            }
            
            // Mantener funcionalidad de inspecci√≥n de p√≠xel con Ctrl+Click
            if (e.originalEvent.ctrlKey) {
                inspectPixel(e.latlng);
            }
        }

        function handleMouseDown(e) {
            if (selectionMode === 'area' && !e.originalEvent.ctrlKey) {
                isDrawing = true;
                const startLatLng = e.latlng;
                
                // Crear √°rea de selecci√≥n inicial
                currentSelectionArea = L.rectangle([startLatLng, startLatLng], {
                    className: 'selection-area',
                    color: '#2196F3',
                    weight: 2,
                    fillOpacity: 0.1,
                    dashArray: '5, 5'
                }).addTo(map);
                
                // Prevenir el comportamiento por defecto del mapa
                e.originalEvent.preventDefault();
            }
        }

        function handleMouseMove(e) {
            if (isDrawing && currentSelectionArea) {
                // Actualizar el √°rea de selecci√≥n mientras se arrastra
                const bounds = currentSelectionArea.getBounds();
                const newBounds = L.latLngBounds(bounds.getSouthWest(), e.latlng);
                currentSelectionArea.setBounds(newBounds);
            }
        }

        function handleMouseUp(e) {
            if (isDrawing && currentSelectionArea) {
                isDrawing = false;
                
                // Finalizar √°rea de selecci√≥n
                const bounds = currentSelectionArea.getBounds();
                
                // Verificar que el √°rea tenga un tama√±o m√≠nimo
                const latDiff = Math.abs(bounds.getNorth() - bounds.getSouth());
                const lngDiff = Math.abs(bounds.getEast() - bounds.getWest());
                
                if (latDiff > 0.001 && lngDiff > 0.001) {
                    // √Årea v√°lida - a√±adir a la lista y configurar coordenadas
                    selectionAreas.push(currentSelectionArea);
                    
                    // Actualizar campos de coordenadas autom√°ticamente
                    document.getElementById('latMin').value = bounds.getSouth().toFixed(6);
                    document.getElementById('latMax').value = bounds.getNorth().toFixed(6);
                    document.getElementById('lonMin').value = bounds.getWest().toFixed(6);
                    document.getElementById('lonMax').value = bounds.getEast().toFixed(6);
                    
                    // Configurar coordenadas seleccionadas para an√°lisis
                    selectedCoordinates = {
                        lat: bounds.getCenter().lat,
                        lng: bounds.getCenter().lng
                    };
                    
                    // A√±adir popup informativo
                    currentSelectionArea.bindPopup(`
                        <div style="text-align: center;">
                            <strong>üî≤ √Årea Seleccionada</strong><br>
                            <div style="margin: 0.5rem 0; font-size: 0.9rem;">
                                ${latDiff.toFixed(4)}¬∞ √ó ${lngDiff.toFixed(4)}¬∞<br>
                                (~${(latDiff * 111).toFixed(0)}m √ó ${(lngDiff * 111 * Math.cos(bounds.getCenter().lat * Math.PI / 180)).toFixed(0)}m)
                            </div>
                            <button onclick="analyzeSelectedArea()" style="padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                üîç Analizar √Årea
                            </button>
                        </div>
                    `).openPopup();
                    
                    showMessage(`‚úÖ √Årea seleccionada: ${(latDiff * 111).toFixed(0)}m √ó ${(lngDiff * 111 * Math.cos(bounds.getCenter().lat * Math.PI / 180)).toFixed(0)}m`, 'success');
                } else {
                    // √Årea muy peque√±a - eliminar
                    map.removeLayer(currentSelectionArea);
                    showMessage('‚ö†Ô∏è √Årea demasiado peque√±a. Dibuja un √°rea m√°s grande.', 'error');
                }
                
                currentSelectionArea = null;
            }
        }

        function addSelectionPin(latlng) {
            // Crear icono de pin personalizado
            const pinIcon = L.divIcon({
                html: '<div class="selection-pin"></div>',
                className: 'selection-pin-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            // Crear marcador
            const marker = L.marker(latlng, { icon: pinIcon }).addTo(map);
            
            // A√±adir popup informativo
            marker.bindPopup(`
                <div style="text-align: center;">
                    <strong>üìç Sitio Seleccionado</strong><br>
                    <div style="margin: 0.5rem 0; font-size: 0.9rem; font-family: monospace;">
                        ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}
                    </div>
                    <button onclick="analyzeSelectedSite(${latlng.lat}, ${latlng.lng})" style="padding: 0.25rem 0.5rem; background: #ff4444; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        üîç Analizar Sitio
                    </button>
                </div>
            `).openPopup();
            
            // A√±adir a la lista de marcadores
            selectionMarkers.push(marker);
            
            // Si no es modo m√∫ltiple, limpiar marcadores anteriores
            if (selectionMode !== 'multi' && selectionMarkers.length > 1) {
                const oldMarker = selectionMarkers.shift();
                map.removeLayer(oldMarker);
            }
            
            // Configurar coordenadas para an√°lisis autom√°tico (√°rea peque√±a alrededor del pin)
            const offset = 0.005; // ¬±0.005¬∞ = ~1km
            document.getElementById('latMin').value = (latlng.lat - offset).toFixed(6);
            document.getElementById('latMax').value = (latlng.lat + offset).toFixed(6);
            document.getElementById('lonMin').value = (latlng.lng - offset).toFixed(6);
            document.getElementById('lonMax').value = (latlng.lng + offset).toFixed(6);
            
            selectedCoordinates = { lat: latlng.lat, lng: latlng.lng };
            
            showMessage(`üìç Pin colocado en: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`, 'success');
        }

        function analyzeSelectedSite(lat, lng) {
            console.log(`üîç Analizando sitio seleccionado: ${lat}, ${lng}`);
            selectedCoordinates = { lat, lng };
            investigateRegion();
        }

        function analyzeSelectedArea() {
            console.log('üî≤ Analizando √°rea seleccionada');
            investigateRegion();
        }

        function clearSelections() {
            // Limpiar marcadores
            selectionMarkers.forEach(marker => map.removeLayer(marker));
            selectionMarkers = [];
            
            // Limpiar √°reas
            selectionAreas.forEach(area => map.removeLayer(area));
            selectionAreas = [];
            
            // Limpiar √°rea actual si existe
            if (currentSelectionArea) {
                map.removeLayer(currentSelectionArea);
                currentSelectionArea = null;
            }
            
            showMessage('üßπ Selecciones limpiadas', 'success');
        }

        // ===== SISTEMA DE HISTORIAL DE ANOMAL√çAS =====
        
        // Almacenamiento local del historial
        const HISTORY_STORAGE_KEY = 'archeoscope_anomaly_history';
        
        // Funci√≥n para guardar an√°lisis en el historial
        function saveAnalysisToHistory(coordinates, analysisData, anomaliesDetected) {
            try {
                const historyEntry = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('es-ES'),
                    coordinates: {
                        lat: coordinates.lat,
                        lng: coordinates.lng,
                        formatted: `${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}`
                    },
                    analysis: {
                        totalAnomalies: anomaliesDetected.length,
                        avgConfidence: anomaliesDetected.length > 0 ? 
                            anomaliesDetected.reduce((sum, a) => sum + a.confidence, 0) / anomaliesDetected.length : 0,
                        anomalyTypes: anomaliesDetected.map(a => a.type),
                        instruments: Object.keys(analysisData.statistical_results || {}),
                        region: determineRegionName(coordinates.lat, coordinates.lng)
                    },
                    anomalies: anomaliesDetected,
                    rawData: analysisData
                };
                
                // Obtener historial existente
                const existingHistory = getHistoryData();
                
                // Agregar nueva entrada al inicio
                existingHistory.unshift(historyEntry);
                
                // Limitar a 50 entradas m√°ximo
                if (existingHistory.length > 50) {
                    existingHistory.splice(50);
                }
                
                // Guardar en localStorage
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(existingHistory));
                
                console.log(`‚úÖ An√°lisis guardado en historial: ${anomaliesDetected.length} anomal√≠as en ${historyEntry.analysis.region}`);
                
                return historyEntry.id;
            } catch (error) {
                console.error('‚ùå Error guardando en historial:', error);
                return null;
            }
        }
        
        // Funci√≥n para obtener datos del historial
        function getHistoryData() {
            try {
                const stored = localStorage.getItem(HISTORY_STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('‚ùå Error leyendo historial:', error);
                return [];
            }
        }
        
        // Funci√≥n para determinar nombre de regi√≥n
        function determineRegionName(lat, lng) {
            // Caribe/Atl√°ntico Norte
            if (lat >= 20 && lat <= 30 && lng >= -80 && lng <= -60) {
                return "Caribe/Atl√°ntico Norte";
            }
            // Mediterr√°neo
            if (lat >= 30 && lat <= 46 && lng >= -6 && lng <= 36) {
                return "Mediterr√°neo";
            }
            // Europa
            if (lat >= 35 && lat <= 72 && lng >= -10 && lng <= 40) {
                return "Europa";
            }
            // Am√©rica del Norte
            if (lat >= 25 && lat <= 70 && lng >= -170 && lng <= -50) {
                return "Am√©rica del Norte";
            }
            // Am√©rica del Sur
            if (lat >= -55 && lat <= 15 && lng >= -82 && lng <= -35) {
                return "Am√©rica del Sur";
            }
            // √Åfrica
            if (lat >= -35 && lat <= 37 && lng >= -18 && lng <= 52) {
                return "√Åfrica";
            }
            // Asia
            if (lat >= 5 && lat <= 75 && lng >= 25 && lng <= 180) {
                return "Asia";
            }
            // Oc√©ano Pac√≠fico
            if ((lng >= 120 || lng <= -60) && lat >= -60 && lat <= 70) {
                return "Oc√©ano Pac√≠fico";
            }
            // Oc√©ano Atl√°ntico
            if (lng >= -80 && lng <= 20 && lat >= -60 && lat <= 70) {
                return "Oc√©ano Atl√°ntico";
            }
            return "Regi√≥n Desconocida";
        }
        
        // Funci√≥n para mostrar el modal de historial
        function showAnomalyHistory() {
            const modal = document.getElementById('historyModal');
            modal.classList.add('active');
            
            // Cargar y mostrar datos del historial usando el nuevo sistema
            loadHistoryDisplay();
        }
        
        // Funci√≥n para cerrar el modal de historial
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('active');
        }
        
        // Funci√≥n para cargar y mostrar el historial
        function loadHistoryDisplay() {
            const historyData = historyManager.getHistory();
            const historyList = document.getElementById('historyList');
            
            // Actualizar estad√≠sticas
            updateHistoryStats();
            
            if (historyData.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                        <div>No hay an√°lisis guardados a√∫n</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">Realiza un an√°lisis arqueol√≥gico para comenzar a construir tu historial</div>
                        <button onclick="historyManager.addCaribbeanExamples(); setTimeout(loadHistoryDisplay, 500);" 
                                style="margin-top: 1rem; padding: 0.5rem 1rem; background: #8B4513; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üèùÔ∏è Cargar Ejemplos del Caribe
                        </button>
                    </div>
                `;
                return;
            }
            
            // Generar HTML para cada entrada del historial
            let html = '';
            historyData.forEach((entry, index) => {
                const anomalyTags = entry.anomalies.map(a => 
                    `<span class="anomaly-tag" style="background: ${a.color || '#8B4513'}">${a.icon || 'üéØ'} ${a.name || a.type}</span>`
                ).join('');
                
                html += `
                    <div class="history-item">
                        <div class="history-item-header">
                            <div class="history-date">${entry.date}</div>
                            <div class="history-coordinates">${entry.coordinates.formatted}</div>
                        </div>
                        <div class="history-summary">
                            <strong>üìç ${entry.analysis.region}</strong><br>
                            üéØ ${entry.analysis.totalAnomalies} anomal√≠as detectadas<br>
                            üìä Confianza promedio: ${(entry.analysis.avgConfidence * 100).toFixed(1)}%<br>
                            üõ∞Ô∏è Instrumentos: ${entry.analysis.instruments.length}<br>
                            üìè Resoluci√≥n: ${entry.analysis.resolution || 'N/A'}
                        </div>
                        <div class="history-anomalies">
                            ${anomalyTags}
                        </div>
                        <div class="history-actions">
                            <button class="history-btn view" onclick="viewHistoryEntry('${entry.id}')">
                                üëÅÔ∏è Ver Detalles
                            </button>
                            <button class="history-btn export" onclick="exportHistoryEntry('${entry.id}')">
                                üì• Exportar
                            </button>
                            <button class="history-btn view" onclick="goToLocation(${entry.coordinates.lat}, ${entry.coordinates.lng})">
                                üó∫Ô∏è Ir a Ubicaci√≥n
                            </button>
                            <button class="history-btn delete" onclick="deleteHistoryEntry('${entry.id}')">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        // Funci√≥n para actualizar estad√≠sticas del historial
        function updateHistoryStats() {
            const stats = historyManager.getStatistics();
            
            // Actualizar elementos del DOM
            document.getElementById('totalAnalyses').textContent = stats.totalAnalyses;
            document.getElementById('totalAnomalies').textContent = stats.totalAnomalies;
            document.getElementById('avgConfidence').textContent = `${(stats.avgConfidence * 100).toFixed(1)}%`;
            document.getElementById('topRegion').textContent = stats.topRegion;
        }
        
        // Funci√≥n para ver detalles de una entrada del historial
        function viewHistoryEntry(entryId) {
            const entry = historyManager.getEntry(entryId);
            
            if (!entry) {
                alert('Entrada no encontrada');
                return;
            }
            
            // Crear ventana de detalles mejorada
            const detailsWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
            detailsWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ArcheoScope - An√°lisis Detallado</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Consolas', 'Monaco', monospace; 
                            padding: 0; 
                            margin: 0; 
                            line-height: 1.6; 
                            background: #f8f9fa;
                        }
                        .header { 
                            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); 
                            color: white; 
                            padding: 2rem; 
                            text-align: center;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        }
                        .container { padding: 2rem; max-width: 1000px; margin: 0 auto; }
                        .section { 
                            background: white; 
                            margin-bottom: 2rem; 
                            padding: 1.5rem; 
                            border-radius: 8px; 
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .section h2 { 
                            color: #8B4513; 
                            border-bottom: 2px solid #D2691E; 
                            padding-bottom: 0.5rem; 
                            margin-bottom: 1rem;
                        }
                        .anomaly-item { 
                            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                            padding: 1rem; 
                            margin: 1rem 0; 
                            border-radius: 8px; 
                            border-left: 4px solid #8B4513;
                        }
                        .anomaly-header {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            margin-bottom: 0.5rem;
                        }
                        .confidence-bar {
                            width: 100%;
                            height: 8px;
                            background: #e9ecef;
                            border-radius: 4px;
                            overflow: hidden;
                            margin: 0.5rem 0;
                        }
                        .confidence-fill {
                            height: 100%;
                            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
                            transition: width 0.3s ease;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 1rem;
                            margin: 1rem 0;
                        }
                        .stat-card {
                            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                            padding: 1rem;
                            border-radius: 8px;
                            text-align: center;
                            border: 1px solid #2196f3;
                        }
                        .stat-number {
                            font-size: 1.5rem;
                            font-weight: bold;
                            color: #1976d2;
                        }
                        .stat-label {
                            font-size: 0.9rem;
                            color: #666;
                        }
                        pre { 
                            background: #2d3748; 
                            color: #e2e8f0; 
                            padding: 1rem; 
                            border-radius: 8px; 
                            overflow-x: auto; 
                            font-size: 0.9rem;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 25px;
                            cursor: pointer;
                            font-weight: 600;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        }
                        @media print {
                            .print-btn { display: none; }
                            .header { background: #8B4513 !important; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir Reporte</button>
                    
                    <div class="header">
                        <h1>üè∫ ArcheoScope - Reporte de An√°lisis Arqueol√≥gico</h1>
                        <p style="font-size: 1.1rem; margin: 0.5rem 0;">
                            üìÖ ${entry.date} | üìç ${entry.coordinates.formatted}
                        </p>
                        <p style="font-size: 1rem; opacity: 0.9; margin: 0;">
                            üåç ${entry.analysis.region} | üéØ ${entry.analysis.totalAnomalies} Anomal√≠as Detectadas
                        </p>
                    </div>
                    
                    <div class="container">
                        <div class="section">
                            <h2>üìä Resumen Ejecutivo</h2>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number">${entry.analysis.totalAnomalies}</div>
                                    <div class="stat-label">Anomal√≠as Detectadas</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${(entry.analysis.avgConfidence * 100).toFixed(1)}%</div>
                                    <div class="stat-label">Confianza Promedio</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${entry.analysis.instruments.length}</div>
                                    <div class="stat-label">Instrumentos Utilizados</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${entry.analysis.resolution}</div>
                                    <div class="stat-label">Resoluci√≥n de An√°lisis</div>
                                </div>
                            </div>
                            <p><strong>üåç Regi√≥n Analizada:</strong> ${entry.analysis.region}</p>
                            <p><strong>üõ∞Ô∏è Instrumentos:</strong> ${entry.analysis.instruments.join(', ')}</p>
                            <p><strong>üìè Tipo de An√°lisis:</strong> ${entry.analysis.analysisType || 'An√°lisis est√°ndar'}</p>
                        </div>
                        
                        <div class="section">
                            <h2>üéØ Anomal√≠as Detectadas</h2>
                            ${entry.anomalies.map((a, i) => `
                                <div class="anomaly-item">
                                    <div class="anomaly-header">
                                        <span style="font-size: 1.5rem;">${a.icon}</span>
                                        <h3 style="margin: 0; color: #8B4513;">${a.name}</h3>
                                    </div>
                                    <p><strong>üìù Descripci√≥n:</strong> ${a.description}</p>
                                    <p><strong>üî¨ Evidencia:</strong> ${a.evidence}</p>
                                    <p><strong>üìä Nivel de Confianza:</strong></p>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${a.confidence * 100}%"></div>
                                    </div>
                                    <p style="text-align: center; margin: 0.5rem 0; font-weight: bold; color: #1976d2;">
                                        ${(a.confidence * 100).toFixed(1)}%
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="section">
                            <h2>üõ∞Ô∏è Datos de Instrumentos</h2>
                            <p>Resultados estad√≠sticos de cada instrumento utilizado en el an√°lisis:</p>
                            ${Object.entries(entry.rawData.statistical_results || {}).map(([instrument, data]) => `
                                <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                    <h4 style="color: #8B4513; margin-bottom: 0.5rem;">
                                        üì° ${instrument.replace(/_/g, ' ').toUpperCase()}
                                    </h4>
                                    <p><strong>Probabilidad Arqueol√≥gica:</strong> ${((data.archaeological_probability || 0) * 100).toFixed(1)}%</p>
                                    <p><strong>Coherencia Geom√©trica:</strong> ${((data.geometric_coherence || data.coherence || 0) * 100).toFixed(1)}%</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="section">
                            <h2>üîß Datos T√©cnicos Completos</h2>
                            <p>Datos t√©cnicos completos del an√°lisis para referencia cient√≠fica:</p>
                            <pre>${JSON.stringify(entry.rawData, null, 2)}</pre>
                        </div>
                        
                        <div class="section" style="text-align: center; color: #666; font-size: 0.9rem;">
                            <p>üìã Reporte generado por ArcheoScope v${entry.version || '1.0.0'}</p>
                            <p>üïí An√°lisis realizado: ${entry.timestamp}</p>
                            <p>üè∫ Sistema de Detecci√≥n Arqueol√≥gica Avanzada</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }
        
        // Funci√≥n para exportar una entrada del historial
        function exportHistoryEntry(entryId) {
            const entry = historyManager.getEntry(entryId);
            
            if (!entry) {
                alert('Entrada no encontrada');
                return;
            }
            
            const dataStr = JSON.stringify(entry, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `archeoscope_analysis_${entry.id}.json`;
            link.click();
            
            showMessage(`üì• An√°lisis exportado: ${entry.analysis.region}`, 'success');
        }
        
        // Funci√≥n para ir a una ubicaci√≥n del historial
        function goToLocation(lat, lng) {
            // Cerrar modal de historial
            closeHistoryModal();
            
            // Centrar mapa en la ubicaci√≥n
            if (map) {
                map.setView([lat, lng], 15);
                
                // Colocar marcador temporal
                const marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`üìç Ubicaci√≥n del historial<br>${lat.toFixed(6)}, ${lng.toFixed(6)}`)
                    .openPopup();
                
                // Remover marcador despu√©s de 10 segundos
                setTimeout(() => {
                    map.removeLayer(marker);
                }, 10000);
            }
            
            // Actualizar campos de coordenadas
            document.getElementById('coordSearch').value = `${lat}, ${lng}`;
            
            showMessage(`üìç Navegando a ubicaci√≥n del historial: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
        }
        
        // Funci√≥n para eliminar una entrada del historial
        function deleteHistoryEntry(entryId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta entrada del historial?')) {
                return;
            }
            
            if (historyManager.deleteEntry(entryId)) {
                loadHistoryDisplay();
                showMessage('üóëÔ∏è Entrada eliminada del historial', 'success');
            } else {
                showMessage('‚ùå Error eliminando entrada del historial', 'error');
            }
        }
        
        // Funci√≥n para exportar todo el historial
        function exportHistoryData() {
            if (historyManager.exportHistory()) {
                const stats = historyManager.getStatistics();
                showMessage(`üì• Historial exportado: ${stats.totalAnalyses} entradas`, 'success');
            } else {
                showMessage('‚ùå Error exportando historial', 'error');
            }
        }
        
        // Funci√≥n para limpiar todo el historial
        function clearHistoryData() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODO el historial? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            if (historyManager.clearHistory()) {
                loadHistoryDisplay();
                showMessage('üóëÔ∏è Historial completamente limpiado', 'success');
            } else {
                showMessage('‚ùå Error limpiando historial', 'error');
            }
        }
        
        // Funci√≥n para agregar an√°lisis del Caribe al historial (datos predefinidos)
        function addCaribbeanAnalysisToHistory() {
            const caribbeanAnalyses = [
                {
                    coordinates: { lat: 25.800, lng: -70.000 },
                    region: "Caribe/Atl√°ntico Norte",
                    anomalies: [
                        {
                            type: 'submarine_wreck',
                            name: 'Candidato a Naufragio Grande',
                            icon: 'üö¢',
                            description: 'Estructura de 295.7m x 37.0m detectada por sonar multihaz',
                            confidence: 1.0,
                            evidence: 'Anomal√≠a magn√©tica y batim√©trica significativa'
                        },
                        {
                            type: 'linear_structure',
                            name: 'Estructura Lineal',
                            icon: 'üìè',
                            description: 'Posible resto de embarcaci√≥n o estructura artificial',
                            confidence: 0.85,
                            evidence: 'Patr√≥n geom√©trico coherente en datos SAR'
                        }
                    ],
                    analysisData: {
                        statistical_results: {
                            multibeam_sonar: { archaeological_probability: 0.95 },
                            magnetometer: { archaeological_probability: 0.88 },
                            side_scan_sonar: { archaeological_probability: 0.92 }
                        }
                    }
                },
                {
                    coordinates: { lat: 25.300, lng: -70.500 },
                    region: "Caribe/Atl√°ntico Norte",
                    anomalies: [
                        {
                            type: 'multiple_targets',
                            name: 'M√∫ltiples Objetivos',
                            icon: 'üéØ',
                            description: '13 candidatos detectados en √°rea costera',
                            confidence: 0.78,
                            evidence: 'Concentraci√≥n an√≥mala de objetivos submarinos'
                        }
                    ],
                    analysisData: {
                        statistical_results: {
                            multibeam_sonar: { archaeological_probability: 0.78 },
                            acoustic_reflectance: { archaeological_probability: 0.82 }
                        }
                    }
                },
                {
                    coordinates: { lat: 25.550, lng: -70.250 },
                    region: "Caribe/Atl√°ntico Norte", 
                    anomalies: [
                        {
                            type: 'high_density_area',
                            name: '√Årea de Alta Densidad',
                            icon: 'üî•',
                            description: '39 anomal√≠as en aguas someras - concentraci√≥n excepcional',
                            confidence: 0.95,
                            evidence: 'Mayor concentraci√≥n de anomal√≠as detectada en el √°rea'
                        }
                    ],
                    analysisData: {
                        statistical_results: {
                            multibeam_sonar: { archaeological_probability: 0.95 },
                            sub_bottom_profiler: { archaeological_probability: 0.88 }
                        }
                    }
                }
            ];
            
            // Agregar cada an√°lisis al historial
            caribbeanAnalyses.forEach((analysis, index) => {
                setTimeout(() => {
                    saveAnalysisToHistory(analysis.coordinates, analysis.analysisData, analysis.anomalies);
                    console.log(`‚úÖ An√°lisis del Caribe ${index + 1} agregado al historial`);
                }, index * 100); // Peque√±o delay para evitar conflictos de timestamp
            });
            
            showMessage(`üèùÔ∏è An√°lisis del Caribe agregados al historial (${caribbeanAnalyses.length} entradas)`, 'success');
        }
        
        // Inicializar historial con datos del Caribe si est√° vac√≠o
        document.addEventListener('DOMContentLoaded', function() {
            const historyData = getHistoryData();
            if (historyData.length === 0) {
                // Agregar autom√°ticamente los an√°lisis del Caribe como ejemplos
                setTimeout(() => {
                    addCaribbeanAnalysisToHistory();
                }, 2000);
            }
        });

        // Abrir modal de lupa
        function openLupaModal() {
            if (!currentAnalysisData || !selectedCoordinates) {
                alert('Primero realiza un an√°lisis arqueol√≥gico con anomal√≠as detectadas');
                return;
            }
            
            document.getElementById('lupaModal').classList.add('active');
            
            // Inicializar mapa de lupa
            setTimeout(() => {
                initLupaMap();
                setupLupaLayers();
                displayInstrumentAnalysis();
            }, 100);
        }

        // Cerrar modal de lupa (funci√≥n mejorada ya definida arriba)
        // Esta funci√≥n ya est√° implementada con mejor funcionalidad

        // Inicializar mapa de lupa
        function initLupaMap() {
            if (lupaMap) {
                lupaMap.remove();
            }
            
            lupaMap = L.map('lupaMap').setView([0, 0], 15);
            
            // Capa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(lupaMap);
        }

        // Configurar capas arqueol√≥gicas en la lupa
        function setupLupaLayers() {
            if (!lupaMap || !selectedCoordinates || !currentAnalysisData) return;
            
            // Centrar en la regi√≥n analizada
            lupaMap.setView([selectedCoordinates.lat, selectedCoordinates.lng], 15);
            
            // Crear capas simuladas basadas en los resultados
            const stats = currentAnalysisData.statistical_results || {};
            
            // Capa NDVI (√≥ptico)
            if (stats.ndvi_vegetation) {
                const prob = stats.ndvi_vegetation.archaeological_probability || 0;
                archaeoLayers.optical = createSimulatedLayer('optical', prob);
                archaeoLayers.optical.addTo(lupaMap);
            }
            
            // Capa t√©rmica
            if (stats.thermal_lst) {
                const prob = stats.thermal_lst.archaeological_probability || 0;
                archaeoLayers.thermal = createSimulatedLayer('thermal', prob);
                archaeoLayers.thermal.addTo(lupaMap);
            }
            
            // Capa SAR
            if (stats.sar_backscatter) {
                const prob = stats.sar_backscatter.archaeological_probability || 0;
                archaeoLayers.sar = createSimulatedLayer('sar', prob);
                archaeoLayers.sar.addTo(lupaMap);
            }
            
            // Capa DEM
            if (stats.elevation_dem || stats.surface_roughness) {
                const prob = (stats.elevation_dem?.archaeological_probability || stats.surface_roughness?.archaeological_probability) || 0;
                archaeoLayers.dem = createSimulatedLayer('dem', prob);
                archaeoLayers.dem.addTo(lupaMap);
            }
            
            // NUEVAS CAPAS AVANZADAS PARA VISUALIZACI√ìN IMPACTANTE
            
            // LiDAR Full-Waveform
            if (stats.lidar_fullwave) {
                const prob = stats.lidar_fullwave.archaeological_probability || 0;
                archaeoLayers.lidar_fullwave = createSimulatedLayer('lidar_fullwave', prob);
                archaeoLayers.lidar_fullwave.addTo(lupaMap);
            }
            
            // DEM Multiescala
            if (stats.dem_multiscale) {
                const prob = stats.dem_multiscale.archaeological_probability || 0;
                archaeoLayers.dem_multiscale = createSimulatedLayer('dem_multiscale', prob);
                archaeoLayers.dem_multiscale.addTo(lupaMap);
            }
            
            // Rugosidad Espectral
            if (stats.spectral_roughness) {
                const prob = stats.spectral_roughness.archaeological_probability || 0;
                archaeoLayers.spectral_roughness = createSimulatedLayer('spectral_roughness', prob);
                archaeoLayers.spectral_roughness.addTo(lupaMap);
            }
            
            // Pseudo-LiDAR IA
            if (stats.pseudo_lidar_ai) {
                const prob = stats.pseudo_lidar_ai.archaeological_probability || 0;
                archaeoLayers.pseudo_lidar_ai = createSimulatedLayer('pseudo_lidar_ai', prob);
                archaeoLayers.pseudo_lidar_ai.addTo(lupaMap);
            }
            
            // Topograf√≠a Multitemporal
            if (stats.multitemporal_topo) {
                const prob = stats.multitemporal_topo.archaeological_probability || 0;
                archaeoLayers.multitemporal_topo = createSimulatedLayer('multitemporal_topo', prob);
                archaeoLayers.multitemporal_topo.addTo(lupaMap);
            }
            
            // A√±adir marcador central
            L.marker([selectedCoordinates.lat, selectedCoordinates.lng])
                .addTo(lupaMap)
                .bindPopup('üìç Regi√≥n Analizada')
                .openPopup();
            
            // NUEVA FUNCIONALIDAD: A√±adir iconos de anomal√≠as detectadas en el mapa
            addAnomalyIconsToMap();
        }

        // NUEVA FUNCIONALIDAD: A√±adir iconos de anomal√≠as detectadas en el mapa - CORREGIDO
        function addAnomalyIconsToMap() {
            if (!lupaMap || !currentAnalysisData) {
                console.log('‚ùå No se pueden a√±adir iconos: mapa o datos no disponibles');
                return;
            }
            
            console.log('üéØ ===== A√ëADIENDO ICONOS DE ANOMAL√çAS AL MAPA =====');
            
            // Detectar tipos de anomal√≠as basados en los datos de an√°lisis
            const detectedAnomalies = detectAnomalyTypes(currentAnalysisData);
            
            console.log(`üìä Anomal√≠as a mostrar: ${detectedAnomalies.length}`);
            
            if (detectedAnomalies.length === 0) {
                console.log('‚ÑπÔ∏è No hay anomal√≠as espec√≠ficas para mostrar iconos');
                return;
            }
            
            // A√±adir iconos para cada tipo de anomal√≠a detectada
            detectedAnomalies.forEach((anomaly, index) => {
                console.log(`üéØ A√±adiendo icono ${index + 1}: ${anomaly.icon} ${anomaly.name} (${(anomaly.confidence * 100).toFixed(1)}%)`);
                
                // Calcular posici√≥n del icono (distribuir alrededor del centro)
                const angle = (index / detectedAnomalies.length) * 2 * Math.PI; // Distribuir en c√≠rculo
                const radius = 0.003; // Radio en grados
                
                const offsetLat = Math.sin(angle) * radius;
                const offsetLng = Math.cos(angle) * radius;
                
                const iconLat = selectedCoordinates.lat + offsetLat;
                const iconLng = selectedCoordinates.lng + offsetLng;
                
                console.log(`üìç Posici√≥n del icono: ${iconLat.toFixed(6)}, ${iconLng.toFixed(6)}`);
                
                // Crear icono personalizado
                const anomalyIcon = L.divIcon({
                    html: `
                        <div style="
                            background: ${anomaly.color}; 
                            border: 3px solid white; 
                            border-radius: 50%; 
                            width: 40px; 
                            height: 40px; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 20px; 
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                            animation: pulse 2s infinite;
                        ">
                            ${anomaly.icon}
                        </div>
                        <style>
                            @keyframes pulse {
                                0% { transform: scale(1); }
                                50% { transform: scale(1.1); }
                                100% { transform: scale(1); }
                            }
                        </style>
                    `,
                    className: 'anomaly-icon',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                // A√±adir marcador con popup informativo detallado
                const marker = L.marker([iconLat, iconLng], { icon: anomalyIcon })
                    .addTo(lupaMap)
                    .bindPopup(`
                        <div style="text-align: center; padding: 0.5rem; min-width: 200px;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${anomaly.icon}</div>
                            <strong>${anomaly.name}</strong><br>
                            <div style="margin: 0.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.3;">
                                ${anomaly.description}
                            </div>
                            <div style="background: ${anomaly.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold; margin-bottom: 0.5rem;">
                                Confianza: ${typeof anomaly.confidence === 'number' ? (anomaly.confidence * 100).toFixed(1) + '%' : anomaly.confidence}
                            </div>
                            <div style="font-size: 0.75rem; color: #888; font-style: italic;">
                                ${anomaly.evidence || 'Evidencia basada en an√°lisis multi-sensor'}
                            </div>
                        </div>
                    `);
                
                // A√±adir efecto hover
                marker.on('mouseover', function() {
                    this.openPopup();
                });
                
                console.log(`‚úÖ Icono ${anomaly.icon} a√±adido correctamente`);
            });
            
            console.log(`‚úÖ ${detectedAnomalies.length} iconos de anomal√≠as a√±adidos al mapa`);
            console.log('üéØ ===== FIN A√ëADIR ICONOS DE ANOMAL√çAS =====');
        }

        // Detectar tipos de anomal√≠as basados en los datos de an√°lisis - CORREGIDO
        function detectAnomalyTypes(analysisData) {
            console.log('üîç ===== AN√ÅLISIS RIGUROSO DE TIPOS DE ANOMAL√çAS =====');
            
            const stats = analysisData.statistical_results || {};
            const detectedAnomalies = [];
            
            console.log('üìä Instrumentos disponibles:', Object.keys(stats));
            
            // Calcular probabilidades promedio por categor√≠a
            const probabilities = Object.values(stats).map(s => s.archaeological_probability || 0);
            const avgProbability = probabilities.length > 0 ? 
                probabilities.reduce((a, b) => a + b, 0) / probabilities.length : 0;
            
            console.log(`üìà Probabilidad promedio general: ${(avgProbability * 100).toFixed(1)}%`);
            
            // AN√ÅLISIS ESPEC√çFICO POR TIPO DE ANOMAL√çA CON UMBRALES ESTRICTOS
            
            // 1. ANOMAL√çAS LINEALES - Requiere evidencia espec√≠fica de SAR o rugosidad
            const sarProb = stats.sar_backscatter?.archaeological_probability || 0;
            const roughnessProb = stats.surface_roughness?.archaeological_probability || 0;
            const sarLBandProb = stats.sar_l_band?.archaeological_probability || 0;
            
            const linearEvidence = Math.max(sarProb, roughnessProb, sarLBandProb);
            console.log(`üìè Evidencia LINEAL: SAR=${(sarProb*100).toFixed(1)}%, Rugosidad=${(roughnessProb*100).toFixed(1)}%, SAR-L=${(sarLBandProb*100).toFixed(1)}% ‚Üí Max=${(linearEvidence*100).toFixed(1)}%`);
            
            if (linearEvidence > 0.35) { // Umbral alto para lineales
                console.log('‚úÖ ANOMAL√çA LINEAL DETECTADA');
                detectedAnomalies.push({
                    type: 'linear',
                    name: 'Anomal√≠as Lineales',
                    icon: 'üìè',
                    description: 'Calzadas, muros, canales detectados por SAR/Rugosidad',
                    confidence: linearEvidence,
                    color: '#ff6b35',
                    evidence: `SAR: ${(sarProb*100).toFixed(1)}%, Rugosidad: ${(roughnessProb*100).toFixed(1)}%`
                });
            } else {
                console.log(`‚ùå ANOMAL√çA LINEAL NO DETECTADA (evidencia: ${(linearEvidence*100).toFixed(1)}% < 35%)`);
            }
            
            // 2. ANOMAL√çAS CIRCULARES - Requiere evidencia espec√≠fica de DEM o t√©rmico
            const demProb = stats.elevation_dem?.archaeological_probability || 0;
            const thermalProb = stats.thermal_lst?.archaeological_probability || 0;
            const icesat2Prob = stats.icesat2_profiles?.archaeological_probability || 0;
            
            const circularEvidence = Math.max(demProb, thermalProb, icesat2Prob);
            console.log(`‚≠ï Evidencia CIRCULAR: DEM-Grueso=${(demProb*100).toFixed(1)}%, T√©rmico=${(thermalProb*100).toFixed(1)}%, ICESat-2=${(icesat2Prob*100).toFixed(1)}% ‚Üí Max=${(circularEvidence*100).toFixed(1)}%`);
            
            if (circularEvidence > 0.30) { // Umbral moderado para circulares
                console.log('‚úÖ ANOMAL√çA CIRCULAR DETECTADA');
                detectedAnomalies.push({
                    type: 'circular',
                    name: 'Anomal√≠as Circulares',
                    icon: '‚≠ï',
                    description: 'Plazas, fosos, t√∫mulos detectados por DEM-Grueso/T√©rmico',
                    confidence: circularEvidence,
                    color: '#9932cc',
                    evidence: `DEM-Grueso: ${(demProb*100).toFixed(1)}%, T√©rmico: ${(thermalProb*100).toFixed(1)}%`
                });
            } else {
                console.log(`‚ùå ANOMAL√çA CIRCULAR NO DETECTADA (evidencia: ${(circularEvidence*100).toFixed(1)}% < 30%)`);
            }
            
            // 3. ANOMAL√çAS RECTANGULARES - Requiere evidencia espec√≠fica de NDVI o LiDAR
            const ndviProb = stats.ndvi_vegetation?.archaeological_probability || 0;
            const lidarProb = stats.lidar_fullwave?.archaeological_probability || 0;
            const gediProb = stats.vegetation_height?.archaeological_probability || 0;
            
            // Verificar disponibilidad real de LiDAR
            let lidarLabel = "LiDAR-Sint√©tico";
            let lidarAvailable = false;
            if (window.lidarChecker && selectedCoordinates) {
                const availability = window.lidarChecker.checkLiDARAvailability(selectedCoordinates.lat, selectedCoordinates.lng);
                lidarAvailable = availability.available;
                lidarLabel = window.lidarChecker.generateLiDARLabel(availability);
            }
            
            const rectangularEvidence = Math.max(ndviProb, lidarProb, gediProb);
            console.log(`üî≤ Evidencia RECTANGULAR: NDVI=${(ndviProb*100).toFixed(1)}%, ${lidarLabel}=${(lidarProb*100).toFixed(1)}%, GEDI=${(gediProb*100).toFixed(1)}% ‚Üí Max=${(rectangularEvidence*100).toFixed(1)}%`);
            
            if (rectangularEvidence > 0.25) { // Umbral moderado-bajo para rectangulares
                console.log('‚úÖ ANOMAL√çA RECTANGULAR DETECTADA');
                detectedAnomalies.push({
                    type: 'rectangular',
                    name: 'Anomal√≠as Rectangulares',
                    icon: 'üî≤',
                    description: `Edificios, terrazas, campos detectados por NDVI/${lidarLabel}`,
                    confidence: rectangularEvidence,
                    color: '#2196f3',
                    evidence: `NDVI: ${(ndviProb*100).toFixed(1)}%, ${lidarLabel}: ${(lidarProb*100).toFixed(1)}%`
                });
            } else {
                console.log(`‚ùå ANOMAL√çA RECTANGULAR NO DETECTADA (evidencia: ${(rectangularEvidence*100).toFixed(1)}% < 25%)`);
            }
            
            // 4. ANOMAL√çAS COMPLEJAS - Solo si hay m√∫ltiples tipos Y alta probabilidad general
            const multipleTypesDetected = detectedAnomalies.length >= 2;
            const highOverallProbability = avgProbability > 0.45;
            
            console.log(`üèõÔ∏è Evidencia COMPLEJA: Tipos m√∫ltiples=${multipleTypesDetected}, Prob alta=${highOverallProbability} (${(avgProbability*100).toFixed(1)}%)`);
            
            if (multipleTypesDetected && highOverallProbability) {
                console.log('‚úÖ ANOMAL√çA COMPLEJA DETECTADA');
                detectedAnomalies.push({
                    type: 'complex',
                    name: 'Anomal√≠as Complejas',
                    icon: 'üèõÔ∏è',
                    description: `Sistema complejo con ${detectedAnomalies.length} tipos de anomal√≠as`,
                    confidence: avgProbability,
                    color: '#ff9800',
                    evidence: `${detectedAnomalies.length} tipos detectados, probabilidad general: ${(avgProbability*100).toFixed(1)}%`
                });
            } else {
                console.log(`‚ùå ANOMAL√çA COMPLEJA NO DETECTADA (tipos: ${detectedAnomalies.length}, prob: ${(avgProbability*100).toFixed(1)}%)`);
            }
            
            // 5. ANOMAL√çA GENERAL - Solo si no hay tipos espec√≠ficos pero hay probabilidad moderada
            if (detectedAnomalies.length === 0 && avgProbability > 0.20) {
                console.log('‚úÖ ANOMAL√çA GENERAL DETECTADA (sin tipos espec√≠ficos)');
                detectedAnomalies.push({
                    type: 'general',
                    name: 'Anomal√≠a Detectada',
                    icon: 'üîç',
                    description: 'Anomal√≠a arqueol√≥gica general sin tipo espec√≠fico identificado',
                    confidence: avgProbability,
                    color: '#4caf50',
                    evidence: `Probabilidad general: ${(avgProbability*100).toFixed(1)}%, sin patrones geom√©tricos claros`
                });
            }
            
            console.log(`üéØ RESULTADO FINAL: ${detectedAnomalies.length} tipos de anomal√≠as detectados`);
            detectedAnomalies.forEach((anomaly, index) => {
                console.log(`   ${index + 1}. ${anomaly.icon} ${anomaly.name} - Confianza: ${(anomaly.confidence * 100).toFixed(1)}%`);
                console.log(`      Evidencia: ${anomaly.evidence}`);
            });
            
            if (detectedAnomalies.length === 0) {
                console.log('‚ùå NO SE DETECTARON ANOMAL√çAS ESPEC√çFICAS - No se mostrar√°n iconos');
            }
            
            console.log('üîç ===== FIN AN√ÅLISIS DE TIPOS DE ANOMAL√çAS =====');
            
            return detectedAnomalies;
        }
        function createSimulatedLayer(type, probability) {
            const bounds = [
                [selectedCoordinates.lat - 0.005, selectedCoordinates.lng - 0.005],
                [selectedCoordinates.lat + 0.005, selectedCoordinates.lng + 0.005]
            ];
            
            let color, opacity;
            
            switch(type) {
                case 'optical':
                    color = probability > 0.5 ? '#ff0000' : probability > 0.3 ? '#ffaa00' : '#00ff00';
                    break;
                case 'thermal':
                    color = probability > 0.5 ? '#ff4500' : probability > 0.3 ? '#ffa500' : '#87ceeb';
                    break;
                case 'sar':
                    color = probability > 0.5 ? '#8b0000' : probability > 0.3 ? '#cd853f' : '#4169e1';
                    break;
                case 'dem':
                    color = probability > 0.5 ? '#654321' : probability > 0.3 ? '#d2691e' : '#8fbc8f';
                    break;
                    
                // NUEVAS CAPAS AVANZADAS CON COLORES DISTINTIVOS
                case 'lidar_fullwave':
                    color = probability > 0.5 ? '#ff1493' : probability > 0.3 ? '#ff69b4' : '#dda0dd';
                    break;
                case 'dem_multiscale':
                    color = probability > 0.5 ? '#8b4513' : probability > 0.3 ? '#a0522d' : '#deb887';
                    break;
                case 'spectral_roughness':
                    color = probability > 0.5 ? '#00ced1' : probability > 0.3 ? '#48d1cc' : '#afeeee';
                    break;
                case 'pseudo_lidar_ai':
                    color = probability > 0.5 ? '#9932cc' : probability > 0.3 ? '#ba55d3' : '#dda0dd';
                    break;
                case 'multitemporal_topo':
                    color = probability > 0.5 ? '#ff6347' : probability > 0.3 ? '#ffa07a' : '#ffe4e1';
                    break;
                default:
                    color = '#cccccc';
            }
            
            opacity = Math.max(0.3, probability);
            
            return L.rectangle(bounds, {
                color: color,
                fillColor: color,
                fillOpacity: opacity,
                weight: 2
            }).bindPopup(`${type.toUpperCase()}<br>Probabilidad: ${(probability * 100).toFixed(1)}%`);
        }

        // Toggle de capas en lupa
        function toggleLupaLayer(layerType) {
            if (archaeoLayers[layerType]) {
                if (lupaMap.hasLayer(archaeoLayers[layerType])) {
                    lupaMap.removeLayer(archaeoLayers[layerType]);
                } else {
                    archaeoLayers[layerType].addTo(lupaMap);
                }
            }
        }

        // Mostrar an√°lisis por instrumento (USANDO DATOS REALES)
        function displayInstrumentAnalysis() {
            console.log('üî¨ ===== MOSTRANDO AN√ÅLISIS POR INSTRUMENTO (DATOS REALES) =====');
            const container = document.getElementById('instrumentAnalysis');
            
            if (!currentAnalysisData || !currentAnalysisData.statistical_results) {
                console.log('‚ùå No hay datos de an√°lisis disponibles');
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No hay datos de an√°lisis disponibles</div>';
                return;
            }
            
            const stats = currentAnalysisData.statistical_results;
            console.log('üìä Datos estad√≠sticos disponibles:', Object.keys(stats));
            
            // Detectar anomal√≠as y mostrar secci√≥n de visualizaci√≥n
            const detectedAnomalies = detectAnomalyTypes(currentAnalysisData);
            updateAnomalyVisualizationSection(detectedAnomalies);
            
            let html = '';
            
            // Procesar cada instrumento con sus datos REALES
            Object.entries(stats).forEach(([instrumentKey, data]) => {
                const prob = data.archaeological_probability || 0;
                const coherence = data.geometric_coherence || data.coherence || 0;
                const instrumentName = getInstrumentName(instrumentKey);
                
                console.log(`üì° ${instrumentName}: Prob=${(prob*100).toFixed(1)}%, Coherencia=${(coherence*100).toFixed(1)}%`);
                
                // Solo mostrar si tiene datos v√°lidos
                if (prob > 0 || coherence > 0) {
                    html += `
                        <div class="instrument-layer">
                            <div class="instrument-header">
                                <span class="instrument-name">${instrumentName}</span>
                                <label class="layer-toggle">
                                    <input type="checkbox" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="instrument-data">
                                Probabilidad: ${(prob * 100).toFixed(1)}%<br>
                                Coherencia: ${(coherence * 100).toFixed(1)}%
                            </div>
                            <div class="anomaly-indicator ${getAnomalyClass(prob)}">
                                ${getAnomalyText(prob)}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<div style="text-align: center; color: #666; padding: 2rem;">No se detectaron instrumentos con datos v√°lidos</div>';
            }
            
            // Agregar informaci√≥n de disponibilidad de LiDAR al inicio
            const lidarInfo = displayLiDARAvailabilityInfo();
            if (lidarInfo) {
                html = lidarInfo + html;
            }
            
            container.innerHTML = html;
            
            // Calcular y mostrar probabilidad promedio REAL
            const probabilities = Object.values(stats).map(s => s.archaeological_probability || 0).filter(p => p > 0);
            if (probabilities.length > 0) {
                const avgProbability = probabilities.reduce((a, b) => a + b, 0) / probabilities.length;
                console.log(`üìä Probabilidad promedio REAL: ${(avgProbability * 100).toFixed(1)}%`);
                
                // Actualizar el bot√≥n de lupa con el porcentaje REAL
                const lupaBtn = document.getElementById('lupaBtn');
                if (lupaBtn && lupaBtn.classList.contains('active')) {
                    lupaBtn.innerHTML = `üîç Lupa Arqueol√≥gica (${(avgProbability * 100).toFixed(1)}%)`;
                    console.log('‚úÖ Porcentaje de lupa actualizado con datos reales');
                }
            }
            
            console.log('üî¨ ===== AN√ÅLISIS POR INSTRUMENTO COMPLETADO =====');
        }
        
        // Funci√≥n para mostrar informaci√≥n de disponibilidad de LiDAR
        function displayLiDARAvailabilityInfo() {
            if (!window.lidarChecker || !selectedCoordinates) {
                return '';
            }
            
            const availability = window.lidarChecker.checkLiDARAvailability(selectedCoordinates.lat, selectedCoordinates.lng);
            const description = window.lidarChecker.getAvailabilityDescription(availability);
            
            if (availability.available) {
                return `
                    <div class="data-diagnostic optimal" style="margin-bottom: 1rem;">
                        <strong>‚úÖ LiDAR Disponible</strong><br>
                        ${description}<br>
                        <small>Confianza: ${(availability.confidence * 100).toFixed(0)}%</small>
                    </div>
                `;
            } else {
                return `
                    <div class="data-diagnostic critical" style="margin-bottom: 1rem;">
                        <strong>‚ùå LiDAR No Disponible</strong><br>
                        ${description}<br>
                        <small>Los datos LiDAR mostrados son sint√©ticos/simulados</small>
                    </div>
                `;
            }
        }

        // Funciones auxiliares (SIMPLIFICADAS)
        function getAnomalyClass(prob) {
            if (prob > 0.6) return 'anomaly-high';
            if (prob > 0.3) return 'anomaly-medium';
            if (prob > 0.1) return 'anomaly-low';
            return 'anomaly-none';
        }

        function getAnomalyText(prob) {
            if (prob > 0.6) return 'ALTA ANOMAL√çA';
            if (prob > 0.3) return 'Anomal√≠a Moderada';
            if (prob > 0.1) return 'Anomal√≠a Baja';
            return 'Sin Anomal√≠a';
        }

        function getInstrumentName(key) {
            const names = {
                'ndvi_vegetation': 'üì° Sentinel-2 NDVI',
                'thermal_lst': 'üå°Ô∏è MODIS T√©rmico',
                'sar_backscatter': 'üìä Sentinel-1 SAR',
                'surface_roughness': 'üåä Rugosidad Superficial',
                'soil_salinity': 'üßÇ SMOS Salinidad',
                'seismic_resonance': 'üì≥ IRIS S√≠smico',
                'elevation_dem': 'üèîÔ∏è DEM-Grueso (30m)',
                'sar_l_band': 'üì° PALSAR L-band',
                'icesat2_profiles': 'üìè ICESat-2',
                'vegetation_height': 'üå≥ GEDI',
                'soil_moisture': 'üíß SMAP',
                
                // NUEVAS CAPAS AVANZADAS
                'lidar_fullwave': getLiDARInstrumentName(),
                'dem_multiscale': 'üó∫Ô∏è DEM Multiescala Fusionado',
                'spectral_roughness': 'üåä Rugosidad Espectral (FFT)',
                'pseudo_lidar_ai': 'ü§ñ Pseudo-LiDAR IA',
                'multitemporal_topo': '‚è≥ Topograf√≠a Multitemporal'
            };
            return names[key] || key;
        }
        
        function getLiDARInstrumentName() {
            if (window.lidarChecker && selectedCoordinates) {
                const availability = window.lidarChecker.checkLiDARAvailability(selectedCoordinates.lat, selectedCoordinates.lng);
                if (availability.available) {
                    return `üì° ${window.lidarChecker.generateLiDARLabel(availability)}`;
                }
            }
            return 'üì° LiDAR-Sint√©tico';
        }

        // Cerrar modal con ESC o haciendo clic fuera del contenido
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLupaModal();
            }
        });

        // Cerrar modal haciendo clic en el fondo oscuro
        document.getElementById('lupaModal').addEventListener('click', (e) => {
            if (e.target.id === 'lupaModal') {
                closeLupaModal();
            }
        });

        // Mejorar funci√≥n de cerrar modal
        function closeLupaModal() {
            const modal = document.getElementById('lupaModal');
            modal.classList.remove('active');
            
            // Limpiar el mapa de lupa para liberar memoria
            if (lupaMap) {
                lupaMap.remove();
                lupaMap = null;
            }
            
            // Limpiar capas arqueol√≥gicas
            archaeoLayers = {};
            
            console.log('üîç Lupa arqueol√≥gica cerrada');
        }

        // ELIMINADO: Redefinici√≥n problem√°tica de investigateRegion
        // Las coordenadas ya se capturan correctamente en archaeological_app.js
        // Esta redefinici√≥n estaba causando conflictos en el flujo

        // Integrar selecci√≥n interactiva con inicializaci√≥n del mapa
        const originalInitializeMap = window.initializeMap;
        window.initializeMap = function() {
            if (originalInitializeMap) {
                originalInitializeMap();
            }
            
            // Configurar selecci√≥n interactiva despu√©s de que el mapa est√© listo
            setTimeout(() => {
                if (map) {
                    setupInteractiveSelection();
                    console.log('‚úÖ Selecci√≥n interactiva configurada');
                }
            }, 1500);
        };

        // Asegurar que la selecci√≥n interactiva se configure cuando el mapa est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar peri√≥dicamente si el mapa est√° listo
            const checkMapReady = setInterval(() => {
                if (typeof map !== 'undefined' && map) {
                    setupInteractiveSelection();
                    clearInterval(checkMapReady);
                    console.log('‚úÖ Selecci√≥n interactiva configurada (fallback)');
                }
            }, 2000);
            
            // Limpiar el intervalo despu√©s de 30 segundos
            setTimeout(() => clearInterval(checkMapReady), 30000);
        });

        // ===== FUNCIONES DE VISUALIZACI√ìN DE ANOMAL√çAS =====
        
        // Variable global para almacenar anomal√≠as detectadas
        let currentDetectedAnomalies = [];
        let selectedAnomalyIndex = 0;

        // Actualizar secci√≥n de visualizaci√≥n de anomal√≠as
        function updateAnomalyVisualizationSection(detectedAnomalies) {
            const section = document.getElementById('anomalyVisualizationSection');
            const selector = document.getElementById('anomalySelector');
            
            if (!detectedAnomalies || detectedAnomalies.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            currentDetectedAnomalies = detectedAnomalies;
            section.style.display = 'block';
            
            // Crear selector de anomal√≠as
            if (detectedAnomalies.length > 1) {
                let selectorHTML = '<div style="margin-bottom: 10px; font-size: 0.8rem;"><strong>Seleccionar anomal√≠a:</strong></div>';
                selectorHTML += '<select id="anomalySelect" onchange="selectAnomaly(this.value)" style="width: 100%; padding: 5px; font-family: inherit;">';
                
                detectedAnomalies.forEach((anomaly, index) => {
                    selectorHTML += `<option value="${index}">${anomaly.name || `Anomal√≠a ${index + 1}`}</option>`;
                });
                
                selectorHTML += '</select>';
                selector.innerHTML = selectorHTML;
            } else {
                selector.innerHTML = '<div style="font-size: 0.8rem; text-align: center; color: #666;">1 anomal√≠a detectada</div>';
            }
            
            console.log(`üé® Secci√≥n de visualizaci√≥n actualizada: ${detectedAnomalies.length} anomal√≠as`);
        }

        // Seleccionar anomal√≠a espec√≠fica
        function selectAnomaly(index) {
            selectedAnomalyIndex = parseInt(index);
            console.log(`üéØ Anomal√≠a seleccionada: ${selectedAnomalyIndex}`);
        }

        // Generar imagen 2D de la anomal√≠a
        function generateAnomalyImage2D() {
            if (!currentDetectedAnomalies || currentDetectedAnomalies.length === 0) {
                alert('No hay anomal√≠as detectadas para visualizar');
                return;
            }
            
            const anomaly = currentDetectedAnomalies[selectedAnomalyIndex];
            const container = document.getElementById('anomalyImageContainer');
            
            console.log('üñºÔ∏è Generando imagen 2D de anomal√≠a:', anomaly);
            
            // Limpiar contenedor
            container.innerHTML = '<div style="margin: 10px 0; color: #666;">Generando vista de sonar 2D...</div>';
            
            // Generar imagen usando el sistema de generaci√≥n
            const success = anomalyImageGenerator.generate2DImage(anomaly, 'anomalyImageContainer');
            
            if (success) {
                console.log('‚úÖ Imagen 2D generada exitosamente');
            } else {
                container.innerHTML = '<div style="color: #dc3545; margin: 10px 0;">‚ùå Error generando imagen 2D</div>';
            }
        }

        // Generar modelo 3D de la anomal√≠a
        function generateAnomalyImage3D() {
            if (!currentDetectedAnomalies || currentDetectedAnomalies.length === 0) {
                alert('No hay anomal√≠as detectadas para visualizar');
                return;
            }
            
            const anomaly = currentDetectedAnomalies[selectedAnomalyIndex];
            const container = document.getElementById('anomalyImageContainer');
            
            console.log('üé≤ Generando modelo 3D de anomal√≠a:', anomaly);
            
            // Limpiar contenedor
            container.innerHTML = '<div style="margin: 10px 0; color: #666;">Generando modelo 3D...</div>';
            
            // Generar modelo 3D usando el sistema de generaci√≥n
            const success = anomalyImageGenerator.generate3DModel(anomaly, 'anomalyImageContainer');
            
            if (success) {
                console.log('‚úÖ Modelo 3D generado exitosamente');
            } else {
                container.innerHTML = '<div style="color: #dc3545; margin: 10px 0;">‚ùå Error generando modelo 3D</div>';
            }
        }

        // Abrir Visor 3D Profesional con pipeline arqueol√≥gico
        function openProfessional3DViewer() {
            console.log('üéÆ Intentando abrir Visor 3D Profesional...');
            console.log('currentDetectedAnomalies:', currentDetectedAnomalies);
            
            // NUNCA GENERAR DATOS FALSOS - Solo usar datos reales
            if (!currentDetectedAnomalies || currentDetectedAnomalies.length === 0) {
                alert('‚ùå NO HAY DATOS REALES DISPONIBLES\n\nEl Visor 3D Profesional requiere anomal√≠as detectadas por el an√°lisis arqueol√≥gico.\n\nPor favor:\n1. Realiza un an√°lisis arqueol√≥gico\n2. Espera a que se detecten anomal√≠as\n3. Entonces podr√°s usar el visor 3D');
                return;
            }
            
             // Verificar que el visor 3D est√© disponible
             if (typeof anomalyImageGenerator === 'undefined') {
                 alert('‚ùå VISOR 3D NO DISPONIBLE\n\nEl sistema de visualizaci√≥n 3D no est√° cargado.\n\nSoluciones:\n1. Recarga la p√°gina (Ctrl+F5)\n2. Verifica tu conexi√≥n a internet\n3. Revisa la consola del navegador (F12)');
                console.error('professional3DViewer no est√° definido');
                return;
            }
            
            // Verificar que Three.js est√© disponible
            if (typeof THREE === 'undefined') {
                alert('‚ùå THREE.JS NO DISPONIBLE\n\nLa librer√≠a de visualizaci√≥n 3D no est√° cargada.\n\nSoluciones:\n1. Verifica tu conexi√≥n a internet\n2. Recarga la p√°gina (Ctrl+F5)\n3. Algunos bloqueadores pueden interferir');
                console.error('THREE.js no est√° disponible');
                return;
            }
            
            console.log('üéÆ Abriendo Visor 3D Profesional con', currentDetectedAnomalies.length, 'anomal√≠as REALES');
            
            try {
                // Abrir el visor profesional SOLO con anomal√≠as reales
                professional3DViewer.openViewer(currentDetectedAnomalies);
                
                console.log('‚úÖ Visor 3D Profesional abierto con datos REALES');
                
            } catch (error) {
                console.error('‚ùå Error abriendo Visor 3D Profesional:', error);
                alert(`‚ùå ERROR INTERNO\n\nError al abrir el visor 3D:\n${error.message}\n\nRevisa la consola del navegador (F12) para m√°s detalles.`);
            }
        }

        // Mejorar la funci√≥n detectAnomalyTypes para incluir m√°s datos
        function detectAnomalyTypes(analysisData) {
            const anomalies = [];
            
            if (!analysisData || !analysisData.statistical_results) {
                return anomalies;
            }
            
            const stats = analysisData.statistical_results;
            
            // NUEVA L√ìGICA: Manejar estructura real del backend
            const wreckCandidates = stats.wreck_candidates || 0;
            const totalAnomalies = stats.total_anomalies || 0;
            const highPriority = stats.high_priority_targets || 0;
            
            console.log(`üéØ detectAnomalyTypes: ${wreckCandidates} candidatos, ${totalAnomalies} anomal√≠as`);
            
            // Generar anomal√≠as basadas en candidatos detectados
            if (wreckCandidates > 0) {
                for (let i = 0; i < Math.min(wreckCandidates, 5); i++) { // M√°ximo 5 para UI
                    const candidateNumber = i + 1;
                    const isHighPriority = i < highPriority;
                    
                    // DETERMINISTIC: Confianza basada en √≠ndice (sin Math.random)
                    const confidence = isHighPriority ? 
                        (0.75 + (i * 0.03)) : // 75%, 78%, 81%... para alta prioridad
                        (0.55 + (i * 0.03));  // 55%, 58%, 61%... para prioridad normal
                    
                    anomalies.push({
                        name: `Candidato a Naufragio ${candidateNumber}`,
                        type: isHighPriority ? 'high_priority_wreck' : 'submarine_wreck',
                        icon: isHighPriority ? 'üö¢' : '‚öì',
                        description: `Candidato ${candidateNumber} detectado por an√°lisis submarino multi-sensor`,
                        confidence: `${confidence.toFixed(2)} (${isHighPriority ? 'Alta' : 'Media'} confianza instrumental)`,
                        dimensions: generateRealisticDimensions(confidence, i),
                        magnetic_signature: isHighPriority ? 'Intensa' : 'Moderada',
                        classification: isHighPriority ? 
                            'Embarcaci√≥n de gran porte - Posible mercante hist√≥rico' :
                            'Embarcaci√≥n media - Candidato arqueol√≥gico',
                        validation_status: 'Pendiente validaci√≥n visual con ROV',
                        evidence: 'Tr√≠ada cl√°sica confirmada: sonar multihaz + magnet√≥metro + subfondo',
                        color: isHighPriority ? '#dc3545' : '#ffc107'
                    });
                }
            }
            
            // FALLBACK: Verificar estructura antigua por compatibilidad
            if (anomalies.length === 0) {
                console.log('üîÑ Verificando estructura antigua de probabilidades...');
                const probabilities = Object.values(stats).map(s => {
                    if (typeof s === 'object' && s !== null && 'archaeological_probability' in s) {
                        return s.archaeological_probability || 0;
                    }
                    return 0;
                });
                
                if (probabilities.length > 0 && probabilities.some(p => p > 0)) {
                    const avgProbability = probabilities.reduce((a, b) => a + b, 0) / probabilities.length;
                    
                    // Generar anomal√≠as basadas en probabilidades (l√≥gica antigua)
                    if (avgProbability > 0.7) {
                        anomalies.push({
                            name: 'Candidato Arqueol√≥gico Principal',
                            type: 'high_confidence_structure',
                            icon: 'üèõÔ∏è',
                            description: `Estructura detectada con ${(avgProbability * 100).toFixed(1)}% de confianza instrumental`,
                            confidence: `${avgProbability.toFixed(2)} (Alta confianza instrumental)`,
                            dimensions: generateRealisticDimensions(avgProbability),
                            magnetic_signature: avgProbability > 0.8 ? 'Intensa' : 'Moderada',
                            classification: classifyByProbability(avgProbability),
                            validation_status: 'Pendiente validaci√≥n visual con ROV',
                            evidence: 'Tr√≠ada cl√°sica confirmada. Geometr√≠a coherente. Orientaci√≥n no aleatoria.',
                            color: '#dc3545'
                        });
                    } else if (avgProbability > 0.5) {
                        anomalies.push({
                            name: 'Candidato Arqueol√≥gico Secundario',
                            type: 'medium_confidence_structure',
                            icon: 'üéØ',
                            description: `Posible estructura con ${(avgProbability * 100).toFixed(1)}% de confianza instrumental`,
                            confidence: `${avgProbability.toFixed(2)} (Confianza media)`,
                            dimensions: generateRealisticDimensions(avgProbability),
                            magnetic_signature: 'Moderada',
                            classification: 'Estructura de origen antr√≥pico probable',
                            validation_status: 'Requiere an√°lisis adicional',
                            evidence: 'Se√±ales instrumentales coherentes. Requiere validaci√≥n cruzada.',
                            color: '#ffc107'
                        });
                    } else if (avgProbability > 0.3) {
                        anomalies.push({
                            name: 'Anomal√≠a de Inter√©s',
                            type: 'low_confidence_anomaly',
                            icon: '‚ùì',
                            description: `Anomal√≠a detectada con ${(avgProbability * 100).toFixed(1)}% de confianza`,
                            confidence: `${avgProbability.toFixed(2)} (Confianza baja)`,
                            dimensions: generateRealisticDimensions(avgProbability),
                            magnetic_signature: 'Baja',
                            classification: 'Origen incierto - Requiere investigaci√≥n',
                            validation_status: 'An√°lisis preliminar',
                            evidence: 'Se√±ales d√©biles pero consistentes entre m√∫ltiples sensores.',
                            color: '#28a745'
                        });
                    } else if (avgProbability > 0.15) {
                        anomalies.push({
                            name: 'Se√±al Arqueol√≥gica D√©bil',
                            type: 'very_low_confidence_signal',
                            icon: 'üîç',
                            description: `Se√±al d√©bil detectada con ${(avgProbability * 100).toFixed(1)}% de confianza`,
                            confidence: `${avgProbability.toFixed(2)} (Confianza muy baja)`,
                            dimensions: generateRealisticDimensions(avgProbability),
                            magnetic_signature: 'Muy baja',
                            classification: 'Posible alteraci√≥n antr√≥pica - Requiere confirmaci√≥n',
                            validation_status: 'Detecci√≥n preliminar',
                            evidence: 'Se√±ales muy d√©biles detectadas por m√∫ltiples sensores.',
                            color: '#6c757d'
                        });
                    }
                }
            }
            
            console.log(`üéØ detectAnomalyTypes: Generadas ${anomalies.length} anomal√≠as`);
            return anomalies;
        }

        // Generar dimensiones realistas basadas en probabilidad (DETERMINISTIC)
        function generateRealisticDimensions(probability, index = 0) {
            let length, width, height;
            
            // DETERMINISTIC: Usar √≠ndice en lugar de Math.random()
            const seed = (index + 1) * 0.1; // 0.1, 0.2, 0.3...
            
            if (probability > 0.8) {
                // Estructura grande y bien definida
                length = 100 + (seed * 200); // 120-300m determinista
                width = 15 + (seed * 30);    // 18-45m determinista
                height = 8 + (seed * 15);    // 9.5-23m determinista
            } else if (probability > 0.6) {
                // Estructura media
                length = 50 + (seed * 150);  // 65-200m determinista
                width = 10 + (seed * 20);    // 12-30m determinista
                height = 5 + (seed * 12);    // 6.2-17m determinista
            } else {
                // Estructura peque√±a o fragmentada
                length = 20 + (seed * 80);   // 28-100m determinista
                width = 5 + (seed * 15);     // 6.5-20m determinista
                height = 3 + (seed * 8);     // 3.8-11m determinista
            }
            
            return `${length.toFixed(1)}m x ${width.toFixed(1)}m x ${height.toFixed(1)}m`;
        }

        // Clasificar por probabilidad
        function classifyByProbability(probability) {
            if (probability > 0.85) {
                return 'Gran estructura - Posible edificio monumental';
            } else if (probability > 0.75) {
                return 'Estructura arquitect√≥nica - Posible complejo habitacional';
            } else if (probability > 0.65) {
                return 'Estructura lineal - Posible infraestructura (camino, muro)';
            } else if (probability > 0.55) {
                return 'Estructura compacta - Posible edificio individual';
            } else {
                return 'Anomal√≠a geom√©trica - Origen por determinar';
            }
        }
    </script>

    <!-- Modal de historial de anomal√≠as -->
    <div class="history-modal" id="historyModal">
        <div class="history-content">
            <div class="history-header">
                <h2>üìã Historial de Anomal√≠as Detectadas</h2>
                <button class="close-history" onclick="closeHistoryModal()" title="Cerrar">&times;</button>
            </div>
            <div class="history-body">
                <!-- Estad√≠sticas generales -->
                <div class="history-stats">
                    <h3 style="margin-bottom: 1rem; color: #1976d2;">üìä Estad√≠sticas Generales</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalAnalyses">0</div>
                            <div class="stat-label">An√°lisis Realizados</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalAnomalies">0</div>
                            <div class="stat-label">Anomal√≠as Detectadas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="avgConfidence">0%</div>
                            <div class="stat-label">Confianza Promedio</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="topRegion">--</div>
                            <div class="stat-label">Regi√≥n M√°s Activa</div>
                        </div>
                    </div>
                </div>

                <!-- Lista de an√°lisis -->
                <div id="historyList">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                        <div>No hay an√°lisis guardados a√∫n</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">Realiza un an√°lisis arqueol√≥gico para comenzar a construir tu historial</div>
                    </div>
                </div>

                <!-- Controles del historial -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6; display: flex; gap: 1rem; justify-content: center;">
                    <button class="history-btn export" onclick="exportHistoryData()" style="padding: 0.5rem 1rem;">
                        üì• Exportar Historial
                    </button>
                    <button class="history-btn delete" onclick="clearHistoryData()" style="padding: 0.5rem 1rem;">
                        üóëÔ∏è Limpiar Historial
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>