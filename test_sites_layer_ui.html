<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sites Layer UI</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 80px);
            gap: 1rem;
            padding: 1rem;
        }
        
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .map-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #ffc107;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .stats {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .stats-value {
            font-weight: 600;
            color: #8B4513;
        }
        
        .log {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 0.25rem;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Test Sites Layer UI</h1>
        <p>Prueba de integraci√≥n de capa de sitios arqueol√≥gicos</p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <h3 style="margin-bottom: 1rem; color: #8B4513;">üõ∞Ô∏è Controles</h3>
            
            <button class="btn btn-primary" onclick="loadKnownSites()">
                üìç Cargar Sitios Conocidos
            </button>
            
            <button class="btn btn-secondary" onclick="loadCandidates()">
                üîç Cargar Candidatos
            </button>
            
            <button class="btn btn-danger" onclick="clearMap()">
                üóëÔ∏è Limpiar Mapa
            </button>
            
            <div class="stats" id="stats">
                <div class="stats-item">
                    <span>Sitios cargados:</span>
                    <span class="stats-value" id="sitesCount">0</span>
                </div>
                <div class="stats-item">
                    <span>Candidatos:</span>
                    <span class="stats-value" id="candidatesCount">0</span>
                </div>
                <div class="stats-item">
                    <span>Total en mapa:</span>
                    <span class="stats-value" id="totalCount">0</span>
                </div>
            </div>
            
            <div class="log" id="log">
                <div class="log-entry log-info">üìã Log de eventos...</div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:8002';
        
        let map = null;
        let sitesLayer = null;
        let candidatesLayer = null;
        let sitesCount = 0;
        let candidatesCount = 0;
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            sitesLayer = L.layerGroup().addTo(map);
            candidatesLayer = L.layerGroup().addTo(map);
            
            log('‚úÖ Mapa inicializado', 'success');
        }
        
        // Cargar sitios conocidos
        async function loadKnownSites() {
            log('üîç Cargando sitios conocidos...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/scientific/sites/layer?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const geojson = await response.json();
                
                log(`‚úÖ ${geojson.metadata.total} sitios cargados`, 'success');
                
                // Limpiar capa anterior
                sitesLayer.clearLayers();
                sitesCount = 0;
                
                // Agregar marcadores
                geojson.features.forEach(feature => {
                    const props = feature.properties;
                    const coords = feature.geometry.coordinates; // [lon, lat]
                    
                    // Color seg√∫n confianza
                    let color = '#28a745'; // Verde (HIGH)
                    if (props.confidenceLevel === 'MODERATE') color = '#ffc107'; // Amarillo
                    else if (props.confidenceLevel === 'LOW') color = '#dc3545'; // Rojo
                    else if (props.confidenceLevel === 'CANDIDATE') color = '#ff6b6b'; // Naranja
                    
                    const marker = L.circleMarker([coords[1], coords[0]], {
                        radius: 6,
                        fillColor: color,
                        color: 'white',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    marker.bindPopup(`
                        <strong>${props.name}</strong><br>
                        Pa√≠s: ${props.country}<br>
                        Tipo: ${props.siteType}<br>
                        Confianza: <span style="color: ${color}; font-weight: bold;">${props.confidenceLevel}</span>
                    `);
                    
                    marker.addTo(sitesLayer);
                    sitesCount++;
                });
                
                updateStats();
                
                // Zoom a los sitios
                if (geojson.features.length > 0) {
                    const bounds = L.geoJSON(geojson).getBounds();
                    map.fitBounds(bounds);
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Cargar candidatos
        async function loadCandidates() {
            log('üîç Cargando candidatos...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/scientific/sites/candidates?limit=100`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                log(`‚úÖ ${data.total} candidatos cargados`, 'success');
                
                // Limpiar capa anterior
                candidatesLayer.clearLayers();
                candidatesCount = 0;
                
                // Agregar marcadores
                data.candidates.forEach(candidate => {
                    const marker = L.circleMarker([candidate.latitude, candidate.longitude], {
                        radius: 8,
                        fillColor: '#ff6b6b',
                        color: 'white',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    });
                    
                    const metrics = candidate.metrics;
                    
                    marker.bindPopup(`
                        <strong style="color: #ff6b6b;">üîç CANDIDATO</strong><br>
                        ${candidate.name}<br>
                        <hr style="margin: 0.5rem 0;">
                        <strong>M√©tricas:</strong><br>
                        Origen: ${(metrics.origin * 100).toFixed(0)}%<br>
                        Actividad: ${(metrics.activity * 100).toFixed(0)}%<br>
                        Anomal√≠a: ${(metrics.anomaly * 100).toFixed(0)}%<br>
                        ESS: <strong>${metrics.ess.toUpperCase()}</strong>
                    `);
                    
                    marker.addTo(candidatesLayer);
                    candidatesCount++;
                });
                
                updateStats();
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Limpiar mapa
        function clearMap() {
            sitesLayer.clearLayers();
            candidatesLayer.clearLayers();
            sitesCount = 0;
            candidatesCount = 0;
            updateStats();
            log('üóëÔ∏è Mapa limpiado', 'info');
        }
        
        // Actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('sitesCount').textContent = sitesCount;
            document.getElementById('candidatesCount').textContent = candidatesCount;
            document.getElementById('totalCount').textContent = sitesCount + candidatesCount;
        }
        
        // Log de eventos
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Inicializar al cargar
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
        });
    </script>
</body>
</html>
