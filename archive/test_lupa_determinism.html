<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Lupa Determinismo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .test-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #1e4620;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #4a1e1e;
            border-left: 4px solid #f44336;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1976D2;
        }
        h1 { color: #4caf50; }
        h2 { color: #2196F3; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4caf50;
        }
        .stat-label {
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üî¨ Test de Determinismo - Lupa Arqueol√≥gica</h1>
    
    <div class="test-section">
        <h2>üìã Descripci√≥n del Test</h2>
        <p>Este test verifica que la funci√≥n <code>detectAnomalyTypes()</code> produce resultados id√©nticos cuando se le pasan los mismos datos de entrada.</p>
        <p><strong>Regla cr√≠tica:</strong> Mismo input ‚Üí Mismo output (sin Math.random)</p>
    </div>

    <div class="test-section">
        <h2>üéÆ Controles</h2>
        <button onclick="runSingleTest()">‚ñ∂Ô∏è Ejecutar Test Simple</button>
        <button onclick="runMultipleTests()">üîÑ Ejecutar 10 Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
    </div>

    <div class="test-section">
        <h2>üìä Estad√≠sticas</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Tests Ejecutados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successTests">0</div>
                <div class="stat-label">Tests Exitosos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Tests Fallidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Tasa de √âxito</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìù Resultados</h2>
        <div id="results"></div>
    </div>

    <script>
        let totalTests = 0;
        let successTests = 0;
        let failedTests = 0;
        let firstResult = null;

        // Funci√≥n copiada de index.html (VERSI√ìN CORREGIDA)
        function detectAnomalyTypes(analysisData) {
            const anomalies = [];
            
            if (!analysisData || !analysisData.statistical_results) {
                return anomalies;
            }
            
            const stats = analysisData.statistical_results;
            
            const wreckCandidates = stats.wreck_candidates || 0;
            const totalAnomalies = stats.total_anomalies || 0;
            const highPriority = stats.high_priority_targets || 0;
            
            console.log(`üéØ detectAnomalyTypes: ${wreckCandidates} candidatos, ${totalAnomalies} anomal√≠as`);
            
            // Generar anomal√≠as basadas en candidatos detectados
            if (wreckCandidates > 0) {
                for (let i = 0; i < Math.min(wreckCandidates, 5); i++) {
                    const candidateNumber = i + 1;
                    const isHighPriority = i < highPriority;
                    
                    // DETERMINISTIC: Confianza basada en √≠ndice (sin Math.random)
                    const confidence = isHighPriority ? 
                        (0.75 + (i * 0.03)) : // 75%, 78%, 81%... para alta prioridad
                        (0.55 + (i * 0.03));  // 55%, 58%, 61%... para prioridad normal
                    
                    anomalies.push({
                        name: `Candidato a Naufragio ${candidateNumber}`,
                        type: isHighPriority ? 'high_priority_wreck' : 'submarine_wreck',
                        icon: isHighPriority ? 'üö¢' : '‚öì',
                        description: `Candidato ${candidateNumber} detectado por an√°lisis submarino multi-sensor`,
                        confidence: `${confidence.toFixed(2)} (${isHighPriority ? 'Alta' : 'Media'} confianza instrumental)`,
                        dimensions: generateRealisticDimensions(confidence, i),
                        magnetic_signature: isHighPriority ? 'Intensa' : 'Moderada',
                        classification: isHighPriority ? 
                            'Embarcaci√≥n de gran porte - Posible mercante hist√≥rico' :
                            'Embarcaci√≥n media - Candidato arqueol√≥gico',
                        validation_status: 'Pendiente validaci√≥n visual con ROV',
                        evidence: 'Tr√≠ada cl√°sica confirmada: sonar multihaz + magnet√≥metro + subfondo',
                        color: isHighPriority ? '#dc3545' : '#ffc107'
                    });
                }
            }
            
            console.log(`üéØ detectAnomalyTypes: Generadas ${anomalies.length} anomal√≠as`);
            return anomalies;
        }

        function generateRealisticDimensions(probability, index = 0) {
            let length, width, height;
            
            // DETERMINISTIC: Usar √≠ndice en lugar de Math.random()
            const seed = (index + 1) * 0.1;
            
            if (probability > 0.8) {
                length = 100 + (seed * 200);
                width = 15 + (seed * 30);
                height = 8 + (seed * 15);
            } else if (probability > 0.6) {
                length = 50 + (seed * 150);
                width = 10 + (seed * 20);
                height = 5 + (seed * 12);
            } else {
                length = 20 + (seed * 80);
                width = 5 + (seed * 15);
                height = 3 + (seed * 8);
            }
            
            return `${length.toFixed(1)}m x ${width.toFixed(1)}m x ${height.toFixed(1)}m`;
        }

        // Datos de prueba (simulando respuesta del backend)
        const testData = {
            statistical_results: {
                wreck_candidates: 2,
                total_anomalies: 2,
                high_priority_targets: 2
            }
        };

        function runSingleTest() {
            const result = detectAnomalyTypes(testData);
            const resultStr = JSON.stringify(result, null, 2);
            
            totalTests++;
            
            if (firstResult === null) {
                firstResult = resultStr;
                successTests++;
                addResult(`‚úÖ Test #${totalTests}: Primera ejecuci√≥n - ${result.length} anomal√≠as detectadas`, 'success');
            } else {
                if (resultStr === firstResult) {
                    successTests++;
                    addResult(`‚úÖ Test #${totalTests}: ID√âNTICO al primero - ${result.length} anomal√≠as`, 'success');
                } else {
                    failedTests++;
                    addResult(`‚ùå Test #${totalTests}: DIFERENTE al primero - ${result.length} anomal√≠as`, 'error');
                    console.error('Diferencia detectada:', {
                        first: JSON.parse(firstResult),
                        current: result
                    });
                }
            }
            
            updateStats();
        }

        function runMultipleTests() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => runSingleTest(), i * 100);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            totalTests = 0;
            successTests = 0;
            failedTests = 0;
            firstResult = null;
            updateStats();
        }

        function addResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.insertBefore(resultDiv, resultsDiv.firstChild);
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('successTests').textContent = successTests;
            document.getElementById('failedTests').textContent = failedTests;
            
            const rate = totalTests > 0 ? ((successTests / totalTests) * 100).toFixed(1) : 0;
            document.getElementById('successRate').textContent = rate + '%';
        }

        // Ejecutar test autom√°tico al cargar
        window.onload = function() {
            addResult('üé¨ Sistema de test cargado. Presiona "Ejecutar Test Simple" para comenzar.', 'success');
        };
    </script>
</body>
</html>
